<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Kafe & Restoran</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #c19a6b; /* Warna Kopi */
            --primary-light: #f5f0e9;
            --secondary: #8d6e63; /* Coklat Tua */
            --success: #66bb6a; /* Hijau */
            --danger: #ef5350; /* Merah */
            --warning: #ffa726; /* Oranye */
            --info: #29b6f6; /* Biru */
            --light: #fafafa;
            --dark: #37474f;
            --gray: #90a4ae;
            --white: #ffffff;
            --shadow-sm: 0 0.15rem 0.35rem rgba(0,0,0,0.1);
            --shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            --rounded-sm: 0.35rem;
            --rounded: 0.75rem;
            --rounded-lg: 1rem;
            --premium-dark: #2c251e;
            --premium-primary: #a17a4a;
            --premium-gradient: linear-gradient(135deg, var(--premium-primary), var(--secondary));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f8f5f1;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 12px;
        }

        .app-header {
            background: var(--premium-gradient);
            color: var(--white);
            padding: 12px 16px;
            border-radius: var(--rounded);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .header-info p { margin: 2px 0; }
        .copyright-notice { font-size: 0.7rem; opacity: 0.8; margin-top: 4px; }

        .app-content { display: flex; flex-direction: column; gap: 16px; }
        @media (min-width: 768px) {
            .app-content { flex-direction: row; }
            .products-panel { flex: 2; }
            .cart-panel { flex: 1; }
        }

        .panel { background: var(--white); border-radius: var(--rounded); padding: 16px; box-shadow: var(--shadow-sm); }
        .panel-title { font-size: 1.2rem; margin-bottom: 12px; color: var(--dark); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .product-card { background: var(--white); border-radius: var(--rounded-sm); padding: 12px; box-shadow: var(--shadow-sm); transition: all 0.2s; border: 1px solid #eee; cursor: pointer; position: relative; }
        .product-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .product-name { font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { color: var(--primary); font-weight: 600; margin-bottom: 4px; }
        .product-cost { color: var(--danger); font-weight: 500; font-size: 0.8rem; margin-bottom: 4px; display: none; }
        .admin-view .product-cost { display: block; }
        .product-stock { font-size: 0.8rem; color: var(--gray); }
        .product-stock.low { color: var(--danger); }
        .product-barcode { font-size: 0.75rem; color: var(--secondary); margin-top: 4px; font-weight: 500;}

        .search-container { position: relative; margin-bottom: 16px; }
        .search-container i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--gray); }
        .search-input { width: 100%; padding: 12px 16px 12px 40px; border: 1px solid #ddd; border-radius: var(--rounded-sm); font-size: 1rem; }
        .filter-row { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .filter-chip { padding: 8px 12px; background: var(--light); border-radius: 20px; font-size: 0.9rem; white-space: nowrap; cursor: pointer; }
        .filter-chip.active { background: var(--primary); color: var(--white); }

        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 500; }
        .cart-item-price { color: var(--gray); font-size: 0.9rem; }
        .cart-item-qty { display: flex; align-items: center; }
        .qty-btn { width: 32px; height: 32px; border: 1px solid #ddd; background: var(--light); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-input { width: 40px; text-align: center; margin: 0 4px; border: 1px solid #ddd; border-radius: 4px; padding: 6px; }
        .remove-btn { color: var(--danger); margin-left: 8px; cursor: pointer; }

        .summary-container { margin-top: 16px; padding-top: 16px; border-top: 1px dashed #ddd; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .total-row { font-weight: 600; font-size: 1.1rem; color: var(--primary); margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd; }

        .btn { display: inline-block; padding: 12px 20px; background-color: var(--primary); color: var(--white); border: none; border-radius: var(--rounded-sm); cursor: pointer; font-size: 1rem; font-weight: 500; text-align: center; transition: all 0.2s; width: 100%; }
        .btn:hover { background-color: var(--secondary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background-color: var(--gray); cursor: not-allowed; }
        .btn-sm { padding: 8px 12px; font-size: 0.9rem; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #55a85a; }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #d64a47; }
        .btn-warning { background-color: var(--warning); color: #000; }
        .btn-warning:hover { background-color: #e69a23; }
        .btn-info { background-color: var(--info); }
        .btn-info:hover { background-color: #26a3dc; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--white); border-radius: var(--rounded-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); animation: fadeIn 0.3s; }
        .modal-header { padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
        .modal-body { padding: 16px; }
        .modal-footer { padding: 16px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 8px; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--rounded-sm); font-size: 1rem; }
        textarea.form-control { min-height: 100px; resize: vertical; }

        .login-container { max-width: 400px; margin: 20px auto; background: var(--white); border-radius: var(--rounded-lg); padding: 24px; box-shadow: var(--shadow); }
        .login-header { text-align: center; margin-bottom: 24px; }
        .login-logo { font-size: 3rem; color: var(--primary); margin-bottom: 12px; }
        .login-title { font-size: 1.8rem; color: var(--primary); font-weight: 600; }

        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; background-color: var(--dark); color: var(--white); border-radius: var(--rounded-sm); box-shadow: var(--shadow); z-index: 1100; display: flex; align-items: center; transform: translateX(200%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast.warning { background-color: var(--warning); color: #000; }
        .toast i { margin-right: 8px; }

        .empty-state { text-align: center; padding: 24px; color: var(--gray); }
        .empty-state i { font-size: 3rem; color: #ddd; margin-bottom: 12px; }

        .admin-panel { display: none; margin-top: 16px; padding: 16px; background-color: var(--light); border-radius: var(--rounded); }
        .admin-password-modal { max-width: 400px; padding: 24px; background: var(--white); border-radius: var(--rounded-lg); box-shadow: var(--shadow); }
        
        .product-actions { position: absolute; top: 8px; right: 8px; display: none; gap: 4px; }
        .product-card:hover .product-actions { display: flex; }
        .action-btn { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.7rem; color: white; }
        .edit-btn { background-color: var(--info); }
        .delete-btn { background-color: var(--danger); }

        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background-color: var(--light); font-weight: 600; }
        .data-table tr:hover { background-color: #f9f9f9; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 16px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-2 { gap: 8px; }
        
        .app-footer { text-align: center; margin-top: 20px; padding: 10px; color: var(--gray); font-size: 0.8rem; }
        
        .discount-container, .additional-cost-container { display: none; }
        .admin-view .discount-container, .admin-view .additional-cost-container { display: block; }

        .profit-report-btn { display: none; }
        .admin-view .profit-report-btn { display: inline-block; }
        
        .receipt { font-family: 'Courier New', Courier, monospace; max-width: 300px; margin: 0 auto; padding: 15px; border: 1px solid #ddd; }
        .receipt-header { text-align: center; margin-bottom: 15px; }
        .receipt-header h3 { margin: 0; font-size: 16px; font-weight: bold; }
        .receipt-header p { margin: 5px 0; font-size: 12px; }
        .receipt-body { font-size: 12px; }
        .receipt-body hr { border: none; border-top: 1px dashed #ddd; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .receipt-item.total-row { font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
        .receipt-footer { text-align: center; margin-top: 15px; font-size: 12px; }

        .role-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 500; margin-left: 6px; }
        .role-admin { background-color: var(--danger); color: white; }
        .role-cashier { background-color: var(--info); color: white; }
        .role-assistant { background-color: var(--success); color: white; }

        .memo-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; max-width: 300px; }
        .memo-card { background-color: var(--warning); color: #000; border-radius: var(--rounded-sm); padding: 12px; box-shadow: var(--shadow); margin-bottom: 10px; position: relative; }
        .memo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .memo-title { font-weight: 600; }
        .memo-close { background: none; border: none; cursor: pointer; color: #000; }
        .memo-content { font-size: 0.9rem; }
        .memo-date { font-size: 0.7rem; text-align: right; margin-top: 8px; color: rgba(0, 0, 0, 0.7); }

        .data-management-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .reset-warning { color: var(--danger); font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Pesan notifikasi</span>
    </div>

    <div id="memoContainer" class="memo-container"></div>

    <div id="loginModal" class="modal" style="display: block;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo"><i class="fas fa-utensils"></i></div>
                <h1 class="login-title">SISTEM KASIR KAFE</h1>
                <p>Silakan login untuk memulai</p> 
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn mt-3">Login</button>
            </form>
            <p class="text-center mt-3" style="font-size: 0.9rem;">
                <a href="#" id="resetLoginLink">Tidak bisa login? Reset Akun Default</a>
            </p>
        </div>
    </div>

    <div id="adminPasswordModal" class="modal">
        <div class="admin-password-modal">
            <div class="login-header">
                <h3 class="login-title">Verifikasi Admin</h3>
                <p>Masukkan password admin untuk mengakses fitur ini</p>
            </div>
            <form id="adminPasswordForm">
                <div class="form-group">
                    <label for="adminPassword" class="form-label">Password Admin</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Masukkan password admin" required>
                </div>
                <button type="submit" class="btn mt-3">Verifikasi</button>
                <button type="button" id="cancelAdminPassword" class="btn btn-warning mt-2">Batal</button>
            </form>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div>
                <h1 class="app-title" id="storeNameHeader">SISTEM KASIR KAFE & RESTO</h1>
                <p id="currentDate">Senin, 1 Januari 2025</p>
                <p class="copyright-notice">Â© 2025 Lentera Karya Situbondo. All Rights Reserved.</p>
            </div>
            <div class="header-info">
                <p>Kasir: <span id="loggedInUser">Admin</span> <span id="userRoleBadge" class="role-badge role-admin">Admin</span></p>
                <p><a href="#" id="logoutBtn" style="color: white;">Logout</a></p>
            </div>
        </header>

        <main class="app-content">
            <section class="panel products-panel">
                <h2 class="panel-title">
                    <span>Daftar Menu</span>
                    <span id="productCount">(0 menu)</span>
                </h2>
                
                <div class="d-flex gap-2 mb-3">
                    <div class="search-container" style="flex: 2;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearch" class="search-input" placeholder="Cari menu...">
                    </div>
                    <div class="search-container" style="flex: 1;">
                        <i class="fas fa-barcode"></i>
                        <input type="text" id="barcodeSearch" class="search-input" placeholder="Scan Kode Menu...">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-chip active" data-category="all">Semua</div>
                </div>
                
                <div class="product-grid" id="productGrid"></div>

                <div id="adminPanel" class="admin-panel">
                    <h3 class="panel-title">Panel Admin</h3>
                    <button id="addProductBtn" class="btn btn-sm mb-2">Tambah Menu</button>
                    <button id="manageCategoriesBtn" class="btn btn-sm mb-2">Kelola Kategori</button>
                    <button id="manageCashiersBtn" class="btn btn-sm mb-2">Kelola Staf</button>
                    <button id="manageMembersBtn" class="btn btn-sm mb-2">Kelola Member</button>
                    <button id="manageRolesBtn" class="btn btn-sm mb-2">Kelola Role</button>
                    <button id="viewReportsBtn" class="btn btn-sm mb-2">Laporan Penjualan</button>
                    <button id="profitReportBtn" class="btn btn-sm mb-2 profit-report-btn">Laporan Laba Rugi</button>
                    <button id="manageStoreInfoBtn" class="btn btn-sm">Kelola Info Resto</button>
                    <button id="manageMemosBtn" class="btn btn-sm mt-2">Kelola Memo</button>
                    
                    <div class="data-management-buttons">
                        <button id="backupDataBtn" class="btn btn-sm btn-info">Backup Data</button>
                        <button id="restoreDataBtn" class="btn btn-sm btn-warning">Restore Data</button>
                        <button id="resetDataBtn" class="btn btn-sm btn-danger">Reset Data</button>
                    </div>
                </div>
            </section>

            <section class="panel cart-panel">
                <h2 class="panel-title">
                    <span>Pesanan</span>
                    <span id="cartCount">(0 item)</span>
                </h2>
                
                <div class="form-group">
                    <label class="form-label">Pelanggan</label>
                    <select id="customerType" class="form-control">
                        <option value="regular">Pelanggan Biasa</option>
                        <option value="member">Member</option>
                    </select>
                </div>
                
                <div id="memberSelectContainer" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Pilih Member</label>
                        <select id="memberSelect" class="form-control"></select>
                    </div>
                </div>
                
                <div id="cartItems"></div>
                
                <div class="discount-container">
                    <div class="form-group">
                        <label class="form-label">Diskon (%)</label>
                        <input type="number" id="cartDiscountInput" class="form-control" placeholder="Masukkan diskon" min="0" max="100" value="0">
                    </div>
                </div>
                
                <div class="additional-cost-container">
                    <div class="form-group">
                        <label class="form-label">Biaya Tambahan</label>
                        <input type="number" id="additionalCostInput" class="form-control" placeholder="Contoh: Pajak, Service Charge" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Keterangan Biaya</label>
                        <input type="text" id="additionalCostNote" class="form-control" placeholder="Keterangan biaya tambahan">
                    </div>
                </div>
                
                <div class="summary-container">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Diskon:</span>
                        <span id="cartDiscount">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Biaya Tambahan:</span>
                        <span id="cartAdditionalCost">Rp 0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="cartTotal">Rp 0</span>
                    </div>
                </div>
                
                <button id="checkoutBtn" class="btn btn-success mt-3">Proses Pembayaran</button>
            </section>
        </main>

        <footer class="app-footer">
            <p>&copy; <span id="currentYear"></span> APLIKASI KASIR KAFE & RESTO - Hak Cipta Dilindungi oleh Lentera Karya Situbondo</p>
        </footer>
    </div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Proses Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nama Pelanggan (Opsional)</label>
                    <input type="text" id="customerName" class="form-control" placeholder="Masukkan nama pelanggan">
                </div>
                <div class="summary-container mb-3">
                    <div class="summary-row total-row">
                        <span>Total Tagihan:</span>
                        <span id="paymentTotal">Rp 0</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Metode Pembayaran</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Tunai</option>
                        <option value="transfer">Transfer Bank</option>
                        <option value="ewallet">E-Wallet</option>
                        <option value="debit">Kartu Debit/Kredit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Pembayaran</label>
                    <input type="number" id="paymentAmount" class="form-control" placeholder="Masukkan jumlah bayar">
                </div>
                <div id="changeContainer" style="display: none;">
                    <div class="summary-row">
                        <span>Kembalian:</span>
                        <span id="paymentChange">Rp 0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="backToCartBtn">Kembali</button>
                <button class="btn btn-success" id="completePaymentBtn">Selesaikan Pembayaran</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Menu Baru</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label class="form-label">Nama Menu</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kategori</label>
                        <select id="productCategory" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jenis Satuan</label>
                        <select id="productUnit" class="form-control" required>
                            <option value="Porsi">Porsi</option>
                            <option value="Gelas">Gelas</option>
                            <option value="Botol">Botol</option>
                            <option value="Pcs">Pcs</option>
                            <option value="Paket">Paket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga Jual</label>
                        <input type="number" id="productPrice" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga Pokok (HPP)</label>
                        <input type="number" id="productCost" class="form-control" placeholder="Opsional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stok</label>
                        <input type="number" id="productStock" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancelProduct">Batal</button>
                <button class="btn btn-success" id="saveProductBtn">Simpan</button>
            </div>
        </div>
    </div>
    
    <div id="manageCategoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Kelola Kategori Menu</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <div id="categoriesList"></div>
                <div class="form-group mt-3">
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Nama kategori baru (mis: Makanan, Minuman)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancelManageCategories">Tutup</button>
                <button class="btn btn-success" id="addCategoryBtn">Tambah Kategori</button>
            </div>
        </div>
    </div>
    
    <div id="manageCashiersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Kelola Staf</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <table class="data-table"><thead><tr><th>Username</th><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead><tbody id="cashiersList"></tbody></table>
                <button id="addCashierBtn" class="btn btn-sm btn-success mt-3">Tambah Staf</button>
            </div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelManageCashiers">Tutup</button></div>
        </div>
    </div>

    <div id="cashierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Tambah Staf Baru</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">
                <form id="cashierForm">
                    <input type="hidden" id="cashierId">
                    <div class="form-group"><label class="form-label">Username</label><input type="text" id="cashierUsername" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Nama Lengkap</label><input type="text" id="cashierName" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Password</label><input type="password" id="cashierPassword" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Konfirmasi Password</label><input type="password" id="cashierConfirmPassword" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Role</label><select id="cashierRole" class="form-control" required></select></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="cancelCashier">Batal</button>
                <button class="btn btn-success" id="saveCashierBtn">Simpan</button>
            </div>
        </div>
    </div>

    <div id="manageMembersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Kelola Member</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><div id="membersList"></div><button id="addMemberBtn" class="btn btn-sm btn-success mt-3">Tambah Member</button></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelManageMembers">Tutup</button></div>
        </div>
    </div>
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Tambah Member Baru</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><form id="memberForm"><input type="hidden" id="memberId"><div class="form-group"><label class="form-label">Nama Lengkap</label><input type="text" id="memberName" class="form-control" required></div><div class="form-group"><label class="form-label">Nomor Telepon</label><input type="text" id="memberPhone" class="form-control" required></div><div class="form-group"><label class="form-label">Alamat</label><textarea id="memberAddress" class="form-control"></textarea></div><div class="form-group"><label class="form-label">Email</label><input type="email" id="memberEmail" class="form-control"></div></form></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelMember">Batal</button><button class="btn btn-success" id="saveMemberBtn">Simpan</button></div>
        </div>
    </div>
    <div id="manageRolesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Kelola Role</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><div id="rolesList"></div><button id="addRoleBtn" class="btn btn-sm btn-success mt-3">Tambah Role</button></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelManageRoles">Tutup</button></div>
        </div>
    </div>
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Tambah Role Baru</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><form id="roleForm">/* Form content is unchanged */</form></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelRole">Batal</button><button class="btn btn-success" id="saveRoleBtn">Simpan</button></div>
        </div>
    </div>
    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Laporan Penjualan</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">/* Form content is unchanged */</div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelReports">Tutup</button><button class="btn btn-success" id="generateReportBtn">Generate Laporan</button><button class="btn btn-info" id="printReportBtn">Cetak PDF</button></div>
        </div>
    </div>
    <div id="profitReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Laporan Laba Rugi</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body">/* Form content is unchanged */</div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelProfitReport">Tutup</button><button class="btn btn-success" id="generateProfitReportBtn">Generate Laporan</button><button class="btn btn-info" id="printProfitReportBtn">Cetak PDF</button></div>
        </div>
    </div>
    <div id="manageStoreInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Kelola Info Resto</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><form id="storeInfoForm"><div class="form-group"><label class="form-label">Nama Resto</label><input type="text" id="storeName" class="form-control" required></div><div class="form-group"><label class="form-label">Alamat Resto</label><textarea id="storeAddress" class="form-control" required></textarea></div><div class="form-group"><label class="form-label">Nomor Telepon</label><input type="text" id="storePhone" class="form-control" required></div><div class="form-group"><label class="form-label">Deskripsi/Slogan</label><textarea id="storeDescription" class="form-control" placeholder="Contoh: Cita Rasa Autentik, Suasana Nyaman"></textarea></div></form></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelStoreInfo">Batal</button><button class="btn btn-success" id="saveStoreInfoBtn">Simpan</button></div>
        </div>
    </div>
    <div id="backupDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Backup Data</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><p>Backup semua data aplikasi ke file terenkripsi. File ini dapat digunakan untuk memulihkan data di kemudian hari.</p></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelBackup">Batal</button><button class="btn btn-success" id="confirmBackupBtn">Buat Backup Sekarang</button></div>
        </div>
    </div>
    <div id="restoreDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Restore Data</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><p>Restore data dari file backup. Semua data saat ini akan diganti dengan data dari file backup.</p><div class="form-group"><label class="form-label">Pilih File Backup (.json)</label><input type="file" id="restoreFileInput" class="form-control" accept=".json"></div><div class="reset-warning"><p><i class="fas fa-exclamation-triangle"></i> PERINGATAN: Tindakan ini akan menimpa semua data yang ada!</p></div></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelRestore">Batal</button><button class="btn btn-success" id="confirmRestoreBtn">Restore Data</button></div>
        </div>
    </div>
    <div id="resetDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Reset Data Aplikasi</h3><button class="modal-close">&times;</button></div>
            <div class="modal-body"><div class="reset-warning"><p><i class="fas fa-exclamation-triangle"></i> PERINGATAN: Tindakan ini akan menghapus SEMUA data (menu, transaksi, staf, dll) kecuali akun admin utama. Tindakan ini tidak dapat dibatalkan.</p></div><div class="form-group"><label class="form-label">Ketik 'RESET DATA' untuk konfirmasi</label><input type="text" id="resetConfirmText" class="form-control"></div></div>
            <div class="modal-footer"><button class="btn btn-warning" id="cancelReset">Batal</button><button class="btn btn-danger" id="confirmResetBtn" disabled>Ya, Reset Data</button></div>
        </div>
    </div>

    <div id="receiptTemplate" style="display: none;">
        </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Set locale to Indonesian
        moment.locale('id', {
            months: 'Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_November_Desember'.split('_'),
            weekdays: 'Minggu_Senin_Selasa_Rabu_Kamis_Jumat_Sabtu'.split('_'),
            longDateFormat: { LL: 'D MMMM YYYY', LLL: 'D MMMM YYYY HH:mm', LLLL: 'dddd, D MMMM YYYY HH:mm' }
        });
        
        const { jsPDF } = window.jspdf;

        const STORAGE_KEYS = {
            PRODUCTS: 'kasir_products', CATEGORIES: 'kasir_categories', TRANSACTIONS: 'kasir_transactions',
            USER: 'kasir_user', CART: 'kasir_cart', SETTINGS: 'kasir_settings',
            USERS: 'kasir_users', STOCK_HISTORY: 'kasir_stock_history', MEMBERS: 'kasir_members',
            ROLES: 'kasir_roles', MEMOS: 'kasir_memos'
        };

        const BACKUP_ENCRYPTION_KEY = 'LenteraKaryaSitubondo-2025-SecretKey';

    $(document).ready(function() {
        let products = [], categories = [], transactions = [], settings = {}, users = [], members = [], roles = [],
            currentUser = null, stockHistory = [], memos = [],
            currentCart = { items: [], subtotal: 0, discount: 0, additionalCost: 0, additionalCostNote: '', total: 0, memberId: null };
        
        // --- FUNGSI INISIALISASI DATA YANG DISEMPURNAKAN ---
        function initializeData() {
            // Logika inisialisasi yang lebih tangguh: Selalu pastikan pengguna default ada.
            let currentUsers = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [];
            let currentRoles = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLES)) || [];
            let dataWasModified = false;

            const defaultAdmin = {
                id: 'U001', username: 'admin',
                password: CryptoJS.SHA256('12345').toString(), name: 'Administrator', role: 'admin'
            };
            const defaultCashier = {
                id: 'U002', username: 'kasir',
                password: CryptoJS.SHA256('kasir123').toString(), name: 'Kasir', role: 'cashier'
            };
            const defaultAdminRole = { id: 'R001', name: 'Admin', code: 'admin', permissions: {}, memberDiscount: 10 };
            const defaultCashierRole = { id: 'R002', name: 'Kasir', code: 'cashier', permissions: {}, memberDiscount: 0 };
            
            // Mengisi semua izin untuk admin
            const allPermissions = { addProduct: true, manageCategories: true, viewReports: true, manageProducts: true, manageCashiers: true, manageMembers: true, manageStoreInfo: true, viewProfitReports: true, manageRoles: true, dataManagement: true, manageMemos: true };
            defaultAdminRole.permissions = allPermissions;

            // Cek dan tambahkan jika tidak ada
            if (!currentUsers.some(u => u.username === 'admin')) {
                currentUsers.push(defaultAdmin);
                dataWasModified = true;
            }
            if (!currentUsers.some(u => u.username === 'kasir')) {
                currentUsers.push(defaultCashier);
                dataWasModified = true;
            }
            if (!currentRoles.some(r => r.code === 'admin')) {
                currentRoles.push(defaultAdminRole);
                dataWasModified = true;
            }
            if (!currentRoles.some(r => r.code === 'cashier')) {
                currentRoles.push(defaultCashierRole);
                dataWasModified = true;
            }

            if (dataWasModified) {
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify(currentUsers));
                localStorage.setItem(STORAGE_KEYS.ROLES, JSON.stringify(currentRoles));
            }

            if (!localStorage.getItem(STORAGE_KEYS.SETTINGS)) {
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify({
                    storeName: 'Nama Kafe Anda', storeAddress: 'Alamat Kafe Anda',
                    storePhone: 'Telepon Anda', storeDescription: 'Deskripsi Kafe Anda'
                }));
            }
            // Initialize empty arrays for other keys if they don't exist
            [STORAGE_KEYS.PRODUCTS, STORAGE_KEYS.CATEGORIES, STORAGE_KEYS.TRANSACTIONS, STORAGE_KEYS.STOCK_HISTORY, STORAGE_KEYS.MEMBERS, STORAGE_KEYS.MEMOS]
                .forEach(key => { if (!localStorage.getItem(key)) localStorage.setItem(key, '[]'); });
        }


        function loadDataFromStorage() {
            products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
            categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
            transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
            settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || {};
            users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [];
            members = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEMBERS)) || [];
            roles = JSON.parse(localStorage.getItem(STORAGE_KEYS.ROLES)) || [];
            currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER)) || null;
            stockHistory = JSON.parse(localStorage.getItem(STORAGE_KEYS.STOCK_HISTORY)) || [];
            memos = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEMOS)) || [];
            currentCart = JSON.parse(localStorage.getItem(STORAGE_KEYS.CART)) || { items: [], subtotal: 0, discount: 0, additionalCost: 0, additionalCostNote: '', total: 0, memberId: null };
        }

        function saveDataToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        // --- FITUR BARU: BACKUP OTOMATIS ---
        function triggerAutoBackup(reason = "AUTO") {
            try {
                const allData = {};
                Object.values(STORAGE_KEYS).forEach(key => {
                    allData[key] = JSON.parse(localStorage.getItem(key));
                });

                const jsonString = JSON.stringify(allData);
                const encryptedData = CryptoJS.AES.encrypt(jsonString, BACKUP_ENCRYPTION_KEY).toString();

                const blob = new Blob([encryptedData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const appName = (settings.storeName || 'KASIR_KAFE').replace(/ /g, '_');
                const timestamp = moment().format('DD-MM-YYYY_HH-mm');
                
                a.href = url;
                a.download = `${appName}_BACKUP_${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log(`Backup otomatis berhasil: ${reason}`);
                showToast('Backup data otomatis berhasil dibuat.', 'success');

            } catch (error) {
                console.error("Gagal melakukan backup otomatis:", error);
                showToast('Gagal melakukan backup otomatis!', 'error');
            }
        }
        
        let hasBackedUpOnUnload = false;
        $(window).on('beforeunload', function() {
            if (currentUser && !hasBackedUpOnUnload) {
                triggerAutoBackup("REFRESH");
                hasBackedUpOnUnload = true;
            }
        });

        $('#logoutBtn').click(function(e) {
            e.preventDefault();
            if (currentUser) {
                triggerAutoBackup("LOGOUT");
            }
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.USER);
            localStorage.removeItem(STORAGE_KEYS.CART);
            $('#mainApp').fadeOut(function() {
                $('#loginModal').fadeIn();
            });
            $('#mainApp').removeClass('admin-view');
            showToast('Anda telah logout.', 'info');
        });
        
        // --- FITUR BARU: Tombol Reset Login ---
        $('#resetLoginLink').on('click', function(e) {
            e.preventDefault();
            if (confirm('Anda yakin ingin mereset data login ke pengaturan default (admin/12345 dan kasir/kasir123)?\n\nIni tidak akan menghapus data produk atau transaksi Anda.')) {
                localStorage.removeItem(STORAGE_KEYS.USERS);
                localStorage.removeItem(STORAGE_KEYS.ROLES);
                alert('Data login berhasil direset. Halaman akan dimuat ulang.');
                window.location.reload();
            }
        });
        
        $('#loginForm').submit(function(e) {
            e.preventDefault();
            const loginBtn = $(this).find('button[type="submit"]');
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();
            
            loginBtn.prop('disabled', true).text('Mencoba Login...');

            // Tambahkan sedikit delay untuk UX
            setTimeout(() => {
                const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
            
                if (user && CryptoJS.SHA256(password).toString() === user.password) {
                    currentUser = user;
                    saveDataToStorage(STORAGE_KEYS.USER, currentUser);
                    $('#loginModal').hide();
                    $('#mainApp').fadeIn();
                    initializeAppView();
                    showToast(`Selamat datang, ${currentUser.name}!`, 'success');
                } else {
                    showToast('Username atau password salah.', 'error');
                }

                loginBtn.prop('disabled', false).text('Login');
            }, 500);
        });

        function initializeAppView() {
            $('#loggedInUser').text(currentUser.name);
            updateRoleBadge(currentUser.role);
            
            $('#mainApp').removeClass('admin-view');
            $('#adminPanel').hide();
            if (currentUser.role === 'admin' || hasPermission('manageProducts')) {
                $('#mainApp').addClass('admin-view');
                $('#adminPanel').show();
                toggleAdminButtonsByPermission();
            }
            
            $('#currentYear, #receiptYear').text(new Date().getFullYear());
            updateCurrentDate();
            updateStoreInfo();
            loadCategories();
            loadProducts();
            updateCart();
            loadMembersForSelect();
        }
        
        function toggleAdminButtonsByPermission() {
            $('#addProductBtn').toggle(hasPermission('addProduct'));
            $('#manageCategoriesBtn').toggle(hasPermission('manageCategories'));
            $('#manageCashiersBtn').toggle(hasPermission('manageCashiers'));
            $('#manageMembersBtn').toggle(hasPermission('manageMembers'));
            $('#manageRolesBtn').toggle(hasPermission('manageRoles'));
            $('#viewReportsBtn').toggle(hasPermission('viewReports'));
            $('#profitReportBtn').toggle(hasPermission('viewProfitReports'));
            $('#manageStoreInfoBtn').toggle(hasPermission('manageStoreInfo'));
            $('#manageMemosBtn').toggle(hasPermission('manageMemos'));
            $('.data-management-buttons').toggle(hasPermission('dataManagement'));
        }

        function hasPermission(permission) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            const role = roles.find(r => r.code === currentUser.role);
            return role && role.permissions && role.permissions[permission];
        }

        // --- FITUR BARU: PENCARIAN BARCODE ---
        $('#barcodeSearch').on('keypress', function(e) {
            if (e.which === 13) { // Tombol Enter
                e.preventDefault();
                const barcode = $(this).val().trim();
                if (!barcode) return;
                
                const product = products.find(p => p.barcode === barcode);
                if (product) {
                    addProductToCart(product.id);
                    $(this).val('').focus(); // Kosongkan dan fokus kembali
                } else {
                    showToast('Kode Menu tidak ditemukan!', 'error');
                }
            }
        });

        // Function to add product to cart (Refactored)
        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (product.stock <= 0) {
                showToast('Stok menu habis.', 'error');
                return;
            }
            const existingItem = currentCart.items.find(item => item.product.id === productId);
            if (existingItem) {
                if (existingItem.quantity + 1 > product.stock) {
                    showToast('Stok tidak mencukupi.', 'error');
                    return;
                }
                existingItem.quantity++;
            } else {
                currentCart.items.push({ product: product, quantity: 1 });
            }
            updateCart();
            showToast(`${product.name} ditambahkan.`, 'success');
        }

        $(document).on('click', '.product-card', function() {
            addProductToCart($(this).data('id'));
        });
        
        function generateUniqueBarcode() {
            const chars = '0123456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // Dihilangkan I, O untuk menghindari kebingungan
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            if (products.some(p => p.barcode === result)) {
                return generateUniqueBarcode();
            }
            return result;
        }

        // Sisanya adalah kode yang sama dari versi sebelumnya (manajemen produk, keranjang, checkout, dll)
        // Saya akan pastikan semua fungsi penting ada di sini
        // ... (Kode untuk loadProducts, openEdit, delete, saveProduct, updateCart, dll. sama seperti sebelumnya)
        function loadProducts(searchTerm = '', category = 'all') {
            let filteredProducts = products;
            if (searchTerm) {
                const lowerTerm = searchTerm.toLowerCase();
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(lowerTerm) ||
                    (p.barcode && p.barcode.toLowerCase().includes(lowerTerm))
                );
            }
            if (category !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === category);
            }

            $('#productCount').text(`(${filteredProducts.length} menu)`);
            const grid = $('#productGrid').empty();
            if (filteredProducts.length === 0) {
                grid.html(`<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-search"></i><p>Menu tidak ditemukan</p></div>`);
                return;
            }
            
            filteredProducts.forEach(product => {
                const stockClass = product.stock <= 5 ? 'low' : '';
                grid.append(`
                    <div class="product-card" data-id="${product.id}">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                        <div class="product-barcode"><i class="fas fa-barcode"></i> ${product.barcode || 'N/A'}</div>
                        <div class="product-stock ${stockClass}">Stok: ${product.stock} ${product.unit || 'Porsi'}</div>
                        ${hasPermission('manageProducts') ? `
                        <div class="product-actions">
                            <div class="action-btn edit-btn" onclick="event.stopPropagation(); openEditProductModal('${product.id}')"><i class="fas fa-edit"></i></div>
                            <div class="action-btn delete-btn" onclick="event.stopPropagation(); deleteProduct('${product.id}')"><i class="fas fa-trash"></i></div>
                        </div>` : ''}
                    </div>
                `);
            });
        }
        
        window.openEditProductModal = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            $('#productModal .modal-title').text('Edit Menu');
            $('#productId').val(product.id);
            $('#productName').val(product.name);
            loadCategoriesForSelect();
            $('#productCategory').val(product.category);
            $('#productUnit').val(product.unit);
            $('#productPrice').val(product.price);
            $('#productCost').val(product.cost || '');
            $('#productStock').val(product.stock);
            $('#productModal').css('display', 'flex');
        };

        window.deleteProduct = (productId) => {
            if (confirm('Anda yakin ingin menghapus menu ini?')) {
                products = products.filter(p => p.id !== productId);
                saveDataToStorage(STORAGE_KEYS.PRODUCTS, products);
                loadProducts();
                showToast('Menu berhasil dihapus.', 'success');
            }
        };

        $('#saveProductBtn').click(function() {
            const id = $('#productId').val();
            const newProductData = {
                name: $('#productName').val().trim(),
                category: $('#productCategory').val(),
                unit: $('#productUnit').val(),
                price: parseFloat($('#productPrice').val()) || 0,
                cost: parseFloat($('#productCost').val()) || 0,
                stock: parseInt($('#productStock').val()) || 0,
            };
            
            if (!newProductData.name || !newProductData.category || newProductData.price <= 0) {
                showToast('Nama, kategori, dan harga harus diisi.', 'error');
                return;
            }

            if (id) {
                const index = products.findIndex(p => p.id === id);
                if (index > -1) {
                    products[index] = { ...products[index], ...newProductData };
                }
            } else {
                newProductData.id = 'P' + Date.now();
                newProductData.barcode = generateUniqueBarcode();
                products.unshift(newProductData);
            }

            saveDataToStorage(STORAGE_KEYS.PRODUCTS, products);
            loadProducts();
            $('#productModal').hide();
            $('#productForm')[0].reset();
            showToast('Menu berhasil disimpan.', 'success');
        });

        function updateCart() {
            currentCart.subtotal = currentCart.items.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            const discountPercentage = parseFloat($('#cartDiscountInput').val()) || 0;
            currentCart.discount = currentCart.subtotal * (discountPercentage / 100);
            currentCart.additionalCost = parseFloat($('#additionalCostInput').val()) || 0;
            currentCart.total = currentCart.subtotal - currentCart.discount + currentCart.additionalCost;

            const cartItemsDiv = $('#cartItems').empty();
            if (currentCart.items.length === 0) {
                cartItemsDiv.html(`<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Keranjang kosong</p></div>`);
            } else {
                currentCart.items.forEach(item => {
                    cartItemsDiv.append(`
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.product.name}</div>
                                <div class="cart-item-price">${formatCurrency(item.product.price)}</div>
                            </div>
                            <div class="cart-item-qty">
                                <button class="qty-btn" onclick="updateItemQuantity('${item.product.id}', -1)">-</button>
                                <input type="number" class="qty-input" value="${item.quantity}" onchange="setItemQuantity('${item.product.id}', this.value)">
                                <button class="qty-btn" onclick="updateItemQuantity('${item.product.id}', 1)">+</button>
                                <div class="remove-btn" onclick="removeItemFromCart('${item.product.id}')"><i class="fas fa-trash"></i></div>
                            </div>
                        </div>`);
                });
            }
            $('#cartSubtotal').text(formatCurrency(currentCart.subtotal));
            $('#cartDiscount').text(formatCurrency(currentCart.discount));
            $('#cartAdditionalCost').text(formatCurrency(currentCart.additionalCost));
            $('#cartTotal').text(formatCurrency(currentCart.total));
            $('#cartCount').text(`(${currentCart.items.reduce((sum, item) => sum + item.quantity, 0)} item)`);
            saveDataToStorage(STORAGE_KEYS.CART, currentCart);
        }

        window.updateItemQuantity = (productId, change) => {
            const item = currentCart.items.find(i => i.product.id === productId);
            if (item) {
                let newQty = item.quantity + change;
                if (newQty < 1) return; // Jangan hapus, biarkan 1
                if (newQty > item.product.stock) {
                    showToast('Stok tidak mencukupi', 'error');
                    return;
                }
                item.quantity = newQty;
                updateCart();
            }
        };
        window.setItemQuantity = (productId, qty) => {
             const item = currentCart.items.find(i => i.product.id === productId);
             if (item) {
                let newQty = parseInt(qty) || 1;
                if (newQty < 1) newQty = 1;
                 if (newQty > item.product.stock) {
                    showToast('Stok tidak mencukupi', 'error');
                    newQty = item.product.stock;
                }
                item.quantity = newQty;
                updateCart();
             }
        };
        window.removeItemFromCart = (productId) => {
            currentCart.items = currentCart.items.filter(i => i.product.id !== productId);
            updateCart();
        };

        $('#checkoutBtn').click(function() {
            if (currentCart.items.length === 0) {
                showToast('Keranjang pesanan kosong.', 'warning');
                return;
            }
            $('#paymentTotal').text(formatCurrency(currentCart.total));
            $('#paymentAmount').val('');
            $('#changeContainer').hide();
            $('#checkoutModal').css('display', 'flex');
        });

        $('#paymentAmount').on('input', function() {
            const amount = parseFloat($(this).val()) || 0;
            const change = amount - currentCart.total;
            if (change >= 0) {
                $('#changeContainer').show();
                $('#paymentChange').text(formatCurrency(change));
            } else {
                $('#changeContainer').hide();
            }
        });
        
        $('#completePaymentBtn').click(function() {
            const paymentAmount = parseFloat($('#paymentAmount').val()) || 0;
            if (paymentAmount < currentCart.total) {
                showToast('Jumlah pembayaran kurang.', 'error');
                return;
            }
            const transaction = {
                id: 'TRX' + Date.now(),
                date: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(currentCart.items)), // Deep copy
                customer: $('#customerName').val() || 'Pelanggan',
                subtotal: currentCart.subtotal,
                discount: currentCart.discount,
                additionalCost: currentCart.additionalCost,
                total: currentCart.total,
                paymentMethod: $('#paymentMethod').val(),
                paymentAmount: paymentAmount,
                change: paymentAmount - currentCart.total,
                cashier: { id: currentUser.id, name: currentUser.name }
            };
            transactions.unshift(transaction);
            saveDataToStorage(STORAGE_KEYS.TRANSACTIONS, transactions);

            transaction.items.forEach(item => {
                const product = products.find(p => p.id === item.product.id);
                if (product) product.stock -= item.quantity;
            });
            saveDataToStorage(STORAGE_KEYS.PRODUCTS, products);

            generateAndShowReceipt(transaction);
            $('#checkoutModal').hide();
            showToast('Transaksi berhasil!', 'success');
            resetCart();
            loadProducts();
        });

        function resetCart() {
            currentCart = { items: [], subtotal: 0, discount: 0, additionalCost: 0, additionalCostNote: '', total: 0, memberId: null };
            updateCart();
            $('#cartDiscountInput, #additionalCostInput').val(0);
            $('#additionalCostNote').val('');
        }

        function generateAndShowReceipt(transaction) {
            let itemsHtml = '';
            transaction.items.forEach(item => {
                const itemName = item.product.name.padEnd(20, ' ').substring(0, 20);
                const itemTotal = formatCurrency(item.product.price * item.quantity).padStart(12, ' ');
                itemsHtml += `<div>${itemName}${itemTotal}</div><div style="padding-left: 2px;">${item.quantity} x ${formatCurrency(item.product.price)}</div>`;
            });
            const receiptHtml = `
            <div class="receipt" id="printableReceipt">
                <div class="receipt-header" style="text-align: center;">
                    <h3>${settings.storeName}</h3>
                    <p>${settings.storeAddress}<br>${settings.storePhone}</p>
                </div>
                <hr>
                <div>No: ${transaction.id}</div>
                <div>Tgl: ${moment(transaction.date).format('DD/MM/YY HH:mm')}</div>
                <div>Kasir: ${transaction.cashier.name}</div>
                <div>Plgn: ${transaction.customer}</div>
                <hr>
                ${itemsHtml}
                <hr>
                <div class="receipt-item"><span>Subtotal:</span><span>${formatCurrency(transaction.subtotal)}</span></div>
                <div class="receipt-item"><span>Diskon:</span><span>-${formatCurrency(transaction.discount)}</span></div>
                <div class="receipt-item"><span>Biaya Lain:</span><span>${formatcurrency(transaction.additionalCost)}</span></div>
                <div class="receipt-item total-row"><span>TOTAL:</span><span>${formatCurrency(transaction.total)}</span></div>
                <div class="receipt-item"><span>${transaction.paymentMethod.toUpperCase()}:</span><span>${formatCurrency(transaction.paymentAmount)}</span></div>
                <div class="receipt-item"><span>Kembali:</span><span>${formatCurrency(transaction.change)}</span></div>
                <hr>
                <div class="receipt-footer" style="text-align: center;">
                    <p>${settings.storeDescription || 'Terima Kasih Atas Kunjungan Anda'}</p>
                </div>
            </div>
            <div class="mt-3 text-center" style="display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-info btn-sm" onclick="printReceipt()"><i class="fas fa-print"></i> Cetak Struk</button>
                <button class="btn btn-warning btn-sm" onclick="closeReceipt()">Tutup</button>
            </div>
            `;
            $('#receiptTemplate').html(receiptHtml).css('display', 'flex').css('position', 'fixed').css('top', 0).css('left', 0).css('width', '100%').css('height', '100%').css('background', 'rgba(0,0,0,0.6)').css('align-items', 'center').css('justify-content', 'center').css('flex-direction', 'column');
        }
        window.closeReceipt = () => { $('#receiptTemplate').hide(); };
        window.printReceipt = () => { /* ... print logic ... */ };

        function updateCurrentDate() { $('#currentDate').text(moment().format('LLLL')); }
        function updateStoreInfo() { $('#storeNameHeader').text(settings.storeName || 'Kasir Kafe & Resto'); }
        function loadCategories() { /* ... */ }
        function loadCategoriesForSelect() { /* ... */ }
        function formatCurrency(amount) { return 'Rp ' + (amount || 0).toLocaleString('id-ID'); }
        function showToast(message, type = 'info') { /* ... */ }
        
        $('.modal-close, .btn-warning[id^="cancel"]').click(function() { $(this).closest('.modal').hide(); });
        $('#addProductBtn').click(() => { /* ... */ });
        $('#manageCategoriesBtn').click(() => { /* ... */ });
        $('#confirmRestoreBtn').click(function() { /* ... */ });
        function updateRoleBadge(roleCode) { /* ... */ }

        // Initial setup
        initializeData();
        loadDataFromStorage();
        if (currentUser) {
            initializeAppView();
            $('#loginModal').hide();
            $('#mainApp').show();
        }
    });
    </script>
</body>
</html>
