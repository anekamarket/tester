<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM MANAJEMEN KARCIS WISATA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --wisata-primary: #00695c; /* Teal */
            --wisata-secondary: #f9a825; /* Yellow */
            --wisata-accent: #4caf50; /* Green */
            --wisata-light: #e0f2f1; /* Light Teal */
            --wisata-dark: #37474f; /* Blue Grey */
            --wisata-gradient: linear-gradient(135deg, var(--wisata-primary), var(--wisata-accent));
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 28px rgba(0,0,0,0.15);
        }
        
        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #e0f7fa 100%);
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 10px 0;
            overflow-x: hidden;
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 15px;
        }

        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: var(--shadow-lg); width: 100%; max-width: 400px; text-align: center;
        }
        
        .login-box .developer-info { font-size: 0.8rem; color: #6c757d; margin-top: 25px; }
        .login-box .developer-info a { color: var(--wisata-primary); text-decoration: none; }
        .login-box .developer-info a:hover { text-decoration: underline; }
        .login-box .app-logo { font-size: 3rem; color: var(--wisata-primary); margin-bottom: 15px; }
        .login-box h2 { margin-bottom: 25px; color: var(--wisata-dark); font-weight: 700; }
        
        .app-container { max-width: 1600px; margin: 0 auto; background: white; box-shadow: var(--shadow-lg); border-radius: 12px; overflow: hidden; position: relative; z-index: 10; }
        .app-header { background: var(--wisata-gradient); color: white; padding: 20px 15px; text-align: center; position: relative; overflow: hidden; }
        .app-header::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); pointer-events: none; }
        .app-logo { font-size: 2.5rem; margin-bottom: 10px; position: relative; z-index: 1; }
        .app-title { font-size: 1.8rem; font-weight: 800; margin: 0; position: relative; z-index: 1; text-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
        .app-subtitle { font-size: 1rem; opacity: 0.95; position: relative; z-index: 1; font-weight: 300; letter-spacing: 0.5px; margin-bottom: 5px; }
        
        .nav-pills .nav-link { border-radius: 8px; margin-bottom: 8px; padding: 12px 15px; font-weight: 500; color: #444; transition: all 0.3s ease; display: flex; align-items: center; font-size: 0.9rem; }
        .nav-pills .nav-link:hover { background-color: #f1f8e9; transform: translateX(3px); }
        .nav-pills .nav-link.active { background: var(--wisata-gradient); font-weight: 600; box-shadow: var(--shadow-md); transform: translateX(3px); color: white; }
        
        .section-title { border-left: 4px solid var(--wisata-primary); padding-left: 12px; margin: 20px 0; font-weight: 700; color: var(--wisata-dark); font-size: 1.4rem; position: relative; }
        .section-title::after { content: ""; position: absolute; bottom: -5px; left: 12px; width: 40px; height: 2px; background: var(--wisata-gradient); border-radius: 2px; }
        
        .btn-primary { background: var(--wisata-gradient); border: none; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        
        .form-label { font-weight: 600; color: #444; margin-bottom: 8px; display: flex; align-items: center; font-size: 0.9rem; }
        .form-label i { margin-right: 6px; color: var(--wisata-primary); }
        .form-control, .form-select { border-radius: 8px; padding: 12px 15px; border: 1px solid #ddd; transition: all 0.3s; box-shadow: var(--shadow-sm); font-size: 0.9rem; }
        .form-control:focus, .form-select:focus { border-color: var(--wisata-primary); box-shadow: 0 0 0 3px rgba(0, 105, 92, 0.2); transform: translateY(-2px); }
        
        .copyright { text-align: center; padding: 20px; background-color: var(--wisata-light); color: var(--wisata-dark); font-size: 0.9rem; font-weight: 500; line-height: 1.6; }
        .copyright a { color: var(--wisata-primary); text-decoration: none; font-weight: 600; }
        .copyright a:hover { text-decoration: underline; }
        
        .data-table th { background: var(--wisata-gradient); color: white; }
        .data-table { font-size: 0.85rem; border-collapse: separate; border-spacing: 0; box-shadow: var(--shadow-sm); border-radius: 8px; overflow: hidden; }
        .data-table th { font-weight: 600; padding: 12px 10px; text-align: center; position: relative; font-size: 0.85rem; }
        .data-table td { padding: 10px 8px; vertical-align: middle; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .data-table tr:hover { background-color: #f1f8e9; }

        .stats-box { text-align: center; padding: 20px 15px; border-radius: 10px; background: white; box-shadow: var(--shadow-md); transition: all 0.3s; position: relative; overflow: hidden; }
        .stats-box::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--wisata-gradient); }
        .stats-box:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stats-number { font-size: 1.8rem; font-weight: 800; margin: 10px 0; color: var(--wisata-primary); }
        .stats-label { font-size: 0.9rem; color: #666; font-weight: 500; }

        .card { border-radius: 10px; border: none; box-shadow: var(--shadow-md); transition: all 0.3s ease; overflow: hidden; margin-bottom: 15px; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .card-header { background: var(--wisata-gradient); color: white; font-weight: 600; }
        .feature-icon { font-size: 1.1rem; margin-right: 8px; width: 24px; text-align: center; }

        .ticket-status { display: inline-block; padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.75rem; font-weight: bold; }
        .status-available { background-color: #28a745; }
        .status-used { background-color: #673ab7; }
        .status-sold { background-color: #17a2b8; }
        .status-expired { background-color: #f44336; }

        /* Struk/Receipt styles */
        .receipt-container { background: white; padding: 20px; max-width: 450px; margin: auto; border-radius: 10px; box-shadow: var(--shadow-md); }
        .receipt-header { border-bottom: 2px dashed var(--wisata-dark); padding-bottom: 15px; margin-bottom: 15px; text-align: center; }
        .receipt-table { font-size: 0.9rem; }
        .receipt-table th { background: var(--wisata-primary); color: white; }
        .receipt-footer { border-top: 2px dashed var(--wisata-dark); padding-top: 15px; margin-top: 20px; font-style: italic; color: #6c757d; text-align: center; }
        
        /* Toast Notification */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

        /* === PRINT STYLES === */
        @media print {
            body, html { background: #fff !important; margin: 0; padding: 0; font-size: 10pt; }
            .no-print { display: none !important; }
            .printable-area { display: block !important; visibility: visible !important; position: static !important; }
            .app-container, .main-app, body > *:not(.printable-area) { display: none; }
            
            @page {
                size: A4;
                margin: 0;
            }
            
            /* Print style for 10 tickets on A4 */
            .ticket-print-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 5mm;
                width: 210mm;
                height: 297mm;
                padding: 10mm;
                box-sizing: border-box;
            }
            .ticket-mini {
                border: 1px dashed #333;
                padding: 5mm;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                text-align: center;
                height: 53.4mm; /* (297mm - 20mm padding) / 5 rows - 5mm gap */
                overflow: hidden;
            }
            .ticket-mini h5 { font-size: 10pt; font-weight: bold; margin-bottom: 4px; }
            .ticket-mini p { font-size: 8pt; margin: 2px 0; }
            .ticket-mini .ticket-code {
                font-family: 'Courier New', Courier, monospace;
                font-size: 11pt; font-weight: bold; padding: 5px;
                background: #f0f0f0; border-radius: 4px; letter-spacing: 2px;
                margin-top: 8px;
            }
            .ticket-mini .ticket-footer { font-size: 7pt; margin-top: 5px; }

            /* Print style for Receipt */
            .receipt-printable-area {
                width: 100%;
                box-shadow: none !important;
                border: none !important;
            }
            .receipt-container {
                box-shadow: none !important;
                max-width: 100%;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-box">
            <div class="app-logo"><i class="fas fa-ticket-alt"></i></div>
            <h2>Sistem Manajemen Karcis Wisata</h2>
            <form id="loginForm">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="petugasName" placeholder="Nama Petugas" required>
                    <label for="petugasName">Nama Petugas</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" placeholder="Username" required value="Admin">
                    <label for="username">Username</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Password" required>
                    <label for="password">Password</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg">Login</button>
                <div id="loginError" class="alert alert-danger mt-3" style="display: none;" role="alert"></div>
            </form>
            <div class="developer-info">
                Developed by <strong>Lentera Karya Situbondo</strong><br>
                <a href="https://wa.me/6287865614222" target="_blank">WhatsApp: 087865614222</a> | 
                <a href="http://www.anekamarket.my.id" target="_blank">www.anekamarket.my.id</a><br>
                &copy; Hak Cipta Sejak 2025
            </div>
        </div>
    </div>

    <main id="mainApp" style="display: none;">
        <div class="app-container">
            <div class="app-header no-print">
                <div class="app-logo"><i class="fas fa-mountain"></i></div>
                <h1 class="app-title">SISTEM MANAJEMEN KARCIS WISATA</h1>
                <p class="app-subtitle">Solusi Terpadu untuk Pengelolaan Tiket Tempat Wisata</p>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 bg-light p-3 no-print" id="sidebar">
                    <h6 class="text-muted text-uppercase small ps-2 mb-2">Menu</h6>
                    <ul class="nav nav-pills flex-column" id="myTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard"><i class="fas fa-tachometer-alt feature-icon"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" id="transaction-tab" data-bs-toggle="tab" href="#transaction"><i class="fas fa-cash-register feature-icon"></i>Transaksi Penjualan</a></li>
                        <li class="nav-item"><a class="nav-link" id="validation-tab" data-bs-toggle="tab" href="#validation"><i class="fas fa-check-circle feature-icon"></i>Validasi Karcis</a></li>
                        <li class="nav-item"><a class="nav-link" id="receipt-tab" data-bs-toggle="tab" href="#receipt"><i class="fas fa-receipt feature-icon"></i>Kasir & Struk</a></li>
                        <li class="nav-item"><a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history"><i class="fas fa-history feature-icon"></i>Histori Transaksi</a></li>
                        <li class="nav-item"><a class="nav-link" id="ticket-management-tab" data-bs-toggle="tab" href="#ticket-management"><i class="fas fa-ticket-alt feature-icon"></i>Manajemen Karcis</a></li>
                        <li class="nav-item"><a class="nav-link" id="customer-tab" data-bs-toggle="tab" href="#customer"><i class="fas fa-users feature-icon"></i>Data Pelanggan</a></li>
                        <li class="nav-item"><a class="nav-link" id="report-tab" data-bs-toggle="tab" href="#report"><i class="fas fa-chart-bar feature-icon"></i>Laporan</a></li>
                        <li class="nav-item"><a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings"><i class="fas fa-cog feature-icon"></i>Pengaturan</a></li>
                    </ul>
                    <hr>
                    <div class="px-2">
                        <p class="small mb-1">Login sebagai:</p>
                        <strong id="loggedInUser"></strong>
                    </div>
                </div>
                
                <div class="col-md-9 col-lg-10 p-4">
                    <div class="tab-content" id="myTabContent">
                        
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                            <h3 class="section-title">Dashboard</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-users fa-2x text-primary mb-2"></i><div class="stats-number" id="totalVisitorsToday">0</div><div class="stats-label">Pengunjung Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-ticket-alt fa-2x text-success mb-2"></i><div class="stats-number" id="ticketsSoldCount">0</div><div class="stats-label">Karcis Terjual Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-wallet fa-2x text-warning mb-2"></i><div class="stats-number" id="todayRevenue">0</div><div class="stats-label">Pendapatan Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-layer-group fa-2x text-info mb-2"></i><div class="stats-number" id="availableStock">0</div><div class="stats-label">Stok Karcis Tersedia</div></div></div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12"><div class="card"><div class="card-header"><i class="fas fa-chart-line me-2"></i>Statistik Penjualan Mingguan</div><div class="card-body"><canvas id="salesChart" height="150"></canvas></div></div></div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="transaction" role="tabpanel">
                            <h3 class="section-title">Transaksi Penjualan Karcis</h3>
                            <div class="card">
                                <div class="card-body">
                                    <form id="addTransactionForm">
                                        <div class="row align-items-end">
                                            <div class="col-md-4 mb-3"><label class="form-label"><i class="fas fa-ticket-alt"></i>Jenis Karcis</label><select class="form-select" id="transTicketType" required></select></div>
                                            <div class="col-md-2 mb-3"><label class="form-label"><i class="fas fa-sort-numeric-up"></i>Jumlah</label><input type="number" class="form-control" id="transQuantity" min="1" value="1" required></div>
                                            <div class="col-md-3 mb-3"><label class="form-label"><i class="fas fa-user"></i>Nama Pelanggan (Opsional)</label><input type="text" class="form-control" id="transCustomerName" placeholder="Nama atau Rombongan"></div>
                                            <div class="col-md-3 mb-3"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-cart-plus me-2"></i>Tambah</button></div>
                                        </div>
                                    </form>
                                    <hr>
                                    <div class="card bg-light mb-4">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted"><i class="fas fa-search me-2"></i>Validasi Cepat Karcis</h6>
                                            <form id="quickValidateForm" class="d-flex gap-2">
                                                <input type="text" class="form-control text-uppercase" id="quickTicketCodeInput" placeholder="Masukkan Kode Karcis" required>
                                                <button type="submit" class="btn btn-secondary">Cek</button>
                                            </form>
                                            <div id="quickValidationResult" class="mt-2" style="min-height: 25px;"></div>
                                        </div>
                                    </div>
                                    <h5><i class="fas fa-shopping-cart me-2"></i>Keranjang Penjualan</h5>
                                    <div class="table-responsive">
                                        <table class="table data-table">
                                            <thead><tr><th>Jenis Karcis</th><th>Jumlah</th><th>Harga Satuan</th><th>Subtotal</th><th>Aksi</th></tr></thead>
                                            <tbody id="cartList"></tbody>
                                            <tfoot><tr><th colspan="3" class="text-end fs-5">Total</th><th id="cartTotal" class="fs-5">Rp 0</th><th></th></tr></tfoot>
                                        </table>
                                    </div>
                                    <div class="text-end mt-3"><button class="btn btn-success btn-lg" id="processSaleBtn" disabled><i class="fas fa-cash-register me-2"></i>Proses Pembayaran</button></div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="validation" role="tabpanel">
                            <h3 class="section-title">Validasi Karcis Masuk</h3>
                            <div class="row justify-content-center"><div class="col-md-8 col-lg-6"><div class="card text-center"><div class="card-body p-5">
                                <i class="fas fa-qrcode fa-4x text-muted mb-4"></i>
                                <h4 class="card-title">Pindai atau Masukkan Kode Karcis</h4>
                                <form id="validateTicketForm">
                                    <input type="text" class="form-control form-control-lg text-center mb-3 text-uppercase" id="ticketCodeInput" placeholder="KODE-UNIK" required style="letter-spacing: 3px; font-weight: bold;">
                                    <button type="submit" class="btn btn-primary btn-lg w-100"><i class="fas fa-search me-2"></i>Validasi Karcis</button>
                                </form>
                                <div id="validationResult" class="mt-4" style="min-height: 60px;"></div>
                            </div></div></div></div>
                        </div>

                        <div class="tab-pane fade" id="receipt" role="tabpanel">
                             <h3 class="section-title">Kasir & Cetak Struk</h3>
                             <p>Menampilkan struk dari transaksi terakhir. Anda dapat mencetak ulang struk dari menu <strong>Histori Transaksi</strong>.</p>
                             <div class="card"><div class="card-body">
                                <div id="receiptViewer">
                                    <div class="text-center text-muted p-5"><i class="fas fa-receipt fa-3x mb-3"></i><p>Belum ada transaksi yang diproses pada sesi ini.</p></div>
                                </div>
                             </div></div>
                        </div>

                        <div class="tab-pane fade" id="history" role="tabpanel">
                            <h3 class="section-title">Histori Transaksi</h3>
                            <div class="card"><div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover data-table">
                                        <thead><tr><th>ID Transaksi</th><th>Waktu</th><th>Petugas</th><th>Pelanggan</th><th>Total</th><th>Aksi</th></tr></thead>
                                        <tbody id="transactionHistoryList"></tbody>
                                    </table>
                                </div>
                            </div></div>
                        </div>
                        
                        <div class="tab-pane fade" id="ticket-management" role="tabpanel">
                            <h3 class="section-title">Manajemen Jenis & Stok Karcis</h3>
                            <div class="mb-3">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTicketTypeModal"><i class="fas fa-plus me-2"></i>Tambah Jenis Karcis</button>
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateTicketsModal"><i class="fas fa-cogs me-2"></i>Generate & Cetak Karcis</button>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="card"><div class="card-header"><i class="fas fa-tags me-2"></i>Daftar Jenis Karcis</div><div class="card-body">
                                        <table class="table data-table">
                                            <thead><tr><th>Nama</th><th>Harga</th><th>Aksi</th></tr></thead>
                                            <tbody id="ticketTypeList"></tbody>
                                        </table>
                                    </div></div>
                                </div>
                                <div class="col-md-7">
                                    <div class="card"><div class="card-header"><i class="fas fa-layer-group me-2"></i>Daftar Stok Karcis (20 Terbaru)</div><div class="card-body">
                                        <table class="table data-table">
                                            <thead><tr><th>Kode Unik</th><th>Jenis</th><th>Status</th></tr></thead>
                                            <tbody id="ticketStockList"></tbody>
                                        </table>
                                    </div></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="customer" role="tabpanel">
                            <h3 class="section-title">Manajemen Data Pelanggan</h3>
                            <p>Data pelanggan atau rombongan yang tercatat saat transaksi.</p>
                             <div class="card"><div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover data-table">
                                        <thead><tr><th>ID</th><th>Nama Pelanggan/Rombongan</th><th>Kunjungan Terakhir</th><th>Total Kunjungan</th></tr></thead>
                                        <tbody id="customerList"></tbody>
                                    </table>
                                </div>
                            </div></div>
                        </div>
                        
                        <div class="tab-pane fade" id="report" role="tabpanel">
                           <h3 class="section-title">Laporan dan Analisis</h3>
                           <div class="card mb-4"><div class="card-body">
                                <div class="row gy-3 align-items-end">
                                    <div class="col-lg-3 col-md-6"><label for="reportType" class="form-label">Jenis Laporan</label><select class="form-select" id="reportType"><option value="revenue">Pendapatan</option><option value="visitors">Jumlah Pengunjung</option><option value="ticket_sales">Penjualan per Jenis Karcis</option></select></div>
                                    <div class="col-lg-3 col-md-6"><label for="reportStartDate" class="form-label">Periode Mulai</label><input type="date" class="form-control" id="reportStartDate"></div>
                                    <div class="col-lg-3 col-md-6"><label for="reportEndDate" class="form-label">Periode Akhir</label><input type="date" class="form-control" id="reportEndDate"></div>
                                    <div class="col-lg-3 col-md-6"><button class="btn btn-primary w-100" id="generateReportBtn"><i class="fas fa-chart-pie me-2"></i>Generate Laporan</button></div>
                                </div>
                           </div></div>
                           <div id="reportResult"></div>
                        </div>
                        
                        <div class="tab-pane fade" id="settings" role="tabpanel">
                            <h3 class="section-title">Pengaturan Sistem</h3>
                             <div class="row">
                                <div class="col-lg-6 mb-4 mb-lg-0"><div class="card"><div class="card-header"><i class="fas fa-info-circle me-2"></i>Informasi Tempat Wisata</div><div class="card-body">
                                    <form id="generalSettingsForm">
                                        <div class="mb-3"><label for="wisataName" class="form-label">Nama Wisata</label><input type="text" class="form-control" id="wisataName" placeholder="Masukkan nama tempat wisata"></div>
                                        <div class="mb-3"><label for="wisataAddress" class="form-label">Alamat</label><textarea class="form-control" id="wisataAddress" rows="3" placeholder="Masukkan alamat"></textarea></div>
                                        <div class="mb-3"><label for="wisataPhone" class="form-label">Telepon</label><input type="text" class="form-control" id="wisataPhone" placeholder="Masukkan telepon"></div>
                                        <div class="mb-3"><label for="wisataEmail" class="form-label">Email</label><input type="email" class="form-control" id="wisataEmail" placeholder="Masukkan email"></div>
                                        <hr>
                                        <div class="mb-3"><label for="taxRate" class="form-label">Pajak (%) - Fitur Masa Depan</label><input type="number" class="form-control" id="taxRate" min="0" max="30" step="0.1" placeholder="cth: 10" disabled></div>
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Pengaturan</button>
                                    </form>
                                </div></div></div>
                                <div class="col-lg-6"><div class="card"><div class="card-header"><i class="fas fa-database me-2"></i>Manajemen Data</div><div class="card-body"><div class="d-grid gap-2">
                                    <button class="btn btn-info" id="backupDataBtn"><i class="fas fa-download me-2"></i>Backup Semua Data (JSON)</button>
                                    <button class="btn btn-danger" id="resetDataBtn"><i class="fas fa-trash-alt me-2"></i>Reset Semua Data Aplikasi</button>
                                </div></div></div>
                                <div class="card mt-4"><div class="card-header"><i class="fas fa-user-circle me-2"></i>Akun</div><div class="card-body">
                                    <p>Anda login sebagai <strong id="loggedInUserRole">Admin</strong>.</p>
                                    <button class="btn btn-outline-danger" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
                                </div></div></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div class="copyright no-print">
                Developed by <strong><a href="http://www.anekamarket.my.id" target="_blank">Lentera Karya Situbondo</a></strong> &copy; Hak Cipta Sejak 2025.
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="addTicketTypeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Tambah/Edit Jenis Karcis</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><form id="ticketTypeForm"><input type="hidden" id="ticketTypeId"><div class="mb-3"><label class="form-label">Nama Jenis Karcis</label><input type="text" class="form-control" id="ticketTypeName" placeholder="cth: Dewasa, Anak" required></div><div class="mb-3"><label class="form-label">Harga</label><input type="number" class="form-control" id="ticketTypePrice" min="0" required></div></form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="saveTicketTypeBtn">Simpan</button></div>
    </div></div></div>

    <div class="modal fade" id="generateTicketsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Generate Karcis Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><form id="generateTicketsForm"><div class="mb-3"><label class="form-label">Pilih Jenis Karcis</label><select class="form-select" id="generateTicketType" required></select></div><div class="mb-3"><label class="form-label">Jumlah Karcis (kelipatan 10)</label><input type="number" class="form-control" id="generateQuantity" min="10" step="10" value="10" required></div></form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="generateAndPrintBtn">Generate & Cetak</button></div>
    </div></div></div>

    <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Proses Pembayaran</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><div class="row gy-3"><div class="col-md-12"><label class="form-label fw-bold">Total Tagihan</label><input type="text" id="paymentTotal" class="form-control form-control-lg" readonly style="font-weight: bold;"></div><div class="col-md-6"><label class="form-label fw-bold">Jumlah Bayar</label><input type="number" id="amountPaid" class="form-control form-control-lg" placeholder="0"></div><div class="col-md-6"><label class="form-label fw-bold">Kembalian</label><input type="text" id="changeDue" class="form-control form-control-lg" readonly style="font-weight: bold; color: green;"></div></div></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-success" id="confirmPaymentBtn" disabled>Konfirmasi & Cetak Struk</button></div>
    </div></div></div>

    <div class="modal fade" id="passwordConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="passwordConfirmTitle">Konfirmasi Keamanan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p id="passwordConfirmMessage">Masukkan kata sandi untuk melanjutkan.</p><form id="passwordConfirmForm"><div class="form-floating mb-3"><input type="password" class="form-control" id="confirmPassword" placeholder="Password" required><label for="confirmPassword">Password</label></div><div id="passwordConfirmError" class="alert alert-danger" style="display: none;"></div></form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="confirmPasswordBtn">Konfirmasi</button></div>
    </div></div></div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <i id="toastIcon" class="fas fa-check-circle rounded me-2"></i>
          <strong class="me-auto" id="toastTitle">Notifikasi</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
      </div>
    </div>

    <div id="ticketPrintableArea" class="printable-area" style="display: none;"></div>
    <div id="receiptPrintableArea" class="printable-area receipt-printable-area" style="display: none;"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    // SISTEM MANAJEMEN KARCIS WISATA - VERSI SEMPURNA
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIG & STATE ---
        const CONFIG = {
            LOGIN_USER: 'Admin',
            LOGIN_PASS: 'Gemini2025',
            PASSWORD_PROMPT_ACTIONS: {
                SAVE_SETTINGS: 'SAVE_SETTINGS',
                RESET_DATA: 'RESET_DATA'
            }
        };
        let appState = {
            cart: [],
            salesChartInstance: null,
            passwordAction: null,
            passwordModal: null,
            appToast: null
        };

        // --- INITIALIZATION ---
        function initApp() {
            appState.passwordModal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
            appState.appToast = new bootstrap.Toast(document.getElementById('appToast'));

            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeAppCore();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('password').value = '';
                document.getElementById('petugasName').value = '';
            }
        }

        function initializeAppCore() {
            initStorage();
            setupEventListeners();
            loadAllData();
            const petugasName = sessionStorage.getItem('petugasName');
            document.getElementById('loggedInUser').textContent = petugasName;
            showToast('Login Berhasil', `Selamat datang kembali, ${petugasName}!`, 'success');
        }
        
        function initStorage() {
            const initItem = (key, value) => !localStorage.getItem(key) && localStorage.setItem(key, JSON.stringify(value));
            initItem('wisata_ticket_types', []);
            initItem('wisata_ticket_stock', []);
            initItem('wisata_transactions', []);
            initItem('wisata_customers', []);
            initItem('wisata_settings', {
                wisataName: 'WISATA ALAM GEMINI',
                wisataAddress: 'Jl. Puncak Jaya No. 1, Indonesia',
                wisataPhone: '0812-3456-7890',
                wisataEmail: 'info@wisatagemini.com',
                taxRate: 0
            });
        }
        
        function setupEventListeners() {
            // Main Actions
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('saveTicketTypeBtn').addEventListener('click', saveTicketType);
            document.getElementById('generateAndPrintBtn').addEventListener('click', generateAndPrintTickets);
            document.getElementById('addTransactionForm').addEventListener('submit', addToCart);
            document.getElementById('processSaleBtn').addEventListener('click', () => new bootstrap.Modal(document.getElementById('paymentModal')).show());
            document.getElementById('confirmPaymentBtn').addEventListener('click', processSale);
            document.getElementById('validateTicketForm').addEventListener('submit', validateTicket);
            document.getElementById('quickValidateForm').addEventListener('submit', quickValidateTicket); // Listener untuk validasi cepat
            document.getElementById('generalSettingsForm').addEventListener('submit', (e) => { e.preventDefault(); requestPassword(CONFIG.PASSWORD_PROMPT_ACTIONS.SAVE_SETTINGS); });
            document.getElementById('resetDataBtn').addEventListener('click', () => requestPassword(CONFIG.PASSWORD_PROMPT_ACTIONS.RESET_DATA));
            document.getElementById('backupDataBtn').addEventListener('click', backupAllData);
            document.getElementById('confirmPasswordBtn').addEventListener('click', handlePasswordConfirmation);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            
            // UI Helpers
            document.getElementById('amountPaid').addEventListener('input', calculateChange);
            document.querySelector('#addTicketTypeModal').addEventListener('hidden.bs.modal', () => document.getElementById('ticketTypeForm').reset());
            document.querySelector('#paymentModal').addEventListener('shown.bs.modal', () => document.getElementById('amountPaid').focus());
            document.querySelector('#paymentModal').addEventListener('hidden.bs.modal', () => {
                document.getElementById('amountPaid').value = '';
                document.getElementById('changeDue').value = '';
            });
        }

        // --- LOGIN & AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const petugasName = document.getElementById('petugasName').value;
            const errorEl = document.getElementById('loginError');

            if (!petugasName.trim()) {
                errorEl.textContent = 'Nama Petugas wajib diisi.';
                errorEl.style.display = 'block';
                return;
            }

            if (user === CONFIG.LOGIN_USER && pass === CONFIG.LOGIN_PASS) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('petugasName', petugasName);
                initApp();
            } else {
                errorEl.textContent = 'Username atau Password salah.';
                errorEl.style.display = 'block';
            }
        }

        function handleLogout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                sessionStorage.clear();
                window.location.reload();
            }
        }
        
        function requestPassword(action) {
            appState.passwordAction = action;
            const title = document.getElementById('passwordConfirmTitle');
            const message = document.getElementById('passwordConfirmMessage');
            if (action === CONFIG.PASSWORD_PROMPT_ACTIONS.SAVE_SETTINGS) {
                title.textContent = 'Konfirmasi Simpan Pengaturan';
                message.textContent = 'Masukkan kata sandi untuk menyimpan perubahan.';
            } else if (action === CONFIG.PASSWORD_PROMPT_ACTIONS.RESET_DATA) {
                title.textContent = 'PERINGATAN! Reset Data';
                message.innerHTML = '<strong class="text-danger">Anda akan menghapus SEMUA data. Tindakan ini tidak dapat dibatalkan.</strong><br>Masukkan kata sandi untuk melanjutkan.';
            }
            document.getElementById('passwordConfirmError').style.display = 'none';
            document.getElementById('confirmPassword').value = '';
            appState.passwordModal.show();
            document.getElementById('confirmPassword').focus();
        }

        function handlePasswordConfirmation() {
            const pass = document.getElementById('confirmPassword').value;
            if (pass === CONFIG.LOGIN_PASS) {
                appState.passwordModal.hide();
                if (appState.passwordAction === CONFIG.PASSWORD_PROMPT_ACTIONS.SAVE_SETTINGS) {
                    executeSaveSettings();
                } else if (appState.passwordAction === CONFIG.PASSWORD_PROMPT_ACTIONS.RESET_DATA) {
                    executeResetAllData();
                }
            } else {
                const errorEl = document.getElementById('passwordConfirmError');
                errorEl.textContent = 'Password salah. Coba lagi.';
                errorEl.style.display = 'block';
            }
        }

        // --- DATA LOADING & RENDERING ---
        function loadAllData() {
            loadTicketTypes();
            loadTicketStock();
            updateDashboard();
            loadTransactionHistory();
            loadCustomers();
            loadSettings();
            renderCart();
        }
        
        function loadTicketTypes() {
            const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            const list = document.getElementById('ticketTypeList');
            const selects = [document.getElementById('generateTicketType'), document.getElementById('transTicketType')];
            
            list.innerHTML = '';
            selects.forEach(sel => sel.innerHTML = '<option value="" disabled selected>Pilih Jenis Karcis</option>');
            
            types.sort((a,b) => a.name.localeCompare(b.name)).forEach(type => {
                list.innerHTML += `<tr><td>${type.name}</td><td>${formatCurrency(type.price)}</td><td><button class="btn btn-sm btn-outline-warning" onclick="app.editTicketType('${type.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="app.deleteTicketType('${type.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                selects.forEach(sel => sel.innerHTML += `<option value="${type.id}">${type.name} - ${formatCurrency(type.price)}</option>`);
            });
        }

        function loadTicketStock() {
            const stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
            const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            const typeMap = new Map(types.map(t => [t.id, t.name]));
            const list = document.getElementById('ticketStockList');
            list.innerHTML = '';
            stock.slice(-20).reverse().forEach(ticket => {
                list.innerHTML += `<tr><td>${ticket.code}</td><td>${typeMap.get(ticket.typeId) || 'N/A'}</td><td><span class="ticket-status status-${ticket.status}">${ticket.status.toUpperCase()}</span></td></tr>`;
            });
        }
        
        function loadTransactionHistory() {
            const history = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
            const list = document.getElementById('transactionHistoryList');
            list.innerHTML = '';
            history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(trans => {
                list.innerHTML += `<tr><td>${trans.id}</td><td>${new Date(trans.timestamp).toLocaleString('id-ID')}</td><td>${trans.petugas}</td><td>${trans.customerName || '-'}</td><td>${formatCurrency(trans.total)}</td><td><button class="btn btn-sm btn-info" onclick="app.viewReceipt('${trans.id}')"><i class="fas fa-print me-1"></i> Lihat</button></td></tr>`;
            });
        }
        
        function loadCustomers() {
            const customers = JSON.parse(localStorage.getItem('wisata_customers') || '[]');
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            customers.sort((a,b) => new Date(b.lastVisit) - new Date(a.lastVisit)).forEach(c => {
                list.innerHTML += `<tr><td>${c.id}</td><td>${c.name}</td><td>${new Date(c.lastVisit).toLocaleDateString('id-ID')}</td><td>${c.transactionCount}</td></tr>`;
            });
        }
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('wisata_settings'));
            document.getElementById('wisataName').value = settings.wisataName;
            document.getElementById('wisataAddress').value = settings.wisataAddress;
            document.getElementById('wisataPhone').value = settings.wisataPhone;
            document.getElementById('wisataEmail').value = settings.wisataEmail;
            document.getElementById('taxRate').value = settings.taxRate;
        }

        // --- CORE FEATURES ---
        window.app = {}; // Expose functions to global scope for inline HTML event handlers

        window.app.editTicketType = (id) => {
            const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            const type = types.find(t => t.id === id);
            if (!type) return;
            document.getElementById('ticketTypeId').value = type.id;
            document.getElementById('ticketTypeName').value = type.name;
            document.getElementById('ticketTypePrice').value = type.price;
            new bootstrap.Modal(document.getElementById('addTicketTypeModal')).show();
        };

        window.app.deleteTicketType = (id) => {
             if (!confirm('Yakin ingin menghapus jenis karcis ini?')) return;
            let types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            types = types.filter(t => t.id !== id);
            localStorage.setItem('wisata_ticket_types', JSON.stringify(types));
            loadTicketTypes();
            showToast('Berhasil', 'Jenis karcis telah dihapus.', 'success');
        }

        function saveTicketType() {
            const id = document.getElementById('ticketTypeId').value;
            const name = document.getElementById('ticketTypeName').value.trim();
            const price = parseFloat(document.getElementById('ticketTypePrice').value);
            if (!name || isNaN(price) || price < 0) {
                showToast('Gagal', 'Nama dan harga valid wajib diisi.', 'error');
                return;
            }
            let types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            if (id) { // Update
                const index = types.findIndex(t => t.id === id);
                if (index > -1) types[index] = { ...types[index], name, price };
            } else { // Create
                types.push({ id: `TYPE-${Date.now()}`, name, price });
            }
            localStorage.setItem('wisata_ticket_types', JSON.stringify(types));
            bootstrap.Modal.getInstance(document.getElementById('addTicketTypeModal')).hide();
            loadTicketTypes();
            showToast('Berhasil', 'Jenis karcis berhasil disimpan.', 'success');
        }

        function generateAndPrintTickets() {
            const typeId = document.getElementById('generateTicketType').value;
            const quantity = parseInt(document.getElementById('generateQuantity').value);
            const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            const selectedType = types.find(t => t.id === typeId);

            if (!typeId || isNaN(quantity) || quantity < 10 || quantity % 10 !== 0) {
                showToast('Gagal', 'Pilih jenis karcis dan masukkan jumlah dalam kelipatan 10.', 'error');
                return;
            }

            let stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
            const stockCodes = new Set(stock.map(t => t.code));
            const settings = JSON.parse(localStorage.getItem('wisata_settings'));
            let newTickets = [];
            
            for (let i = 0; i < quantity; i++) {
                let uniqueCode;
                do { uniqueCode = generateUniqueCode(5); } while (stockCodes.has(uniqueCode));
                
                const newTicket = { code: uniqueCode, typeId, status: 'available' };
                newTickets.push(newTicket);
                stock.push(newTicket);
                stockCodes.add(uniqueCode);
            }

            localStorage.setItem('wisata_ticket_stock', JSON.stringify(stock));
            
            // --- PERBAIKAN CETAK KARCIS ---
            const ticketHtmlChunks = newTickets.map(ticket => `
                <div class="ticket-mini">
                    <div>
                        <h5>${settings.wisataName || 'Tempat Wisata'}</h5>
                        <p>KARCIS MASUK RESMI</p>
                        <p><strong>${selectedType.name}</strong> - ${formatCurrency(selectedType.price)}</p>
                    </div>
                    <div><p class="ticket-code">${ticket.code}</p><p class="ticket-footer">Berlaku untuk 1 kali masuk. Simpan baik-baik.</p></div>
                </div>`).join('');

            const printableContent = `<div class="ticket-print-container">${ticketHtmlChunks}</div>`;
            document.getElementById('ticketPrintableArea').innerHTML = printableContent;
            
            bootstrap.Modal.getInstance(document.getElementById('generateTicketsModal')).hide();
            loadAllData();
            showToast('Berhasil', `${quantity} karcis baru telah dibuat.`, 'success');
            
            // Logika pencetakan yang lebih andal
            const printWindow = window.open('', '_blank', 'height=800,width=900');
            printWindow.document.write('<html><head><title>Cetak Karcis</title>');
            // Salin semua gaya dari dokumen utama untuk memastikan tampilan yang konsisten
            printWindow.document.write('<style>' + document.querySelector('style').innerHTML + '</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printableContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            // Gunakan onload untuk memastikan konten dimuat sepenuhnya sebelum mencetak
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
            // --- AKHIR PERBAIKAN ---
        }

        function addToCart(e) {
            e.preventDefault();
            const typeId = document.getElementById('transTicketType').value;
            const quantity = parseInt(document.getElementById('transQuantity').value);
            if (!typeId || isNaN(quantity) || quantity <= 0) {
                showToast('Gagal', 'Pilih jenis karcis dan jumlah yang valid.', 'error');
                return;
            }
            const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
            const type = types.find(t => t.id === typeId);
            const existingItem = appState.cart.find(item => item.typeId === typeId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                appState.cart.push({ typeId, name: type.name, quantity, price: type.price });
            }
            document.getElementById('addTransactionForm').reset();
            document.getElementById('transTicketType').value = '';
            renderCart();
        }
        
        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            let total = 0;
            if (appState.cart.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">Keranjang masih kosong</td></tr>';
            } else {
                 appState.cart.forEach((item, index) => {
                    const subtotal = item.quantity * item.price;
                    total += subtotal;
                    list.innerHTML += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(subtotal)}</td><td><button class="btn btn-sm btn-outline-danger" onclick="app.removeFromCart(${index})"><i class="fas fa-times"></i></button></td></tr>`;
                });
            }
            document.getElementById('cartTotal').textContent = formatCurrency(total);
            document.getElementById('paymentTotal').value = formatCurrency(total);
            document.getElementById('processSaleBtn').disabled = appState.cart.length === 0;
        }

        window.app.removeFromCart = (index) => {
            appState.cart.splice(index, 1);
            renderCart();
        }
        
        function calculateChange() {
            const total = appState.cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
            document.getElementById('changeDue').value = paid >= total ? formatCurrency(paid - total) : '';
            document.getElementById('confirmPaymentBtn').disabled = paid < total;
        }

        function processSale() {
            const total = appState.cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            let transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
            let customers = JSON.parse(localStorage.getItem('wisata_customers') || '[]');
            const customerName = document.getElementById('transCustomerName').value.trim();
            const transactionId = `TRX-${Date.now()}`;
            
            const transaction = {
                id: transactionId,
                timestamp: new Date().toISOString(),
                petugas: sessionStorage.getItem('petugasName'),
                items: appState.cart,
                total: total,
                customerName: customerName
            };
            transactions.push(transaction);
            
            if (customerName) {
                let customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                if (customer) {
                    customer.transactionCount++;
                    customer.lastVisit = new Date().toISOString();
                } else {
                    customers.push({id: `CUST-${Date.now()}`, name: customerName, transactionCount: 1, lastVisit: new Date().toISOString() });
                }
                localStorage.setItem('wisata_customers', JSON.stringify(customers));
            }

            localStorage.setItem('wisata_transactions', JSON.stringify(transactions));
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            document.getElementById('transCustomerName').value = '';

            appState.cart = [];
            renderCart();
            loadAllData();
            showToast('Transaksi Berhasil', `Transaksi ${transactionId} berhasil diproses.`, 'success');
            viewReceipt(transaction.id, true);
        }
        
        function performTicketValidation(code, resultDiv) {
            resultDiv.innerHTML = '';
            if (!code) return;
            
            let stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
            const ticketIndex = stock.findIndex(t => t.code === code);
            
            let alertClass, title, message, smallText = resultDiv.id.includes('quick');

            if (ticketIndex === -1) {
                alertClass = 'alert-danger'; title = 'Gagal!'; message = 'Kode karcis tidak ditemukan.';
            } else if (stock[ticketIndex].status === 'used') {
                alertClass = 'alert-warning'; title = 'Peringatan!'; message = `Sudah digunakan pada ${new Date(stock[ticketIndex].usedAt).toLocaleString('id-ID')}.`;
            } else if (stock[ticketIndex].status === 'available') {
                stock[ticketIndex].status = 'used';
                stock[ticketIndex].usedAt = new Date().toISOString();
                localStorage.setItem('wisata_ticket_stock', JSON.stringify(stock));
                alertClass = 'alert-success'; title = 'Berhasil!'; message = 'Karcis valid, selamat datang.';
                loadAllData(); // Update dashboard etc.
            } else {
                alertClass = 'alert-secondary'; title = 'Info:'; message = `Status karcis: ${stock[ticketIndex].status}.`;
            }

            const alertSize = smallText ? 'alert-sm p-2 small' : '';
            resultDiv.innerHTML = `<div class="alert ${alertClass} ${alertSize}"><strong>${title}</strong> ${message}</div>`;

            setTimeout(() => resultDiv.innerHTML = '', 7000); // Clear message after 7 seconds
        }

        function validateTicket(e) {
            e.preventDefault();
            const code = document.getElementById('ticketCodeInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('validationResult');
            performTicketValidation(code, resultDiv);
            document.getElementById('ticketCodeInput').value = '';
            document.getElementById('ticketCodeInput').focus();
        }

        function quickValidateTicket(e) {
            e.preventDefault();
            const code = document.getElementById('quickTicketCodeInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('quickValidationResult');
            performTicketValidation(code, resultDiv);
            document.getElementById('quickTicketCodeInput').value = '';
        }

        // --- SETTINGS & DATA MANAGEMENT ---
        function executeSaveSettings() {
            const newSettings = {
                wisataName: document.getElementById('wisataName').value,
                wisataAddress: document.getElementById('wisataAddress').value,
                wisataPhone: document.getElementById('wisataPhone').value,
                wisataEmail: document.getElementById('wisataEmail').value,
                taxRate: parseFloat(document.getElementById('taxRate').value) || 0
            };
            localStorage.setItem('wisata_settings', JSON.stringify(newSettings));
            showToast('Berhasil', 'Pengaturan berhasil disimpan.', 'success');
        }
        
        function executeResetAllData() {
            localStorage.removeItem('wisata_ticket_types');
            localStorage.removeItem('wisata_ticket_stock');
            localStorage.removeItem('wisata_transactions');
            localStorage.removeItem('wisata_customers');
            // Keep settings
            initStorage();
            loadAllData();
            showToast('Reset Berhasil', 'Semua data transaksi dan karcis telah dihapus.', 'success');
        }

        function backupAllData() {
            const data = {
                types: JSON.parse(localStorage.getItem('wisata_ticket_types')),
                stock: JSON.parse(localStorage.getItem('wisata_ticket_stock')),
                transactions: JSON.parse(localStorage.getItem('wisata_transactions')),
                customers: JSON.parse(localStorage.getItem('wisata_customers')),
                settings: JSON.parse(localStorage.getItem('wisata_settings')),
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wisata_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            showToast('Backup', 'Data sedang diunduh.', 'info');
        }

        // --- REPORTS ---
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const resultDiv = document.getElementById('reportResult');

            if (!startDate || !endDate) {
                showToast('Gagal', 'Silakan pilih periode mulai dan akhir laporan.', 'error');
                return;
            }

            const transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
            const filtered = transactions.filter(t => {
                const date = t.timestamp.split('T')[0];
                return date >= startDate && date <= endDate;
            });

            let reportData = { title: '', headers: [], rows: [], summary: ''};
            
            switch(reportType) {
                case 'revenue':
                    reportData.title = `Laporan Pendapatan (${startDate} s/d ${endDate})`;
                    reportData.headers = ["ID Transaksi", "Tanggal", "Petugas", "Total"];
                    let totalRevenue = 0;
                    filtered.forEach(t => {
                        reportData.rows.push([t.id, new Date(t.timestamp).toLocaleString('id-ID'), t.petugas, formatCurrency(t.total)]);
                        totalRevenue += t.total;
                    });
                    reportData.summary = `<div class="alert alert-success fs-5"><strong>Total Pendapatan: ${formatCurrency(totalRevenue)}</strong></div>`;
                    break;
                
                case 'visitors':
                    const usedTickets = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]').filter(t => t.status === 'used' && t.usedAt);
                    const filteredVisitors = usedTickets.filter(t => {
                        const date = t.usedAt.split('T')[0];
                        return date >= startDate && date <= endDate;
                    });
                    reportData.title = `Laporan Pengunjung (${startDate} s/d ${endDate})`;
                    reportData.summary = `<div class="alert alert-success fs-5"><strong>Total Pengunjung: ${filteredVisitors.length} orang</strong></div>`;
                    break;

                case 'ticket_sales':
                    reportData.title = `Laporan Penjualan per Jenis Karcis (${startDate} s/d ${endDate})`;
                    reportData.headers = ["Jenis Karcis", "Jumlah Terjual", "Total Pendapatan"];
                    const salesMap = {};
                    filtered.forEach(t => {
                        t.items.forEach(item => {
                            if (!salesMap[item.name]) salesMap[item.name] = { qty: 0, revenue: 0 };
                            salesMap[item.name].qty += item.quantity;
                            salesMap[item.name].revenue += item.quantity * item.price;
                        });
                    });
                    let totalTickets = 0;
                    let totalSalesRevenue = 0;
                    for (const name in salesMap) {
                        reportData.rows.push([name, salesMap[name].qty, formatCurrency(salesMap[name].revenue)]);
                        totalTickets += salesMap[name].qty;
                        totalSalesRevenue += salesMap[name].revenue;
                    }
                     reportData.summary = `<div class="alert alert-success fs-5"><strong>Total Karcis Terjual: ${totalTickets} | Total Pendapatan: ${formatCurrency(totalSalesRevenue)}</strong></div>`;
                    break;
            }

            // Render Report
            let tableHtml = '';
            if (reportData.headers.length > 0) {
                 tableHtml = `<table class="table data-table table-bordered"><thead><tr><th>${reportData.headers.join('</th><th>')}</th></tr></thead><tbody>
                ${reportData.rows.map(row => `<tr><td>${row.join('</td><td>')}</td></tr>`).join('')}
                </tbody></table>`;
            }
           
            resultDiv.innerHTML = `
                <div class="card"><div class="card-body">
                    <h4 class="card-title">${reportData.title}</h4>
                    <div class="mb-3">
                        <button class="btn btn-sm btn-danger" onclick="app.exportReportToPDF()"><i class="fas fa-file-pdf me-1"></i> Export PDF</button>
                        <button class="btn btn-sm btn-success" onclick="app.exportReportToExcel()"><i class="fas fa-file-excel me-1"></i> Export Excel</button>
                    </div>
                    ${reportData.summary}
                    <div class="table-responsive">${tableHtml}</div>
                </div></div>`;

            // Store for export
            window.reportForExport = reportData;
        }

        window.app.exportReportToPDF = () => {
            if (!window.reportForExport) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { title, headers, rows } = window.reportForExport;

            doc.text(title, 14, 15);
            if (headers.length > 0) {
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 25,
                });
            } else {
                doc.text(document.querySelector('#reportResult .alert').textContent, 14, 25);
            }
            doc.save(`laporan_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.app.exportReportToExcel = () => {
            if (!window.reportForExport) return;
            const { title, headers, rows } = window.reportForExport;
            
            const ws_data = [headers, ...rows];
            const wb = XLSX.utils.book_new();
            if (headers.length > 0) {
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            } else {
                 const ws = XLSX.utils.aoa_to_sheet([[document.querySelector('#reportResult .alert').textContent]]);
                 XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            }
            XLSX.writeFile(wb, `laporan_${new Date().toISOString().split('T')[0]}.xlsx`);
        };


        // --- UI & HELPERS ---
        window.app.viewReceipt = (transactionId, autoPrint = false) => {
            const transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
            const transaction = transactions.find(t => t.id === transactionId);
            const settings = JSON.parse(localStorage.getItem('wisata_settings'));
            if (!transaction) return;

            const itemsHtml = transaction.items.map(item => `
                <tr><td>${item.name} (x${item.quantity})</td><td class="text-end">${formatCurrency(item.quantity * item.price)}</td></tr>
            `).join('');

            const receiptHtml = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <h4>${settings.wisataName}</h4>
                        <p class="mb-0 small">${settings.wisataAddress}<br>Telp: ${settings.wisataPhone}</p>
                    </div>
                    <p class="small mb-1">No: ${transaction.id}<br>Tanggal: ${new Date(transaction.timestamp).toLocaleString('id-ID')}<br>Kasir: ${transaction.petugas}</p>
                    <hr class="my-2">
                    <table class="table receipt-table table-sm">
                        <tbody>${itemsHtml}</tbody>
                        <tfoot><tr class="fw-bold"><td>TOTAL</td><td class="text-end">${formatCurrency(transaction.total)}</td></tr></tfoot>
                    </table>
                    <div class="receipt-footer small"><p>Terima kasih atas kunjungan Anda!</p></div>
                    ${autoPrint ? '' : '<div class="text-center mt-3 no-print"><button class="btn btn-primary" onclick="app.printReceipt()"><i class="fas fa-print me-2"></i>Cetak Struk</button></div>'}
                </div>`;

            document.getElementById('receiptViewer').innerHTML = receiptHtml;
            document.getElementById('receiptPrintableArea').innerHTML = receiptHtml;
            
            if (!autoPrint) {
                new bootstrap.Tab(document.getElementById('receipt-tab')).show();
            } else {
                app.printReceipt();
            }
        };
        
        window.app.printReceipt = () => {
            const printContent = document.getElementById('receiptPrintableArea').innerHTML;
            const printWindow = window.open('', 'PRINT', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Struk Pembayaran</title>');
            printWindow.document.write('<style>' + document.querySelector('style').innerHTML + '</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        function updateDashboard() {
            const transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
            const stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
            const today = new Date().toISOString().slice(0, 10);

            const todayTransactions = transactions.filter(t => t.timestamp.startsWith(today));
            const totalVisitorsToday = stock.filter(t => t.status === 'used' && t.usedAt?.startsWith(today)).length;
            const ticketsSoldCount = todayTransactions.reduce((sum, t) => sum + t.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const availableStock = stock.filter(t => t.status === 'available').length;
            
            document.getElementById('totalVisitorsToday').textContent = totalVisitorsToday;
            document.getElementById('ticketsSoldCount').textContent = ticketsSoldCount;
            document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);
            document.getElementById('availableStock').textContent = availableStock;
            
            updateSalesChart(transactions);
        }
        
        function updateSalesChart(transactions) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const labels = [];
            const data = [];
            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().slice(0, 10);
                labels.push(d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric'}));
                const dayRevenue = transactions.filter(t => t.timestamp.startsWith(dateStr)).reduce((sum, t) => sum + t.total, 0);
                data.push(dayRevenue);
            }

            if (appState.salesChartInstance) appState.salesChartInstance.destroy();
            appState.salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Pendapatan', data, borderColor: 'var(--wisata-primary)', backgroundColor: 'rgba(0, 105, 92, 0.1)', fill: true, tension: 0.3 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } } }
            });
        }
        
        function showToast(title, body, type = 'info') {
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            const toastIcon = document.getElementById('toastIcon');
            const header = document.querySelector('#appToast .toast-header');

            toastTitle.textContent = title;
            toastBody.textContent = body;
            toastIcon.className = 'fas rounded me-2'; // reset
            header.classList.remove('bg-success', 'bg-danger', 'bg-info', 'text-white');
            
            if (type === 'success') {
                toastIcon.classList.add('fa-check-circle');
                header.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toastIcon.classList.add('fa-exclamation-circle');
                header.classList.add('bg-danger', 'text-white');
            } else {
                toastIcon.classList.add('fa-info-circle');
                header.classList.add('bg-info', 'text-white');
            }
            appState.appToast.show();
        }

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
        const generateUniqueCode = (length) => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };
        
        // --- START APP ---
        initApp();
    });
    </script>
</body>
</html>
