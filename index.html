<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFE & RESTO</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #28a745;
            --primary-light: #d4edda;
            --secondary: #218838;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --white: #ffffff;
            --shadow-sm: 0 0.15rem 0.35rem rgba(0,0,0,0.1);
            --shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            --rounded-sm: 0.35rem;
            --rounded: 0.75rem;
            --rounded-lg: 1rem;
            --donation: #6f42c1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f8f9fa;
            color: #212529;
            line-height: 1.5;
            touch-action: manipulation;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 12px;
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 12px 16px;
            border-radius: var(--rounded);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--white);
            padding: 5px;
            box-shadow: var(--shadow-sm);
        }
        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .header-info p {
            margin: 2px 0;
        }

        /* Main Content Layout */
        .app-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Panel Styles */
        .panel {
            background: var(--white);
            border-radius: var(--rounded);
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .menu-card {
            background: var(--white);
            border-radius: var(--rounded-sm);
            padding: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .menu-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .menu-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .menu-image i {
            font-size: 1.5rem;
            color: var(--gray);
        }

        .menu-name {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .menu-price {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .menu-category {
            font-size: 0.7rem;
            color: var(--gray);
            background-color: var(--light);
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
        }

        /* Search and Filter */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-container i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-chip {
            padding: 8px 12px;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-chip.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Order Styles */
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: 500;
        }

        .order-item-price {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .whatsapp-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        .whatsapp-link:hover {
            text-decoration: underline;
        }

        .order-item-qty {
            display: flex;
            align-items: center;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: var(--light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
        }

        .remove-btn {
            color: var(--danger);
            margin-left: 8px;
            cursor: pointer;
        }

        /* Summary Styles */
        .summary-container {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed #ddd;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .total-row {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--rounded-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn .fa-spinner {
            margin-right: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-donation {
            background-color: var(--donation);
        }

        .btn-donation:hover {
            background-color: #5a32a3;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            text-align: center;
            flex: 1;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: var(--rounded-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 20px auto;
            background: var(--white);
            border-radius: var(--rounded-lg);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .login-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .login-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 600;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background-color: var(--dark);
            color: var(--white);
            border-radius: var(--rounded-sm);
            box-shadow: var(--shadow);
            z-index: 1100;
            display: flex;
            align-items: center;
            transform: translateX(200%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warning {
            background-color: var(--warning);
            color: #000;
        }

        .toast i {
            margin-right: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background-color: var(--light);
            border-radius: var(--rounded);
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: var(--light);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }

        /* Menu Actions */
        .menu-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .menu-card:hover .menu-actions {
            display: flex;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
        }

        .edit-btn {
            background-color: var(--info);
        }

        .delete-btn {
            background-color: var(--danger);
        }

        /* Note Input */
        .note-input {
            margin-top: 12px;
        }

        .note-input textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            resize: vertical;
            min-height: 60px;
        }

        /* Table Number */
        .table-number {
            margin-bottom: 16px;
        }

        .table-number select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
        }

        /* Order Type */
        .order-type {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .order-type-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--rounded-sm);
            text-align: center;
            cursor: pointer;
            background-color: var(--light);
        }

        .order-type-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Member Search */
        .member-search-container {
            position: relative;
        }

        .member-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 var(--rounded-sm) var(--rounded-sm);
            z-index: 100;
            display: none;
        }

        .member-search-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .member-search-item:hover {
            background-color: var(--light);
        }

        /* Kitchen Status */
        .kitchen-status {
            margin-top: 16px;
            padding: 12px;
            background-color: var(--light);
            border-radius: var(--rounded-sm);
        }

        .kitchen-status h4 {
            margin-bottom: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-preparing {
            color: var(--danger);
            cursor: pointer;
        }

        .status-ready {
            color: var(--success);
        }

        .status-locked {
            color: var(--gray);
            cursor: default;
        }
        
        /* Payment Modal Enhancements */
        .payment-total-display {
            background: var(--primary-light);
            border-radius: var(--rounded);
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .payment-total-display p {
            font-size: 1rem;
            color: var(--secondary);
            margin: 0;
        }
        
        .payment-total-display h3 {
            font-size: 2rem;
            color: var(--primary);
            margin: 0;
        }
        
        .quick-cash-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        /* Member Badge */
        .member-badge {
            background-color: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Donation Badge */
        .donation-badge {
            background-color: var(--donation);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .app-content {
                flex-direction: row;
            }
            
            .menu-panel {
                flex: 2;
            }
            
            .order-panel {
                flex: 1;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            animation: fadeIn 0.3s;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mt-3 {
            margin-top: 16px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .d-flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .gap-2 {
            gap: 8px;
        }
        
        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .print-btn {
            background-color: var(--info);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            display: inline-block;
            cursor: pointer;
        }
        
        /* === PERBAIKAN & PENYEMPURNAAN KODE CETAK (REVISI FINAL) === */
        #receiptContent {
            font-family: 'Courier New', Courier, monospace;
            width: 300px; /* Lebar default untuk tampilan modal */
            margin: 0 auto;
            padding: 15px;
            font-size: 12px;
            line-height: 1.3;
            color: #000;
            background: white;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 8px;
        }
        
        .receipt-logo {
            width: 50px;
            height: 50px;
            margin: 0 auto 5px auto;
            object-fit: contain;
        }

        .receipt-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .receipt-info {
            margin-bottom: 8px;
            font-size: 11px;
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 5px 0;
        }
        
        .receipt-info div {
            display: flex;
            justify-content: space-between;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        .receipt-item-details {
            display: block;
        }
        
        .receipt-item-details .item-name {
            font-weight: bold;
        }
        .receipt-item-details .item-price-calc {
            font-size: 10px;
            padding-left: 5px;
        }
        
        #receiptItemsContainer {
             padding: 8px 0;
        }

        .receipt-total {
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #000;
        }

        .receipt-footer {
            margin-top: 12px;
            font-size: 10px;
            text-align: center;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            #print-container, #print-container * {
                visibility: visible;
            }

            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            /* Memastikan hanya konten di dalam #print-container yang di-render */
            #print-container #receiptContent,
            #print-container #ktaCard {
                margin: 0;
                padding: 0;
                box-shadow: none !important;
                border: none !important;
            }
            
            /* Mengatur ukuran struk untuk printer thermal (misal: 72mm atau 58mm) */
            /* Sesuaikan 'width' di bawah ini dengan lebar kertas printer Anda */
            #print-container #receiptContent {
                width: 72mm !important; /* Ganti ke 58mm jika perlu */
                font-size: 9pt !important; /* Font diperkecil untuk cetak */
                padding: 2mm !important; /* Memberi sedikit margin di kertas */
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: auto; /* Membiarkan browser menentukan ukuran berdasarkan konten */
                margin: 0mm; /* Menghapus margin halaman bawaan browser */
            }
        }
        /* === AKHIR DARI PERBAIKAN KODE CETAK === */


        /* Backup Restore Styles */
        .backup-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .backup-btn {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: block;
            padding: 12px;
            background-color: var(--info);
            color: white;
            border-radius: var(--rounded-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-label:hover {
            background-color: #138496;
        }
        
        
        /* === PERBAIKAN & PENYEMPURNAAN DESAIN KTA (REVISI) === */
        #ktaCard {
            width: 320px;
            height: 500px;
            margin: 0 auto;
            border-radius: 20px;
            background: radial-gradient(circle at top left, #feda75, #fa7e1e, #d62976, #962fbf, #4f5bd5);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #ktaCard::before {
            content: '';
            position: absolute;
            top: -80px;
            left: -80px;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            filter: blur(10px);
        }
        
        #ktaCard::after {
            content: '';
            position: absolute;
            bottom: -100px;
            right: -60px;
            width: 250px;
            height: 250px;
            background: rgba(255,255,255,0.15);
            border-radius: 45%;
            filter: blur(15px);
        }

        .kta-header {
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 15px;
            margin-bottom: 25px;
            z-index: 1;
        }
        .kta-logo {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            background-color: white;
        }
        .kta-store-info h3 {
            font-size: 18px;
            margin: 0;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        .kta-store-info p {
            font-size: 11px;
            margin: 0;
            opacity: 0.9;
        }

        .kta-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1;
        }

        #ktaMemberName {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        
        #ktaMemberId {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background-color: rgba(0,0,0,0.3);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        
        .kta-qrcode {
            background: white;
            padding: 10px;
            border-radius: 8px;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .kta-qrcode img {
            width: 160px;
            height: auto;
            display: block;
        }

        .kta-footer {
            text-align: center;
            font-size: 11px;
            opacity: 0.8;
            padding-top: 15px;
            margin-top: 25px;
            border-top: 1px solid rgba(255,255,255,0.3);
            z-index: 1;
        }
        /* === AKHIR DARI PERBAIKAN KTA === */


    </style>
</head>
<body>
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification message</span>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-utensils"></i>
                </div>
                <h1 class="login-title">CAFE & RESTO</h1>
                <p>Aplikasi Penjualan Digital</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Nama Kasir</label>
                    <input type="text" id="username" class="form-control" placeholder="Masukkan nama Anda" required>
                </div>
                <button type="submit" class="btn mt-3">Login</button>
            </form>
        </div>
    </div>
    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div class="header-title-container">
                <div class="header-logo">
                    <img src="" alt="Logo">
                </div>
                <div>
                    <h1 class="app-title" id="storeNameHeader">CAFE & RESTO</h1>
                    <p id="currentDate">Rabu, 24 September 2025</p>
                </div>
            </div>
            <div class="header-info">
                <p>Kasir: <span id="loggedInUser">Admin</span></p>
                <p><a href="#" id="logoutBtn" style="color: white;">Logout</a></p>
            </div>
        </header>

        <main class="app-content">
            <section class="panel menu-panel">
                <h2 class="panel-title">
                    <span>Daftar Menu</span>
                    <span id="menuCount">(0 menu)</span>
                </h2>
                
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="menuSearch" class="search-input" placeholder="Cari menu...">
                </div>
                
                <div class="filter-row">
                    </div>
                
                <div class="menu-grid" id="menuGrid">
                    </div>

                <div id="adminPanel" class="admin-panel">
                    <h3 class="panel-title">Admin Panel</h3>
                    <div class="admin-grid">
                        <button id="addMenuBtn" class="btn btn-sm">Tambah Menu</button>
                        <button id="manageCategoriesBtn" class="btn btn-sm">Kelola Kategori</button>
                        <button id="viewReportsBtn" class="btn btn-sm">Laporan</button>
                        <button id="kitchenDisplayBtn" class="btn btn-sm">Info Pesanan</button>
                        <button id="manageMembersBtn" class="btn btn-sm">Kelola Member</button>
                        <button id="manageStoreInfoBtn" class="btn btn-sm">Info Restoran</button>
                        <button id="controlPanelBtn" class="btn btn-sm btn-warning">Kontrol Panel</button>
                    </div>
                    
                    <div class="mt-3">
                        <h4 class="panel-title">Backup & Restore</h4>
                        <div class="backup-actions">
                            <button id="backupDataBtn" class="btn btn-sm backup-btn">Backup Data</button>
                            <label for="restoreFile" class="file-label">
                                <i class="fas fa-upload"></i> Restore
                            </label>
                            <input type="file" id="restoreFile" class="file-input" accept=".json">
                        </div>
                        <button id="resetDataBtn" class="btn btn-sm btn-danger mt-2" style="width: 100%;">Reset Data</button>
                    </div>
                </div>
            </section>

            <section class="panel order-panel">
                <h2 class="panel-title">
                    <span>Pesanan</span>
                    <span id="orderCount">(0 item)</span>
                </h2>
                
                <div class="order-type">
                    <div class="order-type-btn active" data-type="dinein">Makan di Tempat</div>
                    <div class="order-type-btn" data-type="takeaway">Bungkus</div>
                </div>
                
                <div class="table-number" id="tableNumberContainer">
                    <label class="form-label">Nomor Meja</label>
                    <select id="tableNumber" class="form-control">
                        <option value="1">Meja 1</option>
                        <option value="2">Meja 2</option>
                        <option value="3">Meja 3</option>
                        <option value="4">Meja 4</option>
                        <option value="5">Meja 5</option>
                    </select>
                </div>

                <div class="member-search-container">
                    <label class="form-label">Cari Member (Opsional)</label>
                    <input type="text" id="memberSearch" class="form-control" placeholder="Nama atau ID member">
                    <div id="memberSearchResults" class="member-search-results"></div>
                </div>
                
                <div id="orderItemsContainer">
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Belum ada pesanan</p>
                    </div>
                </div>
                
                <div class="note-input">
                    <label class="form-label">Catatan Pesanan (Opsional)</label>
                    <textarea id="orderNote" placeholder="Contoh: Pedas, tanpa bawang, dll."></textarea>
                </div>
                
                <div class="summary-container">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Diskon:</span>
                        <span id="discount">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Pajak (10%):</span>
                        <span id="tax">Rp 0</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="total">Rp 0</span>
                    </div>
                </div>
                
                <button id="checkoutBtn" class="btn btn-success mt-3" disabled>
                    <i class="fas fa-credit-card"></i> Proses Pembayaran
                </button>
                <button id="clearOrderBtn" class="btn btn-outline-primary mt-2">
                    <i class="fas fa-trash"></i> Kosongkan Pesanan
                </button>
            </section>
        </main>

        <footer class="app-footer">
            <p>&copy; 2025 CAFE & RESTO - Aplikasi Kasir Digital</p>
        </footer>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="menuModalTitle">Tambah Menu</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <div class="form-group">
                        <label for="menuName" class="form-label">Nama Menu</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="menuPrice" class="form-label">Harga</label>
                        <input type="number" id="menuPrice" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="menuCategory" class="form-label">Kategori</label>
                        <select id="menuCategory" class="form-control" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="menuImage" class="form-label">Gambar Menu (URL)</label>
                        <input type="text" id="menuImage" class="form-control" placeholder="Opsional">
                    </div>
                    <div class="form-group">
                        <label for="menuDescription" class="form-label">Deskripsi</label>
                        <textarea id="menuDescription" class="form-control" placeholder="Opsional"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="menuStock" class="form-label">Stok</label>
                        <input type="number" id="menuStock" class="form-control" min="0" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelMenuBtn">Batal</button>
                <button class="btn" id="saveMenuBtn">Simpan</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-total-display">
                    <p>Total yang harus dibayar:</p>
                    <h3 id="paymentTotal">Rp 0</h3>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Tunai</option>
                        <option value="transfer">Transfer Bank</option>
                        <option value="qris">QRIS</option>
                        <option value="debit">Kartu Debit</option>
                        <option value="credit">Kartu Kredit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amountPaid" class="form-label">Jumlah Bayar</label>
                    <input type="number" id="amountPaid" class="form-control" min="0" required>
                </div>
                
                <div class="quick-cash-buttons">
                    <button class="btn btn-sm" data-amount="50000">50K</button>
                    <button class="btn btn-sm" data-amount="100000">100K</button>
                    <button class="btn btn-sm" data-amount="150000">150K</button>
                    <button class="btn btn-sm" data-amount="200000">200K</button>
                    <button class="btn btn-sm" data-amount="250000">250K</button>
                    <button class="btn btn-sm" data-amount="500000">500K</button>
                </div>
                
                <div class="form-group">
                    <label for="changeAmount" class="form-label">Kembalian</label>
                    <input type="text" id="changeAmount" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="paymentNote" class="form-label">Catatan Pembayaran (Opsional)</label>
                    <textarea id="paymentNote" class="form-control" placeholder="Catatan tambahan untuk pembayaran"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelPaymentBtn">Batal</button>
                <button class="btn btn-success" id="confirmPaymentBtn" disabled>Konfirmasi Pembayaran</button>
            </div>
        </div>
    </div>

    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Struk Pembayaran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receiptContent">
                    <div class="receipt-header">
                        <img class="receipt-logo" src="" alt="Logo">
                        <h2 class="receipt-title" id="receiptStoreName">CAFE & RESTO</h2>
                        <p id="receiptStoreAddress">Jl. Contoh No. 123, Kota Contoh</p>
                        <p id="receiptStorePhone">Telp: (021) 123-4567</p>
                    </div>
                    
                    <div class="receipt-info">
                        <div>
                            <span>No. Transaksi:</span>
                            <span id="receiptTransactionId">TRX-001</span>
                        </div>
                        <div>
                            <span>Tanggal:</span>
                            <span id="receiptDate">24/09/2025 14:30</span>
                        </div>
                        <div>
                            <span>Kasir:</span>
                            <span id="receiptCashier">Admin</span>
                        </div>
                        <div>
                            <span>Tipe:</span>
                            <span id="receiptOrderType">Makan di Tempat</span>
                        </div>
                        <div id="receiptTableNumberRow" style="display: none;">
                            <span>Meja:</span>
                            <span id="receiptTableNumber">-</span>
                        </div>
                        <div id="receiptMemberRow" style="display: none;">
                            <span>Member:</span>
                            <span id="receiptMember">-</span>
                        </div>
                    </div>
                    
                    <div id="receiptItemsContainer">
                        </div>
                    
                    <div class="receipt-total">
                        <div class="receipt-item">
                            <span>Subtotal:</span>
                            <span id="receiptSubtotal">Rp 0</span>
                        </div>
                        <div class="receipt-item">
                            <span>Diskon:</span>
                            <span id="receiptDiscount">Rp 0</span>
                        </div>
                        <div class="receipt-item">
                            <span>Pajak (10%):</span>
                            <span id="receiptTax">Rp 0</span>
                        </div>
                        <div class="receipt-item">
                            <span>Total:</span>
                            <span id="receiptTotal">Rp 0</span>
                        </div>
                        <div class="receipt-item">
                            <span>Bayar:</span>
                            <span id="receiptPaid">Rp 0</span>
                        </div>
                        <div class="receipt-item">
                            <span>Kembali:</span>
                            <span id="receiptChange">Rp 0</span>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        <p>Terima kasih atas kunjungan Anda</p>
                        <p>*** Selamat Menikmati ***</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeReceiptBtn">Tutup</button>
                <button class="btn btn-info" id="printReceiptBtn">
                    <i class="fas fa-print"></i> Cetak Struk
                </button>
            </div>
        </div>
    </div>

    <div id="ktaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kartu Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ktaCard">
                    <div class="kta-header">
                        <img class="kta-logo" src="" alt="Logo">
                        <div class="kta-store-info">
                            <h3 id="ktaStoreName">CAFE & RESTO</h3>
                            <p id="ktaStoreInfo">Member Loyalty Card</p>
                        </div>
                    </div>
                    <div class="kta-body">
                        <h2 id="ktaMemberName">Nama Member</h2>
                        <p id="ktaMemberId">ID: MEM-001</p>
                        <div class="kta-qrcode">
                            <img id="ktaQrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=MEM-001" alt="QR Code">
                        </div>
                    </div>
                    <div class="kta-footer">
                        <p>Kartu ini berlaku untuk mendapatkan promo dan diskon spesial</p>
                        <p>www.contohcafe.com</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeKtaBtn">Tutup</button>
                <button class="btn btn-info" id="printKtaBtn">
                    <i class="fas fa-print"></i> Cetak KTA
                </button>
            </div>
        </div>
    </div>

    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Laporan Penjualan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reportDate" class="form-label">Pilih Tanggal</label>
                    <input type="date" id="reportDate" class="form-control">
                </div>
                
                <div id="reportSummary">
                    <div class="summary-container">
                        <div class="summary-row">
                            <span>Total Transaksi:</span>
                            <span id="reportTransactionCount">0</span>
                        </div>
                        <div class="summary-row">
                            <span>Total Pendapatan:</span>
                            <span id="reportTotalRevenue">Rp 0</span>
                        </div>
                        <div class="summary-row">
                            <span>Rata-rata per Transaksi:</span>
                            <span id="reportAverageTransaction">Rp 0</span>
                        </div>
                    </div>
                </div>
                
                <div id="reportDetails" style="display: none;">
                    <h4 class="panel-title">Detail Transaksi</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Waktu</th>
                                    <th>Total</th>
                                    <th>Kasir</th>
                                </tr>
                            </thead>
                            <tbody id="reportTransactions">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeReportsBtn">Tutup</button>
                <button class="btn btn-info" id="generateReportBtn">Generate Laporan</button>
            </div>
        </div>
    </div>

    <div id="controlPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kontrol Panel</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="admin-grid">
                    <button class="btn btn-sm btn-warning" id="toggleAdminPanelBtn">Sembunyikan Panel Admin</button>
                    <button class="btn btn-sm btn-info" id="changePasswordBtn">Ganti Password</button>
                    <button class="btn btn-sm" id="viewTransactionsBtn">Lihat Semua Transaksi</button>
                    <button class="btn btn-sm" id="manageUsersBtn">Kelola Pengguna</button>
                    <button class="btn btn-sm" id="systemSettingsBtn">Pengaturan Sistem</button>
                    <button class="btn btn-sm btn-donation" id="donationBtn">Donasi</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeControlPanelBtn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="donationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Donasi</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Terima kasih telah menggunakan aplikasi ini. Jika Anda merasa terbantu, pertimbangkan untuk memberikan donasi untuk pengembangan lebih lanjut.</p>
                
                <div class="form-group">
                    <label class="form-label">Nominal Donasi</label>
                    <input type="number" id="donationAmount" class="form-control" min="1000" value="10000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Metode Pembayaran</label>
                    <select id="donationMethod" class="form-control">
                        <option value="qris">QRIS</option>
                        <option value="transfer">Transfer Bank</option>
                    </select>
                </div>
                
                <div id="donationQrCode" style="text-align: center; display: none;">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=DONATION-APP" alt="QR Code Donasi">
                    <p>Scan QR code di atas untuk donasi</p>
                </div>
                
                <div id="donationBankInfo" style="display: none;">
                    <p><strong>Bank: BCA</strong></p>
                    <p><strong>No. Rekening: 1234 5678 9012</strong></p>
                    <p><strong>Atas Nama: Developer App</strong></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeDonationBtn">Batal</button>
                <button class="btn btn-donation" id="confirmDonationBtn">Konfirmasi Donasi</button>
            </div>
        </div>
    </div>

    <div id="storeInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Informasi Restoran</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="storeInfoForm">
                    <div class="form-group">
                        <label for="storeName" class="form-label">Nama Restoran</label>
                        <input type="text" id="storeName" class="form-control" value="CAFE & RESTO">
                    </div>
                    <div class="form-group">
                        <label for="storeAddress" class="form-label">Alamat</label>
                        <textarea id="storeAddress" class="form-control">Jl. Contoh No. 123, Kota Contoh</textarea>
                    </div>
                    <div class="form-group">
                        <label for="storePhone" class="form-label">Telepon</label>
                        <input type="text" id="storePhone" class="form-control" value="(021) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="storeLogo" class="form-label">Logo (URL)</label>
                        <input type="text" id="storeLogo" class="form-control" placeholder="Masukkan URL gambar logo">
                        <small>Logo akan digunakan di struk, KTA, dan header aplikasi</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeStoreInfoBtn">Batal</button>
                <button class="btn" id="saveStoreInfoBtn">Simpan</button>
            </div>
        </div>
    </div>

    <div id="kitchenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Info Pesanan Dapur</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="kitchen-status">
                    <h4>Pesanan Selesai Hari Ini</h4>
                    <div id="kitchenOrders">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeKitchenBtn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="membersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <button class="btn btn-sm mb-3" id="addMemberBtn">Tambah Member</button>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nama</th>
                                <th>Telepon</th>
                                <th>Poin</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="membersTable">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeMembersBtn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="memberModalTitle">Tambah Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="memberForm">
                    <div class="form-group">
                        <label for="memberName" class="form-label">Nama Member</label>
                        <input type="text" id="memberName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="memberPhone" class="form-label">Telepon</label>
                        <input type="text" id="memberPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="memberEmail" class="form-label">Email</label>
                        <input type="email" id="memberEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="memberAddress" class="form-label">Alamat</label>
                        <textarea id="memberAddress" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="cancelMemberBtn">Batal</button>
                <button class="btn" id="saveMemberBtn">Simpan</button>
            </div>
        </div>
    </div>

    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Kelola Kategori</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName" class="form-label">Tambah Kategori Baru</label>
                    <div class="d-flex gap-2">
                        <input type="text" id="newCategoryName" class="form-control" placeholder="Nama kategori">
                        <button class="btn btn-sm" id="addCategoryBtn">Tambah</button>
                    </div>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nama Kategori</th>
                                <th>Jumlah Menu</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTable">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="closeCategoriesBtn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="print-container" style="display: none;"></div>

    <script>
        // === [REVISI] STRUKTUR DATA UTAMA ===
        // Struktur data default untuk memastikan aplikasi memiliki fondasi yang benar.
        const defaultAppData = {
            menus: [],
            transactions: [],
            members: [],
            categories: ['makanan', 'minuman', 'snack', 'lainnya'],
            storeInfo: {
                name: 'CAFE & RESTO',
                address: 'Jl. Contoh No. 123, Kota Contoh',
                phone: '(021) 123-4567',
                logo: ''
            },
            currentOrder: {
                items: [],
                type: 'dinein',
                tableNumber: '1',
                memberId: null,
                note: '',
                discount: 0
            },
            user: null,
            settings: {
                taxRate: 0.1,
                adminPassword: 'admin123' 
            }
        };

        // Variabel utama aplikasi, akan diisi dari localStorage atau data default.
        let appData = JSON.parse(JSON.stringify(defaultAppData));

        // === [REVISI & PERBAIKAN] FUNGSI INISIALISASI DATA YANG LEBIH AMAN ===
        // Fungsi ini bertanggung jawab untuk memuat data dari localStorage dengan aman.
        // Ini adalah perbaikan krusial untuk mencegah error saat data korup atau tidak lengkap.
        function initializeData() {
            const savedData = localStorage.getItem('cafeRestoData');
            
            if (savedData) {
                 try {
                    const parsedData = JSON.parse(savedData);
                    
                    // Memvalidasi dan menggabungkan setiap bagian data untuk memastikan tipe data benar.
                    appData.menus = Array.isArray(parsedData.menus) ? parsedData.menus : defaultAppData.menus;
                    appData.transactions = Array.isArray(parsedData.transactions) ? parsedData.transactions : defaultAppData.transactions;
                    appData.members = Array.isArray(parsedData.members) ? parsedData.members : defaultAppData.members;
                    appData.categories = Array.isArray(parsedData.categories) && parsedData.categories.length > 0 ? parsedData.categories : defaultAppData.categories;
                    
                    appData.storeInfo = { ...defaultAppData.storeInfo, ...(parsedData.storeInfo || {}) };
                    appData.settings = { ...defaultAppData.settings, ...(parsedData.settings || {}) };
                    appData.currentOrder = { ...defaultAppData.currentOrder, ...(parsedData.currentOrder || {}) };
                    appData.currentOrder.items = Array.isArray(appData.currentOrder.items) ? appData.currentOrder.items : [];
                    appData.currentOrder.discount = typeof appData.currentOrder.discount === 'number' ? appData.currentOrder.discount : 0;

                } catch (error) {
                    console.error("Gagal mem-parsing data dari localStorage, mereset ke data default:", error);
                    setupDefaultData();
                }
            } else {
                setupDefaultData();
            }
            
            saveData();
            updateLogoInApp();
            updateStoreInfoUI();
            renderCategoryFilters();
        }

        // Mengisi aplikasi dengan data contoh jika tidak ada data yang tersimpan.
        function setupDefaultData() {
            appData = JSON.parse(JSON.stringify(defaultAppData)); // Reset to default
             appData.menus = [
                { id: 1, name: 'Nasi Goreng Spesial', price: 25000, category: 'makanan', image: 'https://via.placeholder.com/100?text=Nasgor', description: 'Nasi goreng dengan telur, ayam, dan sayuran', stock: 10 },
                { id: 2, name: 'Mie Ayam', price: 20000, category: 'makanan', image: 'https://via.placeholder.com/100?text=MieAyam', description: 'Mie ayam dengan pangsit dan bakso', stock: 15 },
                { id: 3, name: 'Es Teh Manis', price: 5000, category: 'minuman', image: 'https://via.placeholder.com/100?text=EsTeh', description: 'Es teh manis segar', stock: 50 },
                { id: 4, name: 'Jus Jeruk', price: 12000, category: 'minuman', image: 'https://via.placeholder.com/100?text=JusJeruk', description: 'Jus jeruk segar tanpa gula', stock: 20 },
                { id: 5, name: 'Kentang Goreng', price: 15000, category: 'snack', image: 'https://via.placeholder.com/100?text=Kentang', description: 'Kentang goreng renyah dengan saus', stock: 25 },
                { id: 6, name: 'Donat', price: 8000, category: 'snack', image: 'https://via.placeholder.com/100?text=Donat', description: 'Donat dengan berbagai topping', stock: 30 }
            ];
            appData.members = [
                { id: 'MEM-001', name: 'Budi Santoso', phone: '081234567890', email: 'budi@email.com', address: 'Jl. Contoh No. 1', joinDate: new Date().toISOString(), points: 100 },
                { id: 'MEM-002', name: 'Siti Rahayu', phone: '081298765432', email: 'siti@email.com', address: 'Jl. Contoh No. 2', joinDate: new Date().toISOString(), points: 50 }
            ];
        }

        function saveData() {
            localStorage.setItem('cafeRestoData', JSON.stringify(appData));
        }

        // === FUNGSI UTAMA & PEMBARUAN UI ===

        function updateLogoInApp() {
            const logoUrl = appData.storeInfo.logo || 'https://via.placeholder.com/100?text=LOGO';
            document.querySelectorAll('.header-logo img, .receipt-logo, .kta-logo').forEach(img => {
                if (img) {
                    img.src = logoUrl;
                    img.alt = appData.storeInfo.name;
                }
            });
        }

        function updateStoreInfoUI() {
            document.getElementById('storeNameHeader').textContent = appData.storeInfo.name;
            document.getElementById('receiptStoreName').textContent = appData.storeInfo.name;
            document.getElementById('receiptStoreAddress').textContent = appData.storeInfo.address;
            document.getElementById('receiptStorePhone').textContent = `Telp: ${appData.storeInfo.phone}`;
            document.getElementById('ktaStoreName').textContent = appData.storeInfo.name;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // === [PENYEMPURNAAN] Membuat filter kategori dinamis ===
        function renderCategoryFilters() {
            const filterRow = document.querySelector('.filter-row');
            filterRow.innerHTML = '<div class="filter-chip active" data-category="all">Semua</div>'; // Selalu mulai dengan "Semua"
            
            appData.categories.forEach(category => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.dataset.category = category;
                chip.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                filterRow.appendChild(chip);
            });
            
            // Pasang ulang event listener untuk semua chip
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    if (document.querySelector('.filter-chip.active')) {
                        document.querySelector('.filter-chip.active').classList.remove('active');
                    }
                    this.classList.add('active');
                    renderMenus();
                });
            });
        }

        function renderMenus() {
            const menuGrid = document.getElementById('menuGrid');
            const menuCount = document.getElementById('menuCount');
            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const activeCategoryChip = document.querySelector('.filter-chip.active');
            const activeCategory = activeCategoryChip ? activeCategoryChip.dataset.category : 'all';
            
            let filteredMenus = appData.menus.filter(menu => {
                const matchesSearch = menu.name.toLowerCase().includes(searchTerm) || (menu.description && menu.description.toLowerCase().includes(searchTerm));
                const matchesCategory = activeCategory === 'all' || menu.category === activeCategory;
                return matchesSearch && matchesCategory;
            });
            
            menuGrid.innerHTML = '';
            
            if (filteredMenus.length === 0) {
                menuGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-utensils"></i><p>Tidak ada menu ditemukan</p></div>`;
            } else {
                filteredMenus.forEach(menu => {
                    const menuCard = document.createElement('div');
                    menuCard.className = 'menu-card';
                    menuCard.innerHTML = `
                        <div class="menu-image">
                            ${menu.image ? `<img src="${menu.image}" alt="${menu.name}">` : `<i class="fas fa-utensils"></i>`}
                        </div>
                        <div class="menu-name">${menu.name}</div>
                        <div class="menu-price">${formatRupiah(menu.price)}</div>
                        <div class="menu-category">${menu.category}</div>
                        <div class="menu-actions">
                            <div class="action-btn edit-btn" data-id="${menu.id}"><i class="fas fa-edit"></i></div>
                            <div class="action-btn delete-btn" data-id="${menu.id}"><i class="fas fa-trash"></i></div>
                        </div>
                    `;
                    menuCard.addEventListener('click', (e) => {
                        if (!e.target.closest('.menu-actions')) {
                            addToOrder(menu);
                        }
                    });
                    menuGrid.appendChild(menuCard);
                });
            }
            
            menuCount.textContent = `(${filteredMenus.length} menu)`;
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); editMenu(parseInt(btn.dataset.id)); });
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); deleteMenu(parseInt(btn.dataset.id)); });
            });
        }

        function addToOrder(menu) {
            const existingItem = appData.currentOrder.items.find(item => item.menuId === menu.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                appData.currentOrder.items.push({ menuId: menu.id, name: menu.name, price: menu.price, quantity: 1 });
            }
            renderOrder();
            showToast(`${menu.name} ditambahkan ke pesanan`, 'success');
        }

        function renderOrder() {
            const orderItemsContainer = document.getElementById('orderItemsContainer');
            const orderCount = document.getElementById('orderCount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (appData.currentOrder.items.length === 0) {
                orderItemsContainer.innerHTML = `<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Belum ada pesanan</p></div>`;
                checkoutBtn.disabled = true;
                orderCount.textContent = '(0 item)';
            } else {
                orderItemsContainer.innerHTML = '';
                appData.currentOrder.items.forEach((item, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div class="order-item-info">
                            <div class="order-item-name">${item.name}</div>
                            <div class="order-item-price">${formatRupiah(item.price)}</div>
                        </div>
                        <div class="order-item-qty">
                            <div class="qty-btn minus-btn" data-index="${index}"><i class="fas fa-minus"></i></div>
                            <input type="number" class="qty-input" value="${item.quantity}" min="1" data-index="${index}">
                            <div class="qty-btn plus-btn" data-index="${index}"><i class="fas fa-plus"></i></div>
                            <div class="remove-btn" data-index="${index}"><i class="fas fa-times"></i></div>
                        </div>
                    `;
                    orderItemsContainer.appendChild(orderItem);
                });
                checkoutBtn.disabled = false;
                orderCount.textContent = `(${appData.currentOrder.items.length} item)`;
            }
            updateOrderSummary();
        }

        function updateQuantity(index, change, newQuantity = null) {
            if (newQuantity !== null) {
                appData.currentOrder.items[index].quantity = newQuantity;
            } else {
                appData.currentOrder.items[index].quantity += change;
            }
            if (appData.currentOrder.items[index].quantity < 1) {
                appData.currentOrder.items[index].quantity = 1;
            }
            renderOrder();
        }

        function removeFromOrder(index) {
            const itemName = appData.currentOrder.items[index].name;
            appData.currentOrder.items.splice(index, 1);
            renderOrder();
            showToast(`${itemName} dihapus dari pesanan`, 'warning');
        }

        function updateOrderSummary() {
            const subtotal = appData.currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * appData.settings.taxRate;
            const total = subtotal + tax - appData.currentOrder.discount;
            document.getElementById('subtotal').textContent = formatRupiah(subtotal);
            document.getElementById('discount').textContent = formatRupiah(appData.currentOrder.discount);
            document.getElementById('tax').textContent = formatRupiah(tax);
            document.getElementById('total').textContent = formatRupiah(total);
        }

        function checkout() {
            if (appData.currentOrder.items.length === 0) return showToast('Tidak ada item dalam pesanan', 'error');
            const subtotal = appData.currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * appData.settings.taxRate;
            const total = subtotal + tax - appData.currentOrder.discount;
            document.getElementById('paymentTotal').textContent = formatRupiah(total);
            document.getElementById('amountPaid').value = '';
            document.getElementById('changeAmount').value = '';
            document.getElementById('confirmPaymentBtn').disabled = true;
            openModal('paymentModal');
            setTimeout(() => document.getElementById('amountPaid').focus(), 100);
        }

        function confirmPayment() {
            const amountPaid = parseFloat(document.getElementById('amountPaid').value);
            const subtotal = appData.currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * appData.settings.taxRate;
            const total = subtotal + tax - appData.currentOrder.discount;
            if (isNaN(amountPaid) || amountPaid < total) return showToast('Jumlah pembayaran kurang', 'error');
            
            const transaction = {
                id: generateId(), date: new Date().toISOString(), items: [...appData.currentOrder.items],
                subtotal, tax, discount: appData.currentOrder.discount, total, amountPaid,
                change: amountPaid - total, paymentMethod: document.getElementById('paymentMethod').value,
                paymentNote: document.getElementById('paymentNote').value, orderType: appData.currentOrder.type,
                tableNumber: appData.currentOrder.type === 'dinein' ? appData.currentOrder.tableNumber : null,
                memberId: appData.currentOrder.memberId, note: appData.currentOrder.note, cashier: appData.user.username
            };
            appData.transactions.unshift(transaction);
            
            appData.currentOrder.items.forEach(item => {
                const menu = appData.menus.find(m => m.id === item.menuId);
                if (menu) menu.stock = Math.max(0, menu.stock - item.quantity);
            });
            
            if (appData.currentOrder.memberId) {
                const member = appData.members.find(m => m.id === appData.currentOrder.memberId);
                if (member) member.points += Math.floor(total / 10000);
            }
            
            saveData();
            showReceipt(transaction);
            resetOrder();
            closeModal('paymentModal');
        }

        function showReceipt(transaction) {
            document.getElementById('receiptTransactionId').textContent = transaction.id.slice(-8).toUpperCase();
            document.getElementById('receiptDate').textContent = new Date(transaction.date).toLocaleString('id-ID');
            document.getElementById('receiptCashier').textContent = transaction.cashier;
            document.getElementById('receiptOrderType').textContent = transaction.orderType === 'dinein' ? 'Makan di Tempat' : 'Bungkus';
            
            const tableRow = document.getElementById('receiptTableNumberRow');
            if (transaction.orderType === 'dinein' && transaction.tableNumber) {
                tableRow.style.display = 'flex';
                document.getElementById('receiptTableNumber').textContent = `Meja ${transaction.tableNumber}`;
            } else {
                tableRow.style.display = 'none';
            }
            
            const memberRow = document.getElementById('receiptMemberRow');
            if (transaction.memberId) {
                const member = appData.members.find(m => m.id === transaction.memberId);
                memberRow.style.display = 'flex';
                document.getElementById('receiptMember').textContent = member ? member.name : 'Tidak Diketahui';
            } else {
                memberRow.style.display = 'none';
            }
            
            const receiptItemsContainer = document.getElementById('receiptItemsContainer');
            receiptItemsContainer.innerHTML = '';
            transaction.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'receipt-item';
                itemElement.innerHTML = `<div class="receipt-item-details"><span class="item-name">${item.name}</span><div class="item-price-calc">${item.quantity} x ${formatRupiah(item.price)}</div></div><span>${formatRupiah(item.price * item.quantity)}</span>`;
                receiptItemsContainer.appendChild(itemElement);
            });
            
            document.getElementById('receiptSubtotal').textContent = formatRupiah(transaction.subtotal);
            document.getElementById('receiptDiscount').textContent = formatRupiah(transaction.discount);
            document.getElementById('receiptTax').textContent = formatRupiah(transaction.tax);
            document.getElementById('receiptTotal').textContent = formatRupiah(transaction.total);
            document.getElementById('receiptPaid').textContent = formatRupiah(transaction.amountPaid);
            document.getElementById('receiptChange').textContent = formatRupiah(transaction.change);
            
            openModal('receiptModal');
        }

        function resetOrder() {
            appData.currentOrder = JSON.parse(JSON.stringify(defaultAppData.currentOrder));
            document.querySelector('.order-type-btn[data-type="dinein"]').click();
            document.getElementById('tableNumber').value = '1';
            document.getElementById('memberSearch').value = '';
            document.getElementById('orderNote').value = '';
            renderOrder();
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function printWithContainer(elementId) {
            const content = document.getElementById(elementId).cloneNode(true);
            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = '';
            printContainer.appendChild(content);
            window.print();
        }
        function printReceipt() { printWithContainer('receiptContent'); }
        function printKta() { printWithContainer('ktaCard'); }

        function populateCategoryDropdown() {
            const select = document.getElementById('menuCategory');
            select.innerHTML = '';
            appData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                select.appendChild(option);
            });
        }

        function addMenu() {
            document.getElementById('menuModalTitle').textContent = 'Tambah Menu';
            document.getElementById('menuForm').reset();
            populateCategoryDropdown();
            const saveBtn = document.getElementById('saveMenuBtn');
            saveBtn.dataset.mode = 'add';
            delete saveBtn.dataset.menuId;
            openModal('menuModal');
            setTimeout(() => document.getElementById('menuName').focus(), 100);
        }

        function editMenu(menuId) {
            const menu = appData.menus.find(m => m.id === menuId);
            if (menu) {
                document.getElementById('menuModalTitle').textContent = 'Edit Menu';
                populateCategoryDropdown();
                document.getElementById('menuName').value = menu.name;
                document.getElementById('menuPrice').value = menu.price;
                document.getElementById('menuCategory').value = menu.category;
                document.getElementById('menuImage').value = menu.image || '';
                document.getElementById('menuDescription').value = menu.description || '';
                document.getElementById('menuStock').value = menu.stock || 0;
                const saveBtn = document.getElementById('saveMenuBtn');
                saveBtn.dataset.mode = 'edit';
                saveBtn.dataset.menuId = menuId;
                openModal('menuModal');
                setTimeout(() => document.getElementById('menuName').focus(), 100);
            }
        }

        function deleteMenu(menuId) {
            if (confirm('Apakah Anda yakin ingin menghapus menu ini?')) {
                appData.menus = appData.menus.filter(m => m.id !== menuId);
                saveData();
                renderMenus();
                showToast('Menu berhasil dihapus', 'success');
            }
        }

        function saveMenu() {
            const mode = document.getElementById('saveMenuBtn').dataset.mode;
            const name = document.getElementById('menuName').value.trim();
            const price = parseInt(document.getElementById('menuPrice').value);
            if (!name || isNaN(price)) return showToast('Nama dan harga menu harus diisi dengan benar', 'error');
            const menuData = {
                name, price,
                category: document.getElementById('menuCategory').value,
                image: document.getElementById('menuImage').value.trim(),
                description: document.getElementById('menuDescription').value.trim(),
                stock: parseInt(document.getElementById('menuStock').value) || 0
            };
            if (mode === 'add') {
                menuData.id = appData.menus.length > 0 ? Math.max(...appData.menus.map(m => m.id)) + 1 : 1;
                appData.menus.push(menuData);
                showToast('Menu berhasil ditambahkan', 'success');
            } else {
                const menuId = parseInt(document.getElementById('saveMenuBtn').dataset.menuId);
                const menuIndex = appData.menus.findIndex(m => m.id === menuId);
                if (menuIndex !== -1) {
                    appData.menus[menuIndex] = { ...appData.menus[menuIndex], ...menuData };
                    showToast('Menu berhasil diperbarui', 'success');
                }
            }
            saveData();
            renderMenus();
            closeModal('menuModal');
        }

        function manageCategories() {
            const categoriesTable = document.getElementById('categoriesTable');
            categoriesTable.innerHTML = '';
            appData.categories.forEach(category => {
                const menuCount = appData.menus.filter(m => m.category === category).length;
                const row = document.createElement('tr');
                row.innerHTML = `<td>${category.charAt(0).toUpperCase() + category.slice(1)}</td><td>${menuCount} menu</td><td><button class="action-btn delete-btn" data-category="${category}"><i class="fas fa-trash"></i></button></td>`;
                categoriesTable.appendChild(row);
            });
            openModal('categoriesModal');
        }

        function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim().toLowerCase();
            if (!categoryName) return showToast('Nama kategori harus diisi', 'error');
            if (appData.categories.includes(categoryName)) return showToast('Kategori sudah ada', 'error');
            appData.categories.push(categoryName);
            document.getElementById('newCategoryName').value = '';
            saveData();
            manageCategories();
            renderCategoryFilters(); // [REVISI] Update filter di halaman utama
            showToast('Kategori berhasil ditambahkan', 'success');
        }

        function deleteCategory(categoryName) {
            const menuCount = appData.menus.filter(m => m.category === categoryName).length;
            if (menuCount > 0) return showToast(`Tidak dapat menghapus kategori yang masih memiliki menu`, 'error');
            if (confirm(`Apakah Anda yakin ingin menghapus kategori "${categoryName}"?`)) {
                appData.categories = appData.categories.filter(c => c !== categoryName);
                saveData();
                manageCategories();
                renderCategoryFilters(); // [REVISI] Update filter di halaman utama
                showToast('Kategori berhasil dihapus', 'success');
            }
        }

        function manageMembers() {
            const membersTable = document.getElementById('membersTable');
            membersTable.innerHTML = '';
            appData.members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${member.id}</td><td>${member.name}</td><td>${member.phone || '-'}</td><td>${member.points || 0}</td><td class="d-flex gap-2"><button class="action-btn edit-btn" data-member-id="${member.id}" title="Edit Member"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" data-member-id="${member.id}" title="Hapus Member"><i class="fas fa-trash"></i></button><button class="action-btn" style="background-color: var(--primary);" data-member-id="${member.id}" title="Cetak KTA"><i class="fas fa-id-card"></i></button></td>`;
                membersTable.appendChild(row);
            });
            openModal('membersModal');
        }

        function addMember() {
            document.getElementById('memberModalTitle').textContent = 'Tambah Member';
            document.getElementById('memberForm').reset();
            const saveBtn = document.getElementById('saveMemberBtn');
            saveBtn.dataset.mode = 'add';
            delete saveBtn.dataset.memberId;
            openModal('memberModal');
        }

        function saveMember() {
            const name = document.getElementById('memberName').value.trim();
            if (!name) return showToast('Nama member harus diisi', 'error');
            const newMember = {
                id: 'MEM-' + (appData.members.length > 0 ? Math.max(...appData.members.map(m => parseInt(m.id.split('-')[1]))) + 1 : 1).toString().padStart(3, '0'),
                name, phone: document.getElementById('memberPhone').value.trim(),
                email: document.getElementById('memberEmail').value.trim(), address: document.getElementById('memberAddress').value.trim(),
                joinDate: new Date().toISOString(), points: 0
            };
            appData.members.push(newMember);
            saveData();
            manageMembers();
            closeModal('memberModal');
            showToast('Member berhasil ditambahkan', 'success');
        }

        function showKta(memberId) {
            const member = appData.members.find(m => m.id === memberId);
            if (member) {
                document.getElementById('ktaMemberName').textContent = member.name;
                document.getElementById('ktaMemberId').textContent = `ID: ${member.id}`;
                document.getElementById('ktaQrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${member.id}`;
                openModal('ktaModal');
            }
        }

        function manageStoreInfo() {
            document.getElementById('storeName').value = appData.storeInfo.name;
            document.getElementById('storeAddress').value = appData.storeInfo.address;
            document.getElementById('storePhone').value = appData.storeInfo.phone;
            document.getElementById('storeLogo').value = appData.storeInfo.logo;
            openModal('storeInfoModal');
        }

        function saveStoreInfo() {
            appData.storeInfo.name = document.getElementById('storeName').value;
            appData.storeInfo.address = document.getElementById('storeAddress').value;
            appData.storeInfo.phone = document.getElementById('storePhone').value;
            appData.storeInfo.logo = document.getElementById('storeLogo').value;
            saveData();
            updateStoreInfoUI();
            updateLogoInApp();
            closeModal('storeInfoModal');
            showToast('Informasi restoran berhasil diperbarui', 'success');
        }

        function backupData() {
            const dataStr = JSON.stringify(appData);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `backup-cafe-resto-${new Date().toISOString().split('T')[0]}.json`);
            linkElement.click();
            showToast('Backup data berhasil diunduh', 'success');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    // Lakukan validasi sederhana untuk memastikan ini file yang benar
                    if (restoredData.menus && restoredData.settings && restoredData.storeInfo) {
                        localStorage.setItem('cafeRestoData', e.target.result);
                        showToast('Data berhasil dipulihkan. Aplikasi akan dimuat ulang.', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('File backup tidak valid.', 'error');
                    }
                } catch (error) {
                    showToast('Gagal memulihkan data. File mungkin rusak.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input file
        }

        function resetData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan!')) {
                localStorage.removeItem('cafeRestoData');
                showToast('Data berhasil direset. Aplikasi akan dimuat ulang.', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        function login(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('username');
            const username = usernameInput.value.trim();
            
            if (!username) {
                showToast('Nama kasir tidak boleh kosong!', 'error');
                usernameInput.focus();
                return;
            }
            
            appData.user = { username: username, role: 'admin' };
            
            document.getElementById('loggedInUser').textContent = username;
            closeModal('loginModal');
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('id-ID', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            showToast(`Selamat datang, ${username}!`, 'success');
            document.getElementById('adminPanel').style.display = 'block';
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                appData.user = null;
                openModal('loginModal');
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        // === EVENT LISTENERS ===
        // Event listener utama yang dijalankan setelah halaman selesai dimuat.
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            renderMenus();
            renderOrder();
            
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('menuSearch').addEventListener('input', renderMenus);
            
            document.querySelectorAll('.order-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.order-type-btn.active').classList.remove('active');
                    this.classList.add('active');
                    appData.currentOrder.type = this.dataset.type;
                    document.getElementById('tableNumberContainer').style.display = (this.dataset.type === 'dinein') ? 'block' : 'none';
                });
            });

            document.getElementById('tableNumber').addEventListener('change', function() { appData.currentOrder.tableNumber = this.value; });
            document.getElementById('orderNote').addEventListener('input', function() { appData.currentOrder.note = this.value; });
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
            document.getElementById('clearOrderBtn').addEventListener('click', () => {
                if (appData.currentOrder.items.length > 0 && confirm('Apakah Anda yakin ingin mengosongkan pesanan?')) {
                    resetOrder();
                    showToast('Pesanan dikosongkan', 'warning');
                }
            });
            
            document.getElementById('addMenuBtn').addEventListener('click', addMenu);
            document.getElementById('saveMenuBtn').addEventListener('click', saveMenu);
            document.getElementById('cancelMenuBtn').addEventListener('click', () => closeModal('menuModal'));
            
            document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
            document.getElementById('cancelPaymentBtn').addEventListener('click', () => closeModal('paymentModal'));
            
            // [PERBAIKAN] Menggunakan state aplikasi untuk kalkulasi, bukan dari teks di UI
            document.getElementById('amountPaid').addEventListener('input', function() {
                const amountPaid = parseFloat(this.value) || 0;
                
                const subtotal = appData.currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * appData.settings.taxRate;
                const total = subtotal + tax - appData.currentOrder.discount;

                const change = amountPaid - total;
                document.getElementById('changeAmount').value = formatRupiah(change >= 0 ? change : 0);
                document.getElementById('confirmPaymentBtn').disabled = amountPaid < total;
            });

            document.querySelectorAll('.quick-cash-buttons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amountPaidInput = document.getElementById('amountPaid');
                    amountPaidInput.value = this.dataset.amount;
                    amountPaidInput.dispatchEvent(new Event('input'));
                });
            });

            document.getElementById('closeReceiptBtn').addEventListener('click', () => closeModal('receiptModal'));
            document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);
            document.getElementById('closeKtaBtn').addEventListener('click', () => closeModal('ktaModal'));
            document.getElementById('printKtaBtn').addEventListener('click', printKta);
            
            document.getElementById('manageCategoriesBtn').addEventListener('click', manageCategories);
            document.getElementById('viewReportsBtn').addEventListener('click', () => openModal('reportsModal'));
            document.getElementById('manageMembersBtn').addEventListener('click', manageMembers);
            document.getElementById('manageStoreInfoBtn').addEventListener('click', manageStoreInfo);
            document.getElementById('controlPanelBtn').addEventListener('click', () => openModal('controlPanelModal'));
            
            document.getElementById('backupDataBtn').addEventListener('click', backupData);
            document.getElementById('restoreFile').addEventListener('change', restoreData);
            document.getElementById('resetDataBtn').addEventListener('click', resetData);
            
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            document.getElementById('closeCategoriesBtn').addEventListener('click', () => closeModal('categoriesModal'));
            
            document.getElementById('addMemberBtn').addEventListener('click', addMember);
            document.getElementById('saveMemberBtn').addEventListener('click', saveMember);
            document.getElementById('cancelMemberBtn').addEventListener('click', () => closeModal('memberModal'));
            document.getElementById('closeMembersBtn').addEventListener('click', () => closeModal('membersModal'));
            
            document.getElementById('saveStoreInfoBtn').addEventListener('click', saveStoreInfo);
            document.getElementById('closeStoreInfoBtn').addEventListener('click', () => closeModal('storeInfoModal'));
            
            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', function() { closeModal(this.closest('.modal').id); }));
            window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) closeModal(event.target.id); });

            document.getElementById('orderItemsContainer').addEventListener('click', (e) => {
                const target = e.target.closest('.qty-btn, .remove-btn');
                if (!target) return;
                const index = parseInt(target.parentElement.querySelector('.qty-input, .remove-btn').dataset.index);
                if (target.classList.contains('minus-btn')) updateQuantity(index, -1);
                else if (target.classList.contains('plus-btn')) updateQuantity(index, 1);
                else if (target.classList.contains('remove-btn')) removeFromOrder(index);
            });
             document.getElementById('orderItemsContainer').addEventListener('change', (e) => {
                if(e.target.classList.contains('qty-input')){
                    const index = parseInt(e.target.dataset.index);
                    const newQty = parseInt(e.target.value);
                    if (newQty < 1) e.target.value = 1;
                    updateQuantity(index, 0, newQty < 1 ? 1 : newQty);
                }
            });

            document.getElementById('membersTable').addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const memberId = target.dataset.memberId;
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Apakah Anda yakin ingin menghapus member ini?')) {
                        appData.members = appData.members.filter(m => m.id !== memberId);
                        saveData();
                        manageMembers();
                        showToast('Member berhasil dihapus', 'success');
                    }
                } else if (target.classList.contains('edit-btn')) {
                    showToast('Fitur edit member akan segera tersedia', 'info');
                } else {
                    showKta(memberId);
                }
            });
            
            document.getElementById('categoriesTable').addEventListener('click', function(e) {
                const target = e.target.closest('button.delete-btn');
                if (target) deleteCategory(target.dataset.category);
            });
            
            document.getElementById('memberSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const resultsContainer = document.getElementById('memberSearchResults');
                if (searchTerm.length < 2) {
                    resultsContainer.style.display = 'none';
                    // [PERBAIKAN] Hapus member terpilih jika input dikosongkan
                    if (appData.currentOrder.memberId) {
                        appData.currentOrder.memberId = null;
                        updateOrderSummary();
                    }
                    return;
                }
                const results = appData.members.filter(m => m.name.toLowerCase().includes(searchTerm) || m.id.toLowerCase().includes(searchTerm));
                resultsContainer.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(member => {
                        const item = document.createElement('div');
                        item.className = 'member-search-item';
                        item.textContent = `${member.name} (${member.id})`;
                        item.onclick = () => {
                            this.value = `${member.name} (${member.id})`;
                            appData.currentOrder.memberId = member.id;
                            resultsContainer.style.display = 'none';
                            updateOrderSummary();
                        };
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                     resultsContainer.style.display = 'none';
                }
            });
            
            document.addEventListener('click', (e) => { if (!e.target.closest('.member-search-container')) document.getElementById('memberSearchResults').style.display = 'none'; });
            
            document.getElementById('toggleAdminPanelBtn').addEventListener('click', function() {
                const adminPanel = document.getElementById('adminPanel');
                const isHidden = adminPanel.style.display === 'none';
                adminPanel.style.display = isHidden ? 'block' : 'none';
                this.textContent = isHidden ? 'Sembunyikan Panel Admin' : 'Tampilkan Panel Admin';
            });
            
            document.getElementById('kitchenDisplayBtn').addEventListener('click', function() {
                const kitchenOrders = document.getElementById('kitchenOrders');
                kitchenOrders.innerHTML = '';
                const today = new Date().toISOString().split('T')[0];
                const todayTransactions = appData.transactions.filter(t => t.date.startsWith(today));
                if (todayTransactions.length === 0) {
                    kitchenOrders.innerHTML = '<p class="text-center">Belum ada pesanan yang selesai hari ini.</p>';
                } else {
                    todayTransactions.forEach(t => {
                        const item = document.createElement('div');
                        item.className = 'status-item';
                        item.innerHTML = `<div><strong>#${t.id.slice(-8).toUpperCase()}</strong><br><small>${t.orderType === 'dinein' ? 'Meja ' + t.tableNumber : 'Bungkus'} - ${new Date(t.date).toLocaleTimeString()}</small></div><div class="status-ready">Selesai</div>`;
                        kitchenOrders.appendChild(item);
                    });
                }
                openModal('kitchenModal');
            });
            
            document.getElementById('closeKitchenBtn').addEventListener('click', () => closeModal('kitchenModal'));
            
            document.getElementById('donationBtn').addEventListener('click', () => openModal('donationModal'));
            document.getElementById('donationMethod').addEventListener('change', function() {
                document.getElementById('donationQrCode').style.display = this.value === 'qris' ? 'block' : 'none';
                document.getElementById('donationBankInfo').style.display = this.value === 'transfer' ? 'block' : 'none';
            });
            document.getElementById('confirmDonationBtn').addEventListener('click', () => {
                showToast(`Terima kasih atas donasi Anda!`, 'success');
                closeModal('donationModal');
            });
            document.getElementById('closeDonationBtn').addEventListener('click', () => closeModal('donationModal'));
            document.getElementById('closeControlPanelBtn').addEventListener('click', () => closeModal('controlPanelModal'));
            
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const reportDate = document.getElementById('reportDate').value;
                if (!reportDate) return showToast('Pilih tanggal terlebih dahulu', 'error');
                const filtered = appData.transactions.filter(t => t.date.startsWith(reportDate));
                const totalRevenue = filtered.reduce((sum, t) => sum + t.total, 0);
                document.getElementById('reportTransactionCount').textContent = filtered.length;
                document.getElementById('reportTotalRevenue').textContent = formatRupiah(totalRevenue);
                document.getElementById('reportAverageTransaction').textContent = formatRupiah(filtered.length > 0 ? totalRevenue / filtered.length : 0);
                const tableBody = document.getElementById('reportTransactions');
                tableBody.innerHTML = '';
                filtered.forEach((t, i) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${i + 1}</td><td>${new Date(t.date).toLocaleTimeString('id-ID')}</td><td>${formatRupiah(t.total)}</td><td>${t.cashier}</td>`;
                });
                document.getElementById('reportDetails').style.display = 'block';
            });
            
            document.getElementById('closeReportsBtn').addEventListener('click', () => closeModal('reportsModal'));
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>
