<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM MANAJEMEN KARCIS WISATA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --wisata-primary: #00695c; /* Teal */
            --wisata-secondary: #f9a825; /* Yellow */
            --wisata-accent: #4caf50; /* Green */
            --wisata-light: #e0f2f1; /* Light Teal */
            --wisata-dark: #37474f; /* Blue Grey */
            --wisata-gradient: linear-gradient(135deg, var(--wisata-primary), var(--wisata-accent));
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 28px rgba(0,0,0,0.15);
        }
        
        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #e0f7fa 100%);
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 10px 0;
            overflow-x: hidden;
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 15px;
        }

        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: var(--shadow-lg); width: 100%; max-width: 400px; text-align: center;
        }
        
        .login-box .developer-info {
            font-size: 0.8rem; color: #6c757d; margin-top: 25px;
        }
        .login-box .developer-info a {
            color: var(--wisata-primary); text-decoration: none;
        }
        .login-box .developer-info a:hover { text-decoration: underline; }
        .login-box .app-logo { font-size: 3rem; color: var(--wisata-primary); margin-bottom: 15px; }
        .login-box h2 { margin-bottom: 25px; color: var(--wisata-dark); font-weight: 700; }
        
        .app-container {
            max-width: 1600px; margin: 0 auto; background: white;
            box-shadow: var(--shadow-lg); border-radius: 12px;
            overflow: hidden; position: relative; z-index: 10;
        }
        
        .app-header {
            background: var(--wisata-gradient); color: white; padding: 20px 15px;
            text-align: center; position: relative; overflow: hidden;
        }
        
        .app-header::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .app-logo { font-size: 2.5rem; margin-bottom: 10px; position: relative; z-index: 1; }
        .app-title {
            font-size: 1.8rem; font-weight: 800; margin: 0; position: relative; z-index: 1;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
        }
        .app-subtitle {
            font-size: 1rem; opacity: 0.95; position: relative; z-index: 1;
            font-weight: 300; letter-spacing: 0.5px; margin-bottom: 5px;
        }
        
        .nav-pills .nav-link {
            border-radius: 8px; margin-bottom: 8px; padding: 12px 15px; font-weight: 500;
            color: #444; transition: all 0.3s ease; display: flex; align-items: center; font-size: 0.9rem;
        }
        .nav-pills .nav-link:hover { background-color: #f1f8e9; transform: translateX(3px); }
        .nav-pills .nav-link.active {
            background: var(--wisata-gradient); font-weight: 600; box-shadow: var(--shadow-md);
            transform: translateX(3px); color: white;
        }
        
        .section-title {
            border-left: 4px solid var(--wisata-primary); padding-left: 12px; margin: 20px 0;
            font-weight: 700; color: var(--wisata-dark); font-size: 1.4rem; position: relative;
        }
        .section-title::after {
            content: ""; position: absolute; bottom: -5px; left: 12px; width: 40px; height: 2px;
            background: var(--wisata-gradient); border-radius: 2px;
        }
        
        .btn-primary {
            background: var(--wisata-gradient); border: none; padding: 10px 20px; font-weight: 600;
            box-shadow: var(--shadow-md); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        
        .form-label { font-weight: 600; color: #444; margin-bottom: 8px; display: flex; align-items: center; font-size: 0.9rem; }
        .form-label i { margin-right: 6px; color: var(--wisata-primary); }
        .form-control, .form-select {
            border-radius: 8px; padding: 12px 15px; border: 1px solid #ddd;
            transition: all 0.3s; box-shadow: var(--shadow-sm); font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--wisata-primary); box-shadow: 0 0 0 3px rgba(0, 105, 92, 0.2);
            transform: translateY(-2px);
        }
        
        .copyright {
            text-align: center; padding: 20px; background-color: var(--wisata-light);
            color: var(--wisata-dark); font-size: 0.9rem; font-weight: 500; line-height: 1.6;
        }
        .copyright a { color: var(--wisata-primary); text-decoration: none; font-weight: 600; }
        .copyright a:hover { text-decoration: underline; }
        
        .data-table th { background: var(--wisata-gradient); color: white; }
        
        .stats-box .stats-number { color: var(--wisata-primary); }
        .card-header { background: var(--wisata-gradient); color: white; }
        
        /* Styles from original file, slightly adapted for new theme */
        .data-table { font-size: 0.85rem; border-collapse: separate; border-spacing: 0; box-shadow: var(--shadow-sm); border-radius: 8px; overflow: hidden; }
        .data-table th { font-weight: 600; padding: 12px 10px; text-align: center; position: relative; font-size: 0.85rem; }
        .data-table td { padding: 10px 8px; vertical-align: middle; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .data-table tr:hover { background-color: #f1f8e9; }
        .feature-icon { font-size: 1.1rem; margin-right: 8px; width: 24px; text-align: center; }
        .card { border-radius: 10px; border: none; box-shadow: var(--shadow-md); transition: all 0.3s ease; overflow: hidden; margin-bottom: 15px; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .stats-box { text-align: center; padding: 20px 15px; border-radius: 10px; background: white; box-shadow: var(--shadow-md); transition: all 0.3s; position: relative; overflow: hidden; }
        .stats-box::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--wisata-gradient); border-radius: 2px; }
        .stats-box:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stats-number { font-size: 1.8rem; font-weight: 800; margin: 10px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .stats-label { font-size: 0.9rem; color: #666; font-weight: 500; }
        .error-message { color: #dc3545; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: 500; }

        /* Ticket status indicators */
        .ticket-status { display: inline-block; padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.75rem; font-weight: bold; }
        .status-available { background-color: #28a745; } /* Green */
        .status-sold { background-color: #17a2b8; } /* Cyan */
        .status-used { background-color: #673ab7; } /* Deep Purple */
        .status-expired { background-color: #f44336; } /* Red */

        /* Struk/Receipt styles */
        .receipt-container { background: white; padding: 30px; border-radius: 10px; box-shadow: var(--shadow-md); position: relative; overflow: hidden; }
        .receipt-header { border-bottom: 2px solid var(--wisata-primary); padding-bottom: 20px; margin-bottom: 30px; }
        .receipt-logo-img { max-height: 60px; margin-bottom: 10px; }
        .receipt-table th { background: var(--wisata-primary); color: white; }
        .receipt-footer { border-top: 2px solid var(--wisata-primary); padding-top: 20px; margin-top: 30px; font-style: italic; color: #6c757d; }

        /* Karcis Print Styles */
        .ticket-print-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5mm;
            width: 210mm;
            height: 297mm;
            padding: 10mm;
            box-sizing: border-box;
        }
        .ticket-mini {
            border: 1px dashed #333;
            padding: 5mm;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
            height: 53.4mm; /* (297 - 20) / 5 - 5 */
        }
        .ticket-mini h5 { font-size: 10pt; font-weight: bold; margin-bottom: 4px; }
        .ticket-mini p { font-size: 8pt; margin: 2px 0; }
        .ticket-mini .ticket-code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 11pt;
            font-weight: bold;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
            letter-spacing: 1px;
            margin-top: 8px;
        }
        .ticket-mini .ticket-footer { font-size: 7pt; margin-top: 5px; }

        @media print {
            body, html { background: #fff !important; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 4mm !important; margin: 0 !important; box-shadow: none !important; border: none !important; }
            
            /* Print style for 10 tickets on A4 */
            @page {
                size: A4;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-box animate-fadeIn">
            <div class="app-logo"><i class="fas fa-ticket-alt"></i></div>
            <h2>Sistem Manajemen Karcis Wisata</h2>
            <form id="loginForm">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="petugasName" placeholder="Nama Petugas" required>
                    <label for="petugasName">Nama Petugas</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" placeholder="Username" required>
                    <label for="username">Username</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Password" required>
                    <label for="password">Password</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg">Login</button>
                <div id="loginError" class="error-message mt-3" style="display: none;"></div>
            </form>
            <div class="developer-info">
                Developed by <strong>Lentera Karya Situbondo</strong><br>
                <a href="https://wa.me/6287865614222" target="_blank">WhatsApp: 087865614222</a> | 
                <a href="http://www.anekamarket.my.id" target="_blank">www.anekamarket.my.id</a><br>
                &copy; Hak Cipta Sejak 2025
            </div>
        </div>
    </div>

    <main id="mainApp" style="display: none;">
        <div class="app-container">
            <div class="app-header no-print">
                <div class="app-logo"><i class="fas fa-mountain"></i></div>
                <h1 class="app-title">SISTEM MANAJEMEN KARCIS WISATA</h1>
                <p class="app-subtitle">Solusi Terpadu untuk Pengelolaan Tiket Tempat Wisata</p>
            </div>
            
            <div class="row g-0">
                <div class="col-md-3 col-lg-2 bg-light p-3 no-print" id="sidebar">
                    <ul class="nav nav-pills flex-column" id="myTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard"><i class="fas fa-tachometer-alt feature-icon"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" id="transaction-tab" data-bs-toggle="tab" href="#transaction"><i class="fas fa-cash-register feature-icon"></i>Transaksi Penjualan</a></li>
                        <li class="nav-item"><a class="nav-link" id="validation-tab" data-bs-toggle="tab" href="#validation"><i class="fas fa-check-circle feature-icon"></i>Validasi Karcis</a></li>
                        <li class="nav-item"><a class="nav-link" id="receipt-tab" data-bs-toggle="tab" href="#receipt"><i class="fas fa-receipt feature-icon"></i>Kasir & Struk</a></li>
                        <li class="nav-item"><a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history"><i class="fas fa-history feature-icon"></i>Histori Transaksi</a></li>
                        <li class="nav-item"><a class="nav-link" id="ticket-management-tab" data-bs-toggle="tab" href="#ticket-management"><i class="fas fa-ticket-alt feature-icon"></i>Manajemen Karcis</a></li>
                        <li class="nav-item"><a class="nav-link" id="customer-tab" data-bs-toggle="tab" href="#customer"><i class="fas fa-users feature-icon"></i>Data Pelanggan</a></li>
                        <li class="nav-item"><a class="nav-link" id="report-tab" data-bs-toggle="tab" href="#report"><i class="fas fa-chart-bar feature-icon"></i>Laporan</a></li>
                        <li class="nav-item"><a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings"><i class="fas fa-cog feature-icon"></i>Pengaturan</a></li>
                    </ul>
                </div>
                
                <div class="col-md-9 col-lg-10 p-4">
                    <div class="tab-content" id="myTabContent">
                        
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                            <h3 class="section-title">Dashboard</h3>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-users text-primary fa-2x"></i><div class="stats-number" id="totalVisitorsToday">0</div><div class="stats-label">Pengunjung Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-ticket-alt text-success fa-2x"></i><div class="stats-number" id="ticketsSoldCount">0</div><div class="stats-label">Karcis Terjual Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-wallet text-warning fa-2x"></i><div class="stats-number" id="todayRevenue">0</div><div class="stats-label">Pendapatan Hari Ini</div></div></div>
                                <div class="col-lg-3 col-md-6 mb-4"><div class="stats-box h-100"><i class="fas fa-layer-group text-danger fa-2x"></i><div class="stats-number" id="availableStock">0</div><div class="stats-label">Stok Karcis Tersedia</div></div></div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-12"><div class="card"><div class="card-header"><i class="fas fa-chart-line me-2"></i>Statistik Penjualan Mingguan</div><div class="card-body"><canvas id="salesChart" height="150"></canvas></div></div></div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="transaction" role="tabpanel">
                            <h3 class="section-title">Transaksi Penjualan Karcis</h3>
                            <div class="card">
                                <div class="card-body">
                                    <form id="addTransactionForm">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Jenis Karcis</label>
                                                <select class="form-select" id="transTicketType" required></select>
                                            </div>
                                            <div class="col-md-2 mb-3">
                                                <label class="form-label">Jumlah</label>
                                                <input type="number" class="form-control" id="transQuantity" min="1" value="1" required>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Nama Pelanggan (Opsional)</label>
                                                <input type="text" class="form-control" id="transCustomerName" placeholder="Nama atau Rombongan">
                                            </div>
                                            <div class="col-md-3 mb-3 align-self-end">
                                                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus me-2"></i>Tambah ke Keranjang</button>
                                            </div>
                                        </div>
                                    </form>
                                    <hr>
                                    <h5 class="mt-4">Keranjang Penjualan</h5>
                                    <div class="table-responsive">
                                        <table class="table data-table">
                                            <thead><tr><th>Jenis Karcis</th><th>Jumlah</th><th>Harga Satuan</th><th>Subtotal</th><th>Aksi</th></tr></thead>
                                            <tbody id="cartList"></tbody>
                                            <tfoot>
                                                <tr><th colspan="3" class="text-end">Total</th><th id="cartTotal">Rp 0</th><th></th></tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="text-end mt-3">
                                        <button class="btn btn-success btn-lg" id="processSaleBtn" disabled><i class="fas fa-check me-2"></i>Proses Pembayaran</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="validation" role="tabpanel">
                            <h3 class="section-title">Validasi Karcis Masuk</h3>
                            <div class="row justify-content-center">
                                <div class="col-md-8 col-lg-6">
                                    <div class="card text-center">
                                        <div class="card-body p-5">
                                            <i class="fas fa-qrcode fa-4x text-muted mb-4"></i>
                                            <h4 class="card-title">Pindai atau Masukkan Kode Karcis</h4>
                                            <form id="validateTicketForm">
                                                <input type="text" class="form-control form-control-lg text-center mb-3" id="ticketCodeInput" placeholder="KODE-UNIK-KARCIS" required>
                                                <button type="submit" class="btn btn-primary btn-lg w-100">Validasi Karcis</button>
                                            </form>
                                            <div id="validationResult" class="mt-4"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="receipt" role="tabpanel">
                             <h3 class="section-title">Kasir & Cetak Struk</h3>
                             <p>Lihat detail transaksi terakhir atau cari transaksi berdasarkan ID untuk mencetak ulang struk pembayaran.</p>
                             <div class="card">
                                 <div class="card-body">
                                     <div id="receiptViewer" class="text-center text-muted">
                                         <i class="fas fa-receipt fa-3x mb-3"></i>
                                         <p>Belum ada transaksi yang diproses.</p>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div class="tab-pane fade" id="history" role="tabpanel">
                            <h3 class="section-title">Histori Transaksi</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table">
                                            <thead><tr><th>ID Transaksi</th><th>Waktu</th><th>Petugas</th><th>Total</th><th>Aksi</th></tr></thead>
                                            <tbody id="transactionHistoryList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="ticket-management" role="tabpanel">
                            <h3 class="section-title">Manajemen Jenis & Stok Karcis</h3>
                            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addTicketTypeModal"><i class="fas fa-plus me-2"></i>Tambah Jenis Karcis</button>
                            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#generateTicketsModal"><i class="fas fa-cogs me-2"></i>Generate & Cetak Karcis</button>
                            
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-tags me-2"></i>Daftar Jenis Karcis</div>
                                        <div class="card-body">
                                            <table class="table data-table">
                                                <thead><tr><th>Nama</th><th>Harga</th><th>Aksi</th></tr></thead>
                                                <tbody id="ticketTypeList"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-layer-group me-2"></i>Daftar Stok Karcis (Terbaru)</div>
                                        <div class="card-body">
                                            <table class="table data-table">
                                                <thead><tr><th>Kode Unik</th><th>Jenis</th><th>Status</th></tr></thead>
                                                <tbody id="ticketStockList"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="customer" role="tabpanel">
                            <h3 class="section-title">Manajemen Data Pelanggan</h3>
                            <p>Data pelanggan atau rombongan yang tercatat saat transaksi.</p>
                             <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover data-table">
                                            <thead><tr><th>ID</th><th>Nama Pelanggan/Rombongan</th><th>Kunjungan Terakhir</th><th>Total Transaksi</th></tr></thead>
                                            <tbody id="customerList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="report" role="tabpanel">
                           <h3 class="section-title">Laporan dan Analisis</h3>
                           <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="filter-section">
                                        <div class="row gy-3 align-items-end">
                                            <div class="col-lg-3 col-md-6">
                                                <label for="reportType" class="form-label">Jenis Laporan</label>
                                                <select class="form-select" id="reportType">
                                                    <option value="revenue">Pendapatan</option>
                                                    <option value="visitors">Jumlah Pengunjung</option>
                                                    <option value="ticket_sales">Penjualan per Jenis Karcis</option>
                                                </select>
                                            </div>
                                            <div class="col-lg-3 col-md-6"><label for="reportStartDate" class="form-label">Periode Mulai</label><input type="date" class="form-control" id="reportStartDate"></div>
                                            <div class="col-lg-3 col-md-6"><label for="reportEndDate" class="form-label">Periode Akhir</label><input type="date" class="form-control" id="reportEndDate"></div>
                                            <div class="col-lg-3 col-md-6"><button class="btn btn-primary w-100" id="generateReportBtn"><i class="fas fa-chart-bar me-2"></i>Generate Laporan</button></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="reportResult" class="mt-4"></div>
                        </div>
                        
                        <div class="tab-pane fade" id="settings" role="tabpanel">
                            <h3 class="section-title">Pengaturan Sistem</h3>
                             <div class="row">
                                <div class="col-lg-6 mb-4 mb-lg-0">
                                    <div class="card">
                                        <div class="card-header"><i class="fas fa-info-circle me-2"></i>Informasi Tempat Wisata</div>
                                        <div class="card-body">
                                            <form id="generalSettingsForm">
                                                <div class="mb-3"><label for="wisataName" class="form-label">Nama Wisata</label><input type="text" class="form-control" id="wisataName" placeholder="Masukkan nama tempat wisata"></div>
                                                <div class="mb-3"><label for="wisataAddress" class="form-label">Alamat</label><textarea class="form-control" id="wisataAddress" rows="3" placeholder="Masukkan alamat"></textarea></div>
                                                <div class="mb-3"><label for="wisataPhone" class="form-label">Telepon</label><input type="text" class="form-control" id="wisataPhone" placeholder="Masukkan telepon"></div>
                                                <div class="mb-3"><label for="wisataEmail" class="form-label">Email</label><input type="email" class="form-control" id="wisataEmail" placeholder="Masukkan email"></div>
                                                <hr>
                                                <div class="mb-3"><label for="taxRate" class="form-label">Pajak (%)</label><input type="number" class="form-control" id="taxRate" min="0" max="30" step="0.1" placeholder="cth: 10"></div>
                                                <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                     <div class="card">
                                        <div class="card-header"><i class="fas fa-database me-2"></i>Manajemen Data</div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-info" id="backupDataBtn"><i class="fas fa-file-archive me-2"></i>Backup Semua Data (JSON)</button>
                                                <button class="btn btn-danger" id="resetDataBtn"><i class="fas fa-trash-alt me-2"></i>Reset Semua Data</button>
                                            </div>
                                        </div>
                                    </div>
                                     <div class="card mt-4">
                                        <div class="card-header"><i class="fas fa-user-circle me-2"></i>Akun</div>
                                        <div class="card-body">
                                            <p>Anda login sebagai <strong>Admin</strong>.</p>
                                            <button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="copyright no-print">
                Developed by <strong><a href="http://www.anekamarket.my.id" target="_blank">Lentera Karya Situbondo</a></strong> &copy; Hak Cipta Sejak 2025.
            </div>
        </div>
    </main>

    <div class="modal fade" id="addTicketTypeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Tambah/Edit Jenis Karcis</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="ticketTypeForm">
                <input type="hidden" id="ticketTypeId">
                <div class="mb-3"><label class="form-label">Nama Jenis Karcis</label><input type="text" class="form-control" id="ticketTypeName" placeholder="cth: Dewasa, Anak, Rombongan Pelajar" required></div>
                <div class="mb-3"><label class="form-label">Harga</label><input type="number" class="form-control" id="ticketTypePrice" min="0" required></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="saveTicketTypeBtn">Simpan</button></div>
    </div></div></div>

    <div class="modal fade" id="generateTicketsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Generate Karcis Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="generateTicketsForm">
                <div class="mb-3"><label class="form-label">Pilih Jenis Karcis</label><select class="form-select" id="generateTicketType" required></select></div>
                <div class="mb-3"><label class="form-label">Jumlah Karcis (kelipatan 10)</label><input type="number" class="form-control" id="generateQuantity" min="10" step="10" value="10" required></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="generateAndPrintBtn">Generate & Cetak</button></div>
    </div></div></div>

    <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Proses Pembayaran</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
             <div class="row gy-3">
                 <div class="col-md-12"><label class="form-label fw-bold">Total Tagihan</label><input type="text" id="paymentTotal" class="form-control form-control-lg" readonly style="font-weight: bold;"></div>
                 <div class="col-md-6"><label class="form-label fw-bold">Jumlah Bayar</label><input type="number" id="amountPaid" class="form-control form-control-lg" placeholder="0"></div>
                 <div class="col-md-6"><label class="form-label fw-bold">Kembalian</label><input type="text" id="changeDue" class="form-control form-control-lg" readonly style="font-weight: bold; color: green;"></div>
             </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-success" id="confirmPaymentBtn" disabled>Konfirmasi & Cetak Struk</button></div>
    </div></div></div>

    <div class="modal fade" id="settingsPasswordModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Konfirmasi Keamanan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <p>Masukkan kata sandi untuk menyimpan perubahan.</p>
            <form id="settingsPasswordForm">
                <div class="form-floating mb-3"><input type="password" class="form-control" id="settingsPassword" placeholder="Password" required><label for="settingsPassword">Password</label></div>
                <div id="settingsPasswordError" class="error-message" style="display: none;">Password salah.</div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="confirmSettingsSaveBtn">Konfirmasi</button></div>
    </div></div></div>

    <div id="ticketPrintableArea" class="printable-area" style="visibility: hidden; position: absolute; left: -9999px;"></div>
    <div id="receiptPrintableArea" class="printable-area" style="visibility: hidden; position: absolute; left: -9999px;"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Main App Initializer
            function initApp() {
                if (sessionStorage.getItem('isLoggedIn') === 'true') {
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    initializeAppCore();
                } else {
                    document.getElementById('loginOverlay').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('loginForm').addEventListener('submit', handleLogin);
                }
            }

            function handleLogin(e) {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                const petugasName = document.getElementById('petugasName').value;
                const errorEl = document.getElementById('loginError');

                if (!petugasName) {
                    errorEl.textContent = 'Nama Petugas wajib diisi.';
                    errorEl.style.display = 'block';
                    return;
                }

                if (user === 'Admin' && pass === 'Wisataku.1945') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('petugasName', petugasName);
                    checkLoginState();
                } else {
                    errorEl.textContent = 'Username atau password salah.';
                    errorEl.style.display = 'block';
                }
            }

            function handleLogout() {
                sessionStorage.clear();
                window.location.reload();
            }

            function initializeAppCore() {
                initStorage();
                setupEventListeners();
                loadAllData();
                const petugasName = sessionStorage.getItem('petugasName');
                console.log(`Selamat Datang, ${petugasName}`);
            }

            function initStorage() {
                const initItem = (key, value) => !localStorage.getItem(key) && localStorage.setItem(key, JSON.stringify(value));
                initItem('wisata_ticket_types', []);
                initItem('wisata_ticket_stock', []);
                initItem('wisata_transactions', []);
                initItem('wisata_customers', []);
                initItem('wisata_settings', {
                    wisataName: 'WISATA ALAM GEMINI',
                    wisataAddress: 'Jl. Puncak Jaya No. 1, Indonesia',
                    wisataPhone: '0812-3456-7890',
                    wisataEmail: 'info@wisatagemini.com',
                    taxRate: 10
                });
            }

            function setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('saveTicketTypeBtn').addEventListener('click', saveTicketType);
                document.getElementById('generateAndPrintBtn').addEventListener('click', generateAndPrintTickets);
                document.getElementById('addTransactionForm').addEventListener('submit', addToCart);
                document.getElementById('processSaleBtn').addEventListener('click', () => new bootstrap.Modal(document.getElementById('paymentModal')).show());
                document.getElementById('amountPaid').addEventListener('input', calculateChange);
                document.getElementById('confirmPaymentBtn').addEventListener('click', processSale);
                document.getElementById('validateTicketForm').addEventListener('submit', validateTicket);
                document.getElementById('generalSettingsForm').addEventListener('submit', saveSettings);
                document.getElementById('confirmSettingsSaveBtn').addEventListener('click', executeSaveSettings);
                document.getElementById('resetDataBtn').addEventListener('click', resetAllData);
                document.getElementById('backupDataBtn').addEventListener('click', backupAllData);
            }

            // --- DATA LOADING & RENDERING ---
            function loadAllData() {
                loadTicketTypes();
                loadTicketStock();
                updateDashboard();
                loadTransactionHistory();
                loadCustomers();
                loadSettings();
                renderCart(); // to show empty cart message
            }
            
            function loadTicketTypes() {
                const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                const list = document.getElementById('ticketTypeList');
                const select1 = document.getElementById('generateTicketType');
                const select2 = document.getElementById('transTicketType');
                list.innerHTML = select1.innerHTML = select2.innerHTML = '';
                
                select1.innerHTML = select2.innerHTML = '<option value="">Pilih Jenis Karcis</option>';
                
                types.forEach(type => {
                    list.innerHTML += `<tr><td>${type.name}</td><td>${formatCurrency(type.price)}</td><td><button class="btn btn-sm btn-warning" onclick="editTicketType('${type.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="deleteTicketType('${type.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                    select1.innerHTML += `<option value="${type.id}">${type.name} - ${formatCurrency(type.price)}</option>`;
                    select2.innerHTML += `<option value="${type.id}">${type.name} - ${formatCurrency(type.price)}</option>`;
                });
            }

            function loadTicketStock() {
                const stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
                const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                const list = document.getElementById('ticketStockList');
                list.innerHTML = '';
                stock.slice(-10).reverse().forEach(ticket => {
                    const type = types.find(t => t.id === ticket.typeId);
                    list.innerHTML += `<tr><td>${ticket.code}</td><td>${type ? type.name : 'N/A'}</td><td><span class="ticket-status status-${ticket.status}">${ticket.status.toUpperCase()}</span></td></tr>`;
                });
            }
            
            function loadTransactionHistory() {
                const history = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
                const list = document.getElementById('transactionHistoryList');
                list.innerHTML = '';
                history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(trans => {
                    list.innerHTML += `<tr><td>${trans.id}</td><td>${new Date(trans.timestamp).toLocaleString('id-ID')}</td><td>${trans.petugas}</td><td>${formatCurrency(trans.total)}</td><td><button class="btn btn-sm btn-info" onclick="viewReceipt('${trans.id}')"><i class="fas fa-print"></i> Lihat Struk</button></td></tr>`;
                });
            }
            
            function loadCustomers() {
                const customers = JSON.parse(localStorage.getItem('wisata_customers') || '[]');
                const list = document.getElementById('customerList');
                list.innerHTML = '';
                customers.forEach(c => {
                    list.innerHTML += `<tr><td>${c.id}</td><td>${c.name}</td><td>${new Date(c.lastVisit).toLocaleDateString('id-ID')}</td><td>${c.transactionCount}</td></tr>`;
                });
            }
            
            function loadSettings() {
                const settings = JSON.parse(localStorage.getItem('wisata_settings'));
                document.getElementById('wisataName').value = settings.wisataName;
                document.getElementById('wisataAddress').value = settings.wisataAddress;
                document.getElementById('wisataPhone').value = settings.wisataPhone;
                document.getElementById('wisataEmail').value = settings.wisataEmail;
                document.getElementById('taxRate').value = settings.taxRate;
            }

            // --- CORE FEATURES ---
            window.saveTicketType = function() {
                const id = document.getElementById('ticketTypeId').value;
                const name = document.getElementById('ticketTypeName').value;
                const price = parseFloat(document.getElementById('ticketTypePrice').value);
                if (!name || isNaN(price)) { alert('Nama dan harga wajib diisi'); return; }

                let types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                if (id) { // Update
                    const index = types.findIndex(t => t.id === id);
                    if (index > -1) types[index] = { ...types[index], name, price };
                } else { // Create
                    types.push({ id: `TYPE-${Date.now()}`, name, price });
                }
                localStorage.setItem('wisata_ticket_types', JSON.stringify(types));
                bootstrap.Modal.getInstance(document.getElementById('addTicketTypeModal')).hide();
                document.getElementById('ticketTypeForm').reset();
                loadTicketTypes();
            }

            window.editTicketType = (id) => {
                const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                const type = types.find(t => t.id === id);
                if (!type) return;
                document.getElementById('ticketTypeId').value = type.id;
                document.getElementById('ticketTypeName').value = type.name;
                document.getElementById('ticketTypePrice').value = type.price;
                new bootstrap.Modal(document.getElementById('addTicketTypeModal')).show();
            };

            window.deleteTicketType = (id) => {
                 if (!confirm('Yakin ingin menghapus jenis karcis ini? Stok karcis terkait juga akan sulit diidentifikasi.')) return;
                let types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                types = types.filter(t => t.id !== id);
                localStorage.setItem('wisata_ticket_types', JSON.stringify(types));
                loadTicketTypes();
            }

            function generateAndPrintTickets() {
                const typeId = document.getElementById('generateTicketType').value;
                const quantity = parseInt(document.getElementById('generateQuantity').value);
                const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                const selectedType = types.find(t => t.id === typeId);

                if (!typeId || isNaN(quantity) || quantity % 10 !== 0) {
                    alert('Pilih jenis karcis dan masukkan jumlah dalam kelipatan 10.');
                    return;
                }

                let stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
                const settings = JSON.parse(localStorage.getItem('wisata_settings'));
                let newTickets = [];
                let printHTML = '';

                for (let i = 0; i < quantity; i++) {
                    const uniqueCode = `K${Date.now()}${Math.floor(Math.random() * 90) + 10}`;
                    const newTicket = { code: uniqueCode, typeId, status: 'available' };
                    newTickets.push(newTicket);
                    stock.push(newTicket);
                }

                localStorage.setItem('wisata_ticket_stock', JSON.stringify(stock));
                
                // Prepare for printing
                let ticketHtmlChunks = newTickets.map(ticket => `
                    <div class="ticket-mini">
                        <div>
                            <h5>${settings.wisataName}</h5>
                            <p>KARCIS MASUK RESMI</p>
                            <p><strong>${selectedType.name}</strong> - ${formatCurrency(selectedType.price)}</p>
                        </div>
                        <div>
                            <p class="ticket-code">${ticket.code}</p>
                            <p class="ticket-footer">Berlaku untuk 1 kali masuk. Simpan baik-baik.</p>
                        </div>
                    </div>
                `).join('');

                document.getElementById('ticketPrintableArea').innerHTML = `<div class="ticket-print-container">${ticketHtmlChunks}</div>`;
                
                bootstrap.Modal.getInstance(document.getElementById('generateTicketsModal')).hide();
                loadAllData();
                
                // Trigger Print
                window.print();
            }

            let cart = [];
            function addToCart(e) {
                e.preventDefault();
                const typeId = document.getElementById('transTicketType').value;
                const quantity = parseInt(document.getElementById('transQuantity').value);
                if (!typeId || isNaN(quantity) || quantity <= 0) return;
                
                const types = JSON.parse(localStorage.getItem('wisata_ticket_types') || '[]');
                const type = types.find(t => t.id === typeId);

                const existingItem = cart.find(item => item.typeId === typeId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({ typeId, name: type.name, quantity, price: type.price });
                }
                document.getElementById('addTransactionForm').reset();
                renderCart();
            }
            
            function renderCart() {
                const list = document.getElementById('cartList');
                list.innerHTML = '';
                let total = 0;
                if(cart.length === 0) {
                    list.innerHTML = '<tr><td colspan="5" class="text-center">Keranjang masih kosong</td></tr>';
                } else {
                     cart.forEach((item, index) => {
                        const subtotal = item.quantity * item.price;
                        total += subtotal;
                        list.innerHTML += `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(subtotal)}</td><td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                }
                document.getElementById('cartTotal').textContent = formatCurrency(total);
                document.getElementById('paymentTotal').value = formatCurrency(total);
                document.getElementById('processSaleBtn').disabled = cart.length === 0;
            }

            window.removeFromCart = (index) => {
                cart.splice(index, 1);
                renderCart();
            }
            
            function calculateChange() {
                const total = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
                document.getElementById('changeDue').value = paid >= total ? formatCurrency(paid - total) : '';
                document.getElementById('confirmPaymentBtn').disabled = paid < total;
            }

            function processSale() {
                const total = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                let transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
                let customers = JSON.parse(localStorage.getItem('wisata_customers') || '[]');
                const customerName = document.getElementById('transCustomerName').value.trim();
                
                const transaction = {
                    id: `TRX-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    petugas: sessionStorage.getItem('petugasName'),
                    items: cart,
                    total: total,
                    customerName: customerName
                };
                transactions.push(transaction);
                
                if (customerName) {
                    let customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                    if (customer) {
                        customer.transactionCount += 1;
                        customer.lastVisit = new Date().toISOString();
                    } else {
                        customers.push({id: `CUST-${Date.now()}`, name: customerName, transactionCount: 1, lastVisit: new Date().toISOString() });
                    }
                    localStorage.setItem('wisata_customers', JSON.stringify(customers));
                }

                localStorage.setItem('wisata_transactions', JSON.stringify(transactions));
                
                bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                document.getElementById('paymentModal').querySelector('form')?.reset();
                document.getElementById('transCustomerName').value = '';

                cart = [];
                renderCart();
                loadAllData();
                viewReceipt(transaction.id, true); // view and print
            }

            function validateTicket(e) {
                e.preventDefault();
                const code = document.getElementById('ticketCodeInput').value.trim();
                const resultDiv = document.getElementById('validationResult');
                if (!code) return;
                
                let stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
                const ticketIndex = stock.findIndex(t => t.code === code);
                
                if (ticketIndex === -1) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><strong>GAGAL!</strong> Kode karcis tidak ditemukan.</div>`;
                } else if (stock[ticketIndex].status === 'used') {
                    resultDiv.innerHTML = `<div class="alert alert-warning"><strong>PERINGATAN!</strong> Karcis ini sudah digunakan sebelumnya pada ${new Date(stock[ticketIndex].usedAt).toLocaleString('id-ID')}.</div>`;
                } else if (stock[ticketIndex].status === 'available') {
                    stock[ticketIndex].status = 'used';
                    stock[ticketIndex].usedAt = new Date().toISOString();
                    localStorage.setItem('wisata_ticket_stock', JSON.stringify(stock));
                    resultDiv.innerHTML = `<div class="alert alert-success"><strong>BERHASIL!</strong> Selamat datang. Karcis valid.</div>`;
                    loadAllData();
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-secondary"><strong>INFO:</strong> Status karcis: ${stock[ticketIndex].status}.</div>`;
                }
                document.getElementById('ticketCodeInput').value = '';
                document.getElementById('ticketCodeInput').focus();
            }

            // --- SETTINGS & DATA MANAGEMENT ---
            function saveSettings(e) {
                e.preventDefault();
                document.getElementById('settingsPassword').value = '';
                document.getElementById('settingsPasswordError').style.display = 'none';
                new bootstrap.Modal(document.getElementById('settingsPasswordModal')).show();
            }

            function executeSaveSettings() {
                if (document.getElementById('settingsPassword').value !== 'LKS.1945') {
                    document.getElementById('settingsPasswordError').style.display = 'block';
                    return;
                }

                const newSettings = {
                    wisataName: document.getElementById('wisataName').value,
                    wisataAddress: document.getElementById('wisataAddress').value,
                    wisataPhone: document.getElementById('wisataPhone').value,
                    wisataEmail: document.getElementById('wisataEmail').value,
                    taxRate: parseFloat(document.getElementById('taxRate').value)
                };
                localStorage.setItem('wisata_settings', JSON.stringify(newSettings));
                bootstrap.Modal.getInstance(document.getElementById('settingsPasswordModal')).hide();
                alert('Pengaturan berhasil disimpan.');
            }
            
            function resetAllData() {
                if (confirm('PERINGATAN! Anda akan menghapus SEMUA data (jenis karcis, stok, transaksi). Tindakan ini tidak dapat dibatalkan. Lanjutkan?')) {
                    localStorage.removeItem('wisata_ticket_types');
                    localStorage.removeItem('wisata_ticket_stock');
                    localStorage.removeItem('wisata_transactions');
                    localStorage.removeItem('wisata_customers');
                    initStorage();
                    loadAllData();
                }
            }

            function backupAllData() {
                const data = {
                    types: JSON.parse(localStorage.getItem('wisata_ticket_types')),
                    stock: JSON.parse(localStorage.getItem('wisata_ticket_stock')),
                    transactions: JSON.parse(localStorage.getItem('wisata_transactions')),
                    customers: JSON.parse(localStorage.getItem('wisata_customers')),
                    settings: JSON.parse(localStorage.getItem('wisata_settings')),
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `wisata_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            // --- UI & HELPERS ---
            window.viewReceipt = (transactionId, autoPrint = false) => {
                const transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
                const transaction = transactions.find(t => t.id === transactionId);
                const settings = JSON.parse(localStorage.getItem('wisata_settings'));
                if (!transaction) return;

                const itemsHtml = transaction.items.map(item => `
                    <tr><td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td class="text-end">${formatCurrency(item.quantity * item.price)}</td></tr>
                `).join('');

                const receiptHtml = `
                    <div class="receipt-container">
                        <div class="receipt-header text-center">
                            <h4>${settings.wisataName}</h4>
                            <p class="mb-0">${settings.wisataAddress}</p>
                            <p>Telp: ${settings.wisataPhone}</p>
                        </div>
                        <p>No: ${transaction.id}<br>Tanggal: ${new Date(transaction.timestamp).toLocaleString('id-ID')}<br>Kasir: ${transaction.petugas}</p>
                        <hr>
                        <table class="table receipt-table">
                            <thead><tr><th>Item</th><th>Qty</th><th>Harga</th><th class="text-end">Subtotal</th></tr></thead>
                            <tbody>${itemsHtml}</tbody>
                            <tfoot><tr><th colspan="3">TOTAL</th><th class="text-end">${formatCurrency(transaction.total)}</th></tr></tfoot>
                        </table>
                        <div class="receipt-footer text-center">
                            <p>Terima kasih atas kunjungan Anda!</p>
                        </div>
                        ${autoPrint ? '' : '<div class="text-center mt-3 no-print"><button class="btn btn-primary" onclick="printReceipt()">Cetak Struk</button></div>'}
                    </div>`;

                document.getElementById('receiptViewer').innerHTML = receiptHtml;
                document.getElementById('receiptPrintableArea').innerHTML = receiptHtml;
                
                const tabTrigger = new bootstrap.Tab(document.getElementById('receipt-tab'));
                tabTrigger.show();

                if (autoPrint) {
                    printReceipt();
                }
            };
            
            window.printReceipt = () => {
                window.print();
            }

            function updateDashboard() {
                const transactions = JSON.parse(localStorage.getItem('wisata_transactions') || '[]');
                const stock = JSON.parse(localStorage.getItem('wisata_ticket_stock') || '[]');
                const today = new Date().toISOString().slice(0, 10);

                const todayTransactions = transactions.filter(t => t.timestamp.startsWith(today));
                
                const totalVisitorsToday = stock.filter(t => t.status === 'used' && t.usedAt.startsWith(today)).length;
                const ticketsSoldCount = todayTransactions.reduce((sum, t) => sum + t.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
                const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
                const availableStock = stock.filter(t => t.status === 'available').length;
                
                document.getElementById('totalVisitorsToday').textContent = totalVisitorsToday;
                document.getElementById('ticketsSoldCount').textContent = ticketsSoldCount;
                document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);
                document.getElementById('availableStock').textContent = availableStock;
                
                updateSalesChart(transactions);
            }
            
            let salesChartInstance;
            function updateSalesChart(transactions) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const labels = [];
                const data = [];
                for(let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().slice(0, 10);
                    labels.push(d.toLocaleDateString('id-ID', { weekday: 'short' }));
                    const dayRevenue = transactions
                        .filter(t => t.timestamp.startsWith(dateStr))
                        .reduce((sum, t) => sum + t.total, 0);
                    data.push(dayRevenue);
                }

                if (salesChartInstance) salesChartInstance.destroy();
                salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Pendapatan', data, borderColor: 'var(--wisata-primary)', backgroundColor: 'var(--wisata-light)', fill: true, tension: 0.1 }] },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }

            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
            
            // Final check and init
            function checkLoginState() { initApp(); }
            checkLoginState();
        });
    </script>
</body>
</html>
