<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Pro - Kafe & Restoran</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #8a5a44;
            --primary-light: #e6ccb2;
            --secondary: #3a3a3a;
            --success: #2a9d8f;
            --danger: #e76f51;
            --warning: #f4a261;
            --info: #264653;
            --light: #f8f9fa;
            --dark: #212529;
            --bg-light: #fdfaf6;
            --bg-dark: #1c1c1e;
            --text-light: #212529;
            --text-dark: #f8f9fa;
            --border-light: #dee2e6;
            --border-dark: #495057;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --rounded: 0.75rem;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        html.dark {
            --primary-light: #4a3b32;
            --secondary: #cccccc;
            --light: #2c2c2e;
            --dark: #f8f9fa;
            --bg-light: var(--bg-dark);
            --text-light: var(--text-dark);
            --border-light: var(--border-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container { max-width: 100%; margin: 0 auto; padding: 1rem; }
        .app-header { background: linear-gradient(135deg, var(--primary), #573829); color: white; padding: 1rem 1.5rem; border-radius: var(--rounded); margin-bottom: 1.5rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 1rem; z-index: 100; }
        .app-title { font-size: 1.5rem; font-weight: 700; }
        .header-info { text-align: right; display: flex; align-items: center; gap: 1rem; }
        .theme-switcher { cursor: pointer; font-size: 1.2rem; }
        
        .app-content { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 1024px) { .app-content { grid-template-columns: 2fr 1fr; } }
        .panel { background: var(--light); border-radius: var(--rounded); padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border-light); }
        .panel-title { font-size: 1.3rem; margin-bottom: 1rem; color: var(--dark); font-weight: 600; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-light); padding-bottom: 0.75rem; }
        .panel-title i { margin-right: 0.5rem; color: var(--primary); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 1rem; }
        .product-card { background: var(--light); border-radius: var(--rounded); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: var(--transition); border: 1px solid var(--border-light); cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .product-image { width: 100%; height: 120px; object-fit: cover; }
        .product-info { padding: 0.75rem; flex-grow: 1; }
        .product-name { font-weight: 600; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { color: var(--primary); font-weight: 700; font-size: 1.1rem; }
        .product-stock { font-size: 0.8rem; color: var(--secondary); opacity: 0.8; }
        .product-stock.low { color: var(--danger); font-weight: 600; }

        .search-container { position: relative; margin-bottom: 1rem; }
        .search-container i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--secondary); opacity: 0.6; }
        .search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--border-light); border-radius: var(--rounded); font-size: 1rem; background: var(--bg-light); color: var(--text-light); transition: var(--transition); }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(138, 90, 68, 0.2); }
        .filter-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .filter-chip { padding: 0.5rem 1rem; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 20px; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: var(--transition); }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .cart-item { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-light); }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex: 1; margin-left: 0.75rem; }
        .cart-item-name { font-weight: 600; }
        .cart-item-price { color: var(--secondary); font-size: 0.9rem; }
        .cart-item-qty { display: flex; align-items: center; }
        .qty-btn { width: 28px; height: 28px; border: 1px solid var(--border-light); background: var(--bg-light); border-radius: 50%; cursor: pointer; transition: var(--transition); display: flex; justify-content: center; align-items: center;}
        .qty-btn:hover { background: var(--primary-light); }
        .qty-input { width: 35px; text-align: center; margin: 0 0.5rem; border: none; background: transparent; font-size: 1rem; font-weight: 500;}
        .remove-btn { color: var(--danger); margin-left: 0.75rem; cursor: pointer; }
        .cart-item-img { width: 50px; height: 50px; object-fit: cover; border-radius: 0.5rem; }

        .summary-container { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-light); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.95rem; }
        .total-row { font-weight: 700; font-size: 1.2rem; color: var(--primary); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light); }
        
        .btn { display: inline-block; padding: 0.8rem 1.5rem; background-color: var(--primary); color: white; border: none; border-radius: var(--rounded); cursor: pointer; font-size: 1rem; font-weight: 600; text-align: center; transition: var(--transition); width: 100%; text-decoration: none;}
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn i { margin-right: 0.5rem; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-info { background-color: var(--info); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--light); border-radius: 1rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); animation: modal-fade-in 0.3s; }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.3rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--secondary); opacity: 0.7; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border-light); display: flex; justify-content: flex-end; gap: 0.5rem; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-light); border-radius: var(--rounded); font-size: 1rem; background: var(--bg-light); color: var(--text-light); }
        textarea.form-control { min-height: 100px; resize: vertical; }
        
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-card { width: 90%; max-width: 400px; background: var(--light); border-radius: 1rem; padding: 2.5rem; box-shadow: var(--shadow); }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-logo { font-size: 3.5rem; color: var(--primary); margin-bottom: 1rem; }
        .login-title { font-size: 1.8rem; color: var(--dark); font-weight: 700; }
        .login-hint { font-size: 0.8rem; color: var(--secondary); margin-top: 10px; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; background-color: var(--dark); color: white; border-radius: var(--rounded); box-shadow: var(--shadow); z-index: 1100; display: flex; align-items: center; opacity: 0; visibility: hidden; transition: var(--transition); }
        .toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast.warning { background-color: var(--warning); }
        .toast i { margin-right: 0.75rem; }
        
        .empty-state { text-align: center; padding: 2rem; color: var(--secondary); opacity: 0.7; grid-column: 1 / -1;}
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; }

        .admin-panel { background-color: var(--primary-light); margin-top: 1.5rem; padding: 1rem; border-radius: var(--rounded); display: none; }
        .admin-panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; }
        .admin-view .admin-panel { display: block; }
        
        .dashboard-modal { max-width: 800px !important; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-light); padding: 1.5rem; border-radius: var(--rounded); text-align: center; border: 1px solid var(--border-light); }
        .stat-card-title { font-size: 1rem; font-weight: 500; color: var(--secondary); margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .chart-container { margin-top: 1.5rem; }

        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-light); }
        .data-table th { background-color: var(--bg-light); font-weight: 600; }
        .data-table tr:hover { background-color: var(--primary-light); }
        .action-buttons { display: flex; gap: 0.5rem; }

        #receiptModal .modal-content { max-width: 400px; }
        #receiptContent { font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        #receiptContent h4, #receiptContent p { text-align: center; margin: 0; }
        #receiptContent .divider { border-top: 1px dashed var(--secondary); margin: 10px 0; }
        #receiptContent table { width: 100%; font-size: 14px; }
    </style>
</head>
<body>
    <div id="toast" class="toast"><i class="fas fa-info-circle"></i> <span id="toast-message"></span></div>
    
    <div id="loginPage" style="display: none;">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo"><i class="fas fa-coffee"></i></div>
                    <h1 class="login-title">SISTEM KASIR PRO</h1>
                    <p>Hubungi Admin Untuk Mendapatkan Password</p>
                    <p class="login-hint">(Default: user: admin, pass: 12345 | user: kasir, pass: kasir123)</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
                    </div>
                    <button type="submit" class="btn" style="margin-top: 1rem;">Login</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="container" id="mainApp" style="display: none;">
        <header class="app-header">
            <div>
                <h1 class="app-title" id="storeNameHeader">Kafe Koding</h1>
                <p id="currentDate" style="opacity: 0.8; font-size: 0.9rem;"></p>
            </div>
            <div class="header-info">
                <div>
                    Kasir: <span id="loggedInUser">Admin</span><br>
                    <a href="#" id="logoutBtn" style="color: white; font-size: 0.9rem;">Logout</a>
                </div>
                <div id="theme-switcher" class="theme-switcher">
                    <i class="fas fa-moon"></i>
                </div>
            </div>
        </header>

        <main class="app-content">
            <section class="panel products-panel">
                <h2 class="panel-title"><i class="fas fa-book-open"></i>Daftar Menu (<span id="productCount">0</span>)</h2>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" class="search-input" placeholder="Cari menu...">
                </div>
                <div class="filter-row">
                    <div class="filter-chip active" data-category="all">Semua</div>
                </div>
                <div class="product-grid" id="productGrid"></div>

                <div id="adminPanel" class="admin-panel">
                    <h3 class="panel-title" style="border: none; padding-bottom: 0.5rem; margin-bottom: 0.5rem;"><i class="fas fa-user-shield"></i>Panel Admin</h3>
                    <div class="admin-panel-grid">
                        <button id="dashboardBtn" class="btn btn-info btn-sm"><i class="fas fa-chart-line"></i> Dashboard</button>
                        <button id="addProductBtn" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Tambah Menu</button>
                        <button id="manageCategoriesBtn" class="btn btn-sm" style="background-color: #6c757d;"><i class="fas fa-tags"></i> Kategori</button>
                        <button id="manageCashiersBtn" class="btn btn-sm" style="background-color: #6c757d;"><i class="fas fa-users"></i> Staf</button>
                        <button id="manageMembersBtn" class="btn btn-sm" style="background-color: #6c757d;"><i class="fas fa-id-card"></i> Member</button>
                        <button id="viewReportsBtn" class="btn btn-sm" style="background-color: #6c757d;"><i class="fas fa-file-alt"></i> Laporan</button>
                        <button id="manageStoreInfoBtn" class="btn btn-sm" style="background-color: #6c757d;"><i class="fas fa-store"></i> Info Resto</button>
                        <button id="backupDataBtn" class="btn btn-warning btn-sm"><i class="fas fa-download"></i> Backup</button>
                        <button id="restoreDataBtn" class="btn btn-warning btn-sm"><i class="fas fa-upload"></i> Restore</button>
                    </div>
                </div>
            </section>

            <section class="panel cart-panel" style="position: sticky; top: 110px; height: calc(100vh - 125px);">
                 <h2 class="panel-title"><i class="fas fa-shopping-cart"></i>Pesanan (<span id="cartCount">0</span> item)</h2>
                 <div id="cartItems" style="height: calc(100% - 220px); overflow-y: auto;"></div>
                 <div style="position: absolute; bottom: 1.5rem; left: 1.5rem; right: 1.5rem;">
                    <div class="summary-container">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="cartSubtotal">Rp 0</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total:</span>
                            <span id="cartTotal">Rp 0</span>
                        </div>
                    </div>
                    <button id="checkoutBtn" class="btn btn-success" style="margin-top: 1rem;"><i class="fas fa-cash-register"></i> Proses Pembayaran</button>
                    <button id="clearCartBtn" class="btn btn-danger btn-sm" style="margin-top: 0.5rem;">Kosongkan</button>
                 </div>
            </section>
        </main>
    </div>
    
    <div id="dashboardModal" class="modal"><div class="modal-content dashboard-modal"><div class="modal-header"><h3 class="modal-title"><i class="fas fa-chart-line"></i> Dashboard Analitik</h3><button class="modal-close">&times;</button></div><div class="modal-body"><div class="dashboard-grid"><div class="stat-card"><div class="stat-card-title">Pendapatan Hari Ini</div><div class="stat-card-value" id="dailyRevenue">Rp 0</div></div><div class="stat-card"><div class="stat-card-title">Transaksi Hari Ini</div><div class="stat-card-value" id="dailyTransactions">0</div></div><div class="stat-card"><div class="stat-card-title">Produk Terlaris</div><div class="stat-card-value" id="topProduct" style="font-size: 1.5rem;">-</div></div></div><div class="chart-container"><canvas id="salesChart"></canvas></div></div></div></div>
    <div id="checkoutModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Proses Pembayaran</h3><button class="modal-close">&times;</button></div><div class="modal-body"><div class="summary-row total-row" style="font-size: 1.5rem; margin-bottom: 1rem;"><span>Total Tagihan:</span><span id="paymentTotal">Rp 0</span></div><div class="form-group"><label class="form-label">Metode Pembayaran</label><select id="paymentMethod" class="form-control"><option value="cash">Tunai</option><option value="qris">QRIS</option><option value="debit">Debit/Kredit</option></select></div><div class="form-group"><label class="form-label">Jumlah Pembayaran</label><input type="number" id="paymentAmount" class="form-control" placeholder="Masukkan jumlah bayar"></div><div id="changeContainer" style="display: none;"><div class="summary-row"><span>Kembalian:</span><span id="paymentChange">Rp 0</span></div></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Kembali</button><button class="btn btn-success" id="completePaymentBtn">Selesaikan Transaksi</button></div></div></div>
    <div id="productModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Tambah Menu Baru</h3><button class="modal-close">&times;</button></div><div class="modal-body"><form id="productForm"><input type="hidden" id="productId"><div class="form-group"><label class="form-label">Nama Menu</label><input type="text" id="productName" class="form-control" required></div><div class="form-group"><label class="form-label">URL Gambar</label><input type="text" id="productImageUrl" class="form-control" placeholder="https://example.com/image.jpg"></div><div class="form-group"><label class="form-label">Kategori</label><select id="productCategory" class="form-control" required></select></div><div class="form-group"><label class="form-label">Harga Jual</label><input type="number" id="productPrice" class="form-control" required></div><div class="form-group"><label class="form-label">Stok</label><input type="number" id="productStock" class="form-control" required></div></form></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Batal</button><button class="btn btn-success" id="saveProductBtn">Simpan</button></div></div></div>
    <div id="manageCategoriesModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Kelola Kategori</h3><button class="modal-close">&times;</button></div><div class="modal-body"><table class="data-table"><thead><tr><th>Nama Kategori</th><th>Aksi</th></tr></thead><tbody id="categoriesList"></tbody></table><div class="form-group" style="margin-top: 1rem;"><label class="form-label">Tambah Kategori Baru</label><div style="display:flex; gap: 0.5rem;"><input type="text" id="newCategoryName" class="form-control"><button class="btn btn-success" id="addCategoryBtn">Tambah</button></div></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Tutup</button></div></div></div>
    <div id="reportsModal" class="modal"><div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title">Laporan Penjualan</h3><button class="modal-close">&times;</button></div><div class="modal-body"><div style="display: flex; gap: 1rem; margin-bottom: 1rem;"><div class="form-group" style="flex:1;"><label class="form-label">Dari Tanggal</label><input type="date" id="reportStartDate" class="form-control"></div><div class="form-group" style="flex:1;"><label class="form-label">Sampai Tanggal</label><input type="date" id="reportEndDate" class="form-control"></div></div><div id="reportSummary"></div><div style="max-height: 40vh; overflow-y: auto;"><table class="data-table"><thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Kasir</th><th>Total</th></tr></thead><tbody id="reportTableBody"></tbody></table></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Tutup</button><button class="btn btn-success" id="generateReportBtn">Generate</button><button class="btn btn-info" id="printReportBtn">Cetak PDF</button></div></div></div>
    <div id="restoreDataModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Restore Data</h3><button class="modal-close">&times;</button></div><div class="modal-body"><p>Pilih file backup (.json) untuk memulihkan data. Semua data saat ini akan diganti.</p><div class="form-group"><input type="file" id="restoreFileInput" class="form-control" accept=".json"></div><p style="color: var(--danger); font-weight: bold;">PERINGATAN: Tindakan ini tidak dapat dibatalkan!</p></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Batal</button><button class="btn btn-success" id="confirmRestoreBtn">Restore Data</button></div></div></div>
    <div id="manageStoreInfoModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Informasi Restoran</h3><button class="modal-close">&times;</button></div><div class="modal-body"><form id="storeInfoForm"><div class="form-group"><label class="form-label">Nama Resto</label><input type="text" id="storeName" class="form-control" required></div><div class="form-group"><label class="form-label">Alamat</label><input type="text" id="storeAddress" class="form-control"></div><div class="form-group"><label class="form-label">No. Telepon</label><input type="text" id="storePhone" class="form-control"></div></form></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Batal</button><button class="btn btn-success" id="saveStoreInfoBtn">Simpan</button></div></div></div>
    <div id="manageCashiersModal" class="modal"><div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title">Kelola Staf</h3><button class="modal-close">&times;</button></div><div class="modal-body"><button class="btn btn-success btn-sm" id="addNewCashierBtn" style="width: auto; margin-bottom: 1rem;"><i class="fas fa-plus"></i> Tambah Staf Baru</button><div style="max-height: 50vh; overflow-y: auto;"><table class="data-table"><thead><tr><th>Nama</th><th>Username</th><th>Peran</th><th>Aksi</th></tr></thead><tbody id="cashiersList"></tbody></table></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Tutup</button></div></div></div>
    <div id="cashierFormModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="cashierFormTitle">Tambah Staf Baru</h3><button class="modal-close">&times;</button></div><div class="modal-body"><form id="cashierForm"><input type="hidden" id="cashierId"><div class="form-group"><label class="form-label">Nama Lengkap</label><input type="text" id="cashierName" class="form-control" required></div><div class="form-group"><label class="form-label">Username</label><input type="text" id="cashierUsername" class="form-control" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" id="cashierPassword" class="form-control" placeholder="Kosongkan jika tidak ingin mengubah"><small>Min. 5 karakter.</small></div><div class="form-group"><label class="form-label">Peran (Hak Akses)</label><select id="cashierRole" class="form-control"><option value="cashier">Kasir</option><option value="admin">Admin</option></select></div></form></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Batal</button><button class="btn btn-success" id="saveCashierBtn">Simpan</button></div></div></div>
    <div id="manageMembersModal" class="modal"><div class="modal-content" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title">Kelola Member</h3><button class="modal-close">&times;</button></div><div class="modal-body"><button class="btn btn-success btn-sm" id="addNewMemberBtn" style="width: auto; margin-bottom: 1rem;"><i class="fas fa-plus"></i> Tambah Member Baru</button><div style="max-height: 50vh; overflow-y: auto;"><table class="data-table"><thead><tr><th>ID Member</th><th>Nama</th><th>Telepon</th><th>Aksi</th></tr></thead><tbody id="membersList"></tbody></table></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Tutup</button></div></div></div>
    <div id="memberFormModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="memberFormTitle">Tambah Member Baru</h3><button class="modal-close">&times;</button></div><div class="modal-body"><form id="memberForm"><input type="hidden" id="memberId"><div class="form-group"><label class="form-label">Nama Lengkap</label><input type="text" id="memberName" class="form-control" required></div><div class="form-group"><label class="form-label">Nomor Telepon</label><input type="tel" id="memberPhone" class="form-control"></div></form></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Batal</button><button class="btn btn-success" id="saveMemberBtn">Simpan</button></div></div></div>
    <div id="receiptModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Struk Transaksi</h3><button class="modal-close">&times;</button></div><div class="modal-body"><div id="receiptContent"></div></div><div class="modal-footer"><button class="btn btn-warning modal-close-btn">Tutup</button><button class="btn btn-info" id="downloadReceiptBtn"><i class="fas fa-download"></i> Unduh PDF</button><button class="btn btn-success" id="printReceiptBtn"><i class="fas fa-print"></i> Cetak</button></div></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
    // FULLY INTEGRATED JAVASCRIPT
    $(document).ready(function() {
        'use strict';
        
        moment.locale('id', {
            months: 'Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_November_Desember'.split('_'),
            weekdays: 'Minggu_Senin_Selasa_Rabu_Kamis_Jumat_Sabtu'.split('_'),
            longDateFormat: { LLLL: 'dddd, D MMMM YYYY', lll: 'D MMM YYYY HH:mm' }
        });
        const { jsPDF } = window.jspdf;

        const STORAGE_KEYS = {
            PRODUCTS: 'kasir_pro_products', CATEGORIES: 'kasir_pro_categories', TRANSACTIONS: 'kasir_pro_transactions',
            USER: 'kasir_pro_user', CART: 'kasir_pro_cart', SETTINGS: 'kasir_pro_settings',
            USERS: 'kasir_pro_users', MEMBERS: 'kasir_pro_members', THEME: 'kasir_pro_theme'
        };
        const BACKUP_ENCRYPTION_KEY = 'KASIR-PRO-SECRET-KEY';

        let products = [], categories = [], transactions = [], settings = {}, users = [], members = [],
            currentUser = null,
            currentCart = { items: [], subtotal: 0, total: 0 },
            lastTransaction = null;
        let salesChartInstance = null;
        
        // --- 1. INITIALIZATION & DATA MANAGEMENT ---
        function initializeData() {
            if (!localStorage.getItem(STORAGE_KEYS.USERS)) {
                const defaultAdmin = { id: 'U001', username: 'admin', password: CryptoJS.SHA256('12345').toString(), name: 'Administrator', role: 'admin' };
                const defaultCashier = { id: 'U002', username: 'kasir', password: CryptoJS.SHA256('kasir123').toString(), name: 'Kasir', role: 'cashier' };
                localStorage.setItem(STORAGE_KEYS.USERS, JSON.stringify([defaultAdmin, defaultCashier]));
            }
            if (!localStorage.getItem(STORAGE_KEYS.SETTINGS)) {
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify({ storeName: 'Kafe Anda', storeAddress: 'Jalan Kopi No. 1, Jakarta', storePhone: '081234567890'}));
            }
            if (!localStorage.getItem(STORAGE_KEYS.PRODUCTS)) {
                const sampleProducts = [
                    { id: 'P1', name: 'Espresso', price: 15000, stock: 100, category: 'Kopi', imageUrl: 'https://images.unsplash.com/photo-1579992305423-74a75b22ba26?q=80&w=400' },
                    { id: 'P2', name: 'Latte', price: 22000, stock: 80, category: 'Kopi', imageUrl: 'https://images.unsplash.com/photo-1561651823-1c7b11405e8a?q=80&w=400' },
                    { id: 'P3', name: 'Croissant', price: 18000, stock: 50, category: 'Pastry', imageUrl: 'https://images.unsplash.com/photo-1587241321921-91a834d6d194?q=80&w=400' },
                    { id: 'P4', name: 'Nasi Goreng', price: 25000, stock: 40, category: 'Makanan', imageUrl: 'https://images.unsplash.com/photo-1599043513900-ed6fe01d3833?q=80&w=400' }
                ];
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(sampleProducts));
            }
            if (!localStorage.getItem(STORAGE_KEYS.CATEGORIES)) {
                const sampleCategories = [{id: 'C1', name: 'Kopi'}, {id: 'C2', name: 'Pastry'}, {id: 'C3', name: 'Makanan'}];
                localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(sampleCategories));
            }
             [STORAGE_KEYS.TRANSACTIONS, STORAGE_KEYS.MEMBERS].forEach(key => { if (!localStorage.getItem(key)) localStorage.setItem(key, '[]'); });
        }

        function loadDataFromStorage() {
            products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
            categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
            transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
            settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || {};
            users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [];
            members = JSON.parse(localStorage.getItem(STORAGE_KEYS.MEMBERS)) || [];
            currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER)) || null;
            currentCart = JSON.parse(localStorage.getItem(STORAGE_KEYS.CART)) || { items: [], subtotal: 0, total: 0 };
        }

        function saveDataToStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

        function initializeAppView() {
            if (!currentUser) return;
            $('#loggedInUser').text(currentUser.name);
            $('#mainApp').removeClass('admin-view');
            if (currentUser.role === 'admin') { $('#mainApp').addClass('admin-view'); }
            updateCurrentDate();
            setInterval(updateCurrentDate, 1000 * 60);
            updateStoreInfo();
            loadCategories();
            loadProducts();
            updateCart();
        }

        // --- 2. UI & THEME ---
        function applyInitialTheme() {
            const theme = localStorage.getItem(STORAGE_KEYS.THEME);
            if (theme === 'dark') {
                $('html').addClass('dark');
                $('#theme-switcher').html('<i class="fas fa-sun"></i>');
            } else {
                $('#theme-switcher').html('<i class="fas fa-moon"></i>');
            }
        }
        $('#theme-switcher').on('click', () => {
            $('html').toggleClass('dark');
            const newTheme = $('html').hasClass('dark') ? 'dark' : 'light';
            localStorage.setItem(STORAGE_KEYS.THEME, newTheme);
            $('#theme-switcher').html(newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>');
        });
        function updateCurrentDate() { $('#currentDate').text(moment().format('LLLL')); }
        function updateStoreInfo() {
            $('#storeNameHeader').text(settings.storeName || 'Kasir Pro');
            document.title = settings.storeName || 'Aplikasi Kasir Pro';
        }
        function formatCurrency(amount, prefix = 'Rp ') { return prefix + (amount || 0).toLocaleString('id-ID'); }
        function showToast(message, type = 'info') {
            const toast = $('#toast').removeClass('success error warning info').addClass(type);
            toast.find('#toast-message').text(message);
            toast.addClass('show');
            setTimeout(() => toast.removeClass('show'), 3000);
        }

        // --- 3. AUTHENTICATION ---
        $('#loginForm').submit(function(e) {
            e.preventDefault();
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();
            const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
            
            if (user && CryptoJS.SHA256(password).toString() === user.password) {
                currentUser = user;
                saveDataToStorage(STORAGE_KEYS.USER, currentUser);
                $('#loginPage').hide();
                $('#mainApp').fadeIn();
                initializeAppView();
                showToast(`Selamat datang, ${currentUser.name}!`, 'success');
            } else {
                showToast('Username atau password salah.', 'error');
            }
        });
        $('#logoutBtn').click(function(e) {
            e.preventDefault();
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.USER);
            localStorage.removeItem(STORAGE_KEYS.CART);
            $('#mainApp').fadeOut(() => $('#loginPage').show());
            showToast('Anda telah logout.', 'info');
        });

        // --- 4. PRODUCT & CATEGORY MANAGEMENT ---
        $('#productSearch').on('input', () => loadProducts());
        $(document).on('click', '.filter-chip', function() {
            $('.filter-chip').removeClass('active');
            $(this).addClass('active');
            loadProducts();
        });
        $(document).on('click', '.product-card', function() { addProductToCart($(this).data('id')); });
        
        function loadProducts() {
            const searchTerm = $('#productSearch').val().toLowerCase();
            const category = $('.filter-chip.active').data('category');
            let filtered = products;

            if (searchTerm) { filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm)); }
            if (category !== 'all') { filtered = filtered.filter(p => p.category === category); }

            $('#productCount').text(filtered.length);
            const grid = $('#productGrid').empty();
            if (filtered.length === 0) {
                grid.html(`<div class="empty-state"><i class="fas fa-box-open"></i><p>Menu tidak ditemukan</p></div>`);
                return;
            }
            filtered.forEach(p => {
                const stockClass = p.stock <= 5 ? 'low' : '';
                const imageUrl = p.imageUrl || 'https://via.placeholder.com/200x150.png?text=No+Image';
                grid.append(`
                    <div class="product-card" data-id="${p.id}">
                        <img src="${imageUrl}" alt="${p.name}" class="product-image">
                        <div class="product-info">
                            <div class="product-name">${p.name}</div>
                            <div class="product-price">${formatCurrency(p.price)}</div>
                            <div class="product-stock ${stockClass}">Stok: ${p.stock}</div>
                        </div>
                    </div>`);
            });
        }
        function loadCategories() {
            const filterRow = $('.filter-row');
            filterRow.find('.filter-chip:not([data-category="all"])').remove();
            categories.forEach(cat => filterRow.append(`<div class="filter-chip" data-category="${cat.name}">${cat.name}</div>`));
        }
        function loadCategoriesForSelect() {
            const select = $('#productCategory').empty().append('<option value="">Pilih Kategori</option>');
            categories.forEach(cat => select.append(`<option value="${cat.name}">${cat.name}</option>`));
        }

        // --- 5. CART & CHECKOUT ---
        function addProductToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (product.stock <= 0) { showToast('Stok menu habis.', 'error'); return; }
            
            const existingItem = currentCart.items.find(item => item.product.id === productId);
            if (existingItem) {
                if (existingItem.quantity + 1 > product.stock) { showToast('Stok tidak mencukupi.', 'error'); return; }
                existingItem.quantity++;
            } else {
                currentCart.items.push({ product: product, quantity: 1 });
            }
            updateCart();
            showToast(`${product.name} ditambahkan.`, 'success');
        }
        function updateCart() {
            currentCart.subtotal = currentCart.items.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            currentCart.total = currentCart.subtotal;

            const cartItemsDiv = $('#cartItems').empty();
            if (currentCart.items.length === 0) {
                cartItemsDiv.html(`<div class="empty-state" style="padding: 4rem 0;"><i class="fas fa-shopping-cart"></i><p>Keranjang kosong</p></div>`);
            } else {
                currentCart.items.forEach(item => {
                    cartItemsDiv.append(`
                        <div class="cart-item">
                            <img src="${item.product.imageUrl || 'https://via.placeholder.com/50'}" alt="${item.product.name}" class="cart-item-img">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.product.name}</div>
                                <div class="cart-item-price">${item.quantity} x ${formatCurrency(item.product.price)}</div>
                            </div>
                            <div class="cart-item-qty">
                                <button class="qty-btn" onclick="window.app.updateItemQuantity('${item.product.id}', -1)"><i class="fas fa-minus"></i></button>
                                <input type="number" class="qty-input" value="${item.quantity}" readonly>
                                <button class="qty-btn" onclick="window.app.updateItemQuantity('${item.product.id}', 1)"><i class="fas fa-plus"></i></button>
                                <div class="remove-btn" onclick="window.app.removeItemFromCart('${item.product.id}')"><i class="fas fa-trash"></i></div>
                            </div>
                        </div>`);
                });
            }
            $('#cartSubtotal').text(formatCurrency(currentCart.subtotal));
            $('#cartTotal').text(formatCurrency(currentCart.total));
            $('#cartCount').text(currentCart.items.reduce((sum, item) => sum + item.quantity, 0));
            saveDataToStorage(STORAGE_KEYS.CART, currentCart);
        }
        window.app = {
            updateItemQuantity: (productId, change) => {
                const item = currentCart.items.find(i => i.product.id === productId);
                if (!item) return;
                let newQty = item.quantity + change;
                if (newQty > item.product.stock) { showToast('Stok tidak mencukupi.', 'error'); return; }
                if (newQty <= 0) { currentCart.items = currentCart.items.filter(i => i.product.id !== productId); } 
                else { item.quantity = newQty; }
                updateCart();
            },
            removeItemFromCart: (productId) => {
                currentCart.items = currentCart.items.filter(i => i.product.id !== productId);
                updateCart();
            },
            deleteCategory: (id) => {
                if (confirm('Yakin ingin menghapus kategori ini? Produk dalam kategori ini tidak akan terhapus.')) {
                    categories = categories.filter(c => c.id !== id);
                    saveDataToStorage(STORAGE_KEYS.CATEGORIES, categories);
                    loadCategories();
                    renderCategoriesInModal();
                    showToast('Kategori dihapus.', 'success');
                }
            },
            deleteUser: (id) => {
                if (id === currentUser.id) { showToast('Anda tidak dapat menghapus akun sendiri.', 'error'); return; }
                if (confirm('Yakin ingin menghapus staf ini?')) {
                    users = users.filter(u => u.id !== id);
                    saveDataToStorage(STORAGE_KEYS.USERS, users);
                    renderCashiers();
                    showToast('Staf berhasil dihapus.', 'success');
                }
            },
            editUser: (id) => {
                const user = users.find(u => u.id === id);
                if (!user) return;
                $('#cashierFormTitle').text('Edit Staf');
                $('#cashierId').val(user.id);
                $('#cashierName').val(user.name);
                $('#cashierUsername').val(user.username);
                $('#cashierRole').val(user.role);
                $('#cashierPassword').attr('placeholder', 'Kosongkan jika tidak ingin mengubah').val('');
                $('#cashierFormModal').css('display', 'flex');
            },
            deleteMember: (id) => {
                if (confirm('Yakin ingin menghapus member ini?')) {
                    members = members.filter(m => m.id !== id);
                    saveDataToStorage(STORAGE_KEYS.MEMBERS, members);
                    renderMembers();
                    showToast('Member berhasil dihapus.', 'success');
                }
            }
        };

        $('#clearCartBtn').click(() => {
            if (currentCart.items.length > 0 && confirm('Anda yakin ingin mengosongkan keranjang?')) {
                resetCart();
                showToast('Keranjang dikosongkan.', 'info');
            }
        });
        $('#checkoutBtn').click(() => {
            if (currentCart.items.length === 0) { showToast('Keranjang kosong.', 'warning'); return; }
            $('#paymentTotal').text(formatCurrency(currentCart.total));
            $('#paymentAmount').val('').focus();
            $('#changeContainer').hide();
            $('#checkoutModal').css('display', 'flex');
        });
        $('#paymentAmount').on('input', function() {
            const paid = parseFloat($(this).val()) || 0;
            const change = paid - currentCart.total;
            $('#changeContainer').toggle(change >= 0).find('#paymentChange').text(formatCurrency(change));
        });
        $('#completePaymentBtn').click(function() {
            const paid = parseFloat($('#paymentAmount').val()) || 0;
            if (paid < currentCart.total) { showToast('Jumlah pembayaran kurang.', 'error'); return; }
            
            lastTransaction = {
                id: 'TRX' + Date.now(),
                date: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(currentCart.items)),
                subtotal: currentCart.subtotal,
                total: currentCart.total,
                paymentMethod: $('#paymentMethod').val(),
                amountPaid: paid,
                change: paid - currentCart.total,
                cashier: { id: currentUser.id, name: currentUser.name }
            };

            transactions.unshift(lastTransaction);
            saveDataToStorage(STORAGE_KEYS.TRANSACTIONS, transactions);
            
            lastTransaction.items.forEach(item => {
                const product = products.find(p => p.id === item.product.id);
                if (product) product.stock -= item.quantity;
            });
            saveDataToStorage(STORAGE_KEYS.PRODUCTS, products);

            $('#checkoutModal').hide();
            showToast('Transaksi berhasil!', 'success');
            
            showReceiptModal(lastTransaction);
            resetCart();
            loadProducts();
        });
        function resetCart() {
            currentCart = { items: [], subtotal: 0, total: 0 };
            updateCart();
        }

        // --- 6. ADMIN FEATURES & MODALS ---
        // Generic modal closer
        $('.modal-close, .modal-close-btn').click(function() { $(this).closest('.modal').hide(); });

        // Product Modal
        $('#addProductBtn').click(() => {
            $('#productModal .modal-title').text('Tambah Menu Baru');
            $('#productForm')[0].reset();
            $('#productId').val('');
            loadCategoriesForSelect();
            $('#productModal').css('display', 'flex');
        });
        $('#saveProductBtn').click(function() {
            const newProductData = {
                name: $('#productName').val().trim(),
                imageUrl: $('#productImageUrl').val().trim(),
                category: $('#productCategory').val(),
                price: parseFloat($('#productPrice').val()) || 0,
                stock: parseInt($('#productStock').val()) || 0,
            };
            if (!newProductData.name || !newProductData.category || newProductData.price <= 0) { showToast('Nama, kategori, dan harga harus diisi.', 'error'); return; }
            
            const id = $('#productId').val();
            if (id) {
                const index = products.findIndex(p => p.id === id);
                if (index > -1) products[index] = { ...products[index], ...newProductData };
            } else {
                newProductData.id = 'P' + Date.now();
                products.unshift(newProductData);
            }
            saveDataToStorage(STORAGE_KEYS.PRODUCTS, products);
            loadProducts();
            $('#productModal').hide();
            showToast('Menu berhasil disimpan.', 'success');
        });

        // Category Modal
        function renderCategoriesInModal() {
            const list = $('#categoriesList').empty();
            categories.forEach(cat => list.append(`<tr><td>${cat.name}</td><td><button class="btn btn-sm btn-danger" onclick="window.app.deleteCategory('${cat.id}')"><i class="fas fa-trash"></i></button></td></tr>`));
        }
        $('#manageCategoriesBtn').click(() => {
            renderCategoriesInModal();
            $('#manageCategoriesModal').css('display', 'flex');
        });
        $('#addCategoryBtn').click(function() {
            const name = $('#newCategoryName').val().trim();
            if (!name || categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('Nama kategori tidak valid atau sudah ada.', 'error'); return; }
            categories.push({ id: 'C' + Date.now(), name: name });
            saveDataToStorage(STORAGE_KEYS.CATEGORIES, categories);
            loadCategories();
            renderCategoriesInModal(); // Refresh modal
            $('#newCategoryName').val('');
            showToast('Kategori berhasil ditambah.', 'success');
        });

        // Dashboard Modal
        $('#dashboardBtn').click(() => {
            renderDashboard();
            $('#dashboardModal').css('display', 'flex');
        });
        function renderDashboard() {
            const todayStart = moment().startOf('day');
            const todayTransactions = transactions.filter(t => moment(t.date).isAfter(todayStart));
            const dailyRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            $('#dailyRevenue').text(formatCurrency(dailyRevenue));
            $('#dailyTransactions').text(todayTransactions.length);

            const productSales = {};
            transactions.forEach(trx => trx.items.forEach(item => { productSales[item.product.name] = (productSales[item.product.name] || 0) + item.quantity; }));
            const topProduct = Object.keys(productSales).length > 0 ? Object.entries(productSales).sort((a, b) => b[1] - a[1])[0][0] : '-';
            $('#topProduct').text(topProduct);

            const salesData = Array(7).fill(0);
            const labels = Array.from({length: 7}, (_, i) => moment().subtract(6 - i, 'days').format('ddd'));
            transactions.forEach(t => {
                const dayIndex = moment().diff(moment(t.date), 'days');
                if (dayIndex >= 0 && dayIndex < 7) { salesData[6-dayIndex] += t.total; }
            });
            
            if (salesChartInstance) salesChartInstance.destroy();
            salesChartInstance = new Chart($('#salesChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Pendapatan', data: salesData, backgroundColor: 'rgba(138, 90, 68, 0.2)', borderColor: '#8a5a44', borderWidth: 2, tension: 0.4, fill: true }] },
                options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }
        
        // Reports Modal
        $('#viewReportsBtn').click(() => {
            $('#reportStartDate, #reportEndDate').val(moment().format('YYYY-MM-DD'));
            $('#reportSummary, #reportTableBody').empty();
            $('#reportsModal').css('display', 'flex');
        });
        $('#generateReportBtn').click(function() {
            const start = moment($('#reportStartDate').val()).startOf('day');
            const end = moment($('#reportEndDate').val()).endOf('day');
            const filtered = transactions.filter(t => moment(t.date).isBetween(start, end));
            
            let totalSales = filtered.reduce((sum, t) => sum + t.total, 0);
            $('#reportTableBody').empty().append(filtered.map(t => `<tr><td>${t.id}</td><td>${moment(t.date).format('lll')}</td><td>${t.cashier.name}</td><td>${formatCurrency(t.total)}</td></tr>`).join(''));
            $('#reportSummary').html(`<div class="summary-container"><div class="summary-row total-row"><span>Total Penjualan:</span><span>${formatCurrency(totalSales)}</span></div></div>`);
        });
        $('#printReportBtn').click(function() {
            if ($('#reportTableBody tr').length === 0) { showToast('Generate laporan terlebih dahulu.', 'warning'); return; }
            const doc = new jsPDF();
            doc.text(`Laporan Penjualan - ${settings.storeName}`, 14, 16);
            doc.text(`Periode: ${$('#reportStartDate').val()} s/d ${$('#reportEndDate').val()}`, 14, 22);
            doc.autoTable({ startY: 28, html: '#reportsModal .data-table', theme: 'grid' });
            doc.save(`Laporan_Penjualan_${$('#reportStartDate').val()}_${$('#reportEndDate').val()}.pdf`);
        });

        // Store Info Modal
        $('#manageStoreInfoBtn').click(function() {
            $('#storeName').val(settings.storeName);
            $('#storeAddress').val(settings.storeAddress);
            $('#storePhone').val(settings.storePhone);
            $('#manageStoreInfoModal').css('display', 'flex');
        });
        $('#saveStoreInfoBtn').click(function() {
            settings.storeName = $('#storeName').val().trim();
            settings.storeAddress = $('#storeAddress').val().trim();
            settings.storePhone = $('#storePhone').val().trim();
            saveDataToStorage(STORAGE_KEYS.SETTINGS, settings);
            updateStoreInfo();
            showToast('Informasi restoran berhasil diperbarui.', 'success');
            $('#manageStoreInfoModal').hide();
        });

        // Cashier/Staff Management
        function renderCashiers() {
            const list = $('#cashiersList').empty();
            users.forEach(u => {
                list.append(`<tr>
                    <td>${u.name}</td><td>${u.username}</td><td>${u.role}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-info" onclick="window.app.editUser('${u.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="window.app.deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>
                    </td></tr>`);
            });
        }
        $('#manageCashiersBtn').click(function() {
            renderCashiers();
            $('#manageCashiersModal').css('display', 'flex');
        });
        $('#addNewCashierBtn').click(function() {
            $('#cashierFormTitle').text('Tambah Staf Baru');
            $('#cashierForm')[0].reset();
            $('#cashierId').val('');
            $('#cashierPassword').attr('placeholder', 'Wajib diisi untuk staf baru').prop('required', true);
            $('#cashierFormModal').css('display', 'flex');
        });
        $('#saveCashierBtn').click(function() {
            const id = $('#cashierId').val();
            const username = $('#cashierUsername').val().trim().toLowerCase();
            const password = $('#cashierPassword').val().trim();

            if (users.some(u => u.username === username && u.id !== id)) { showToast('Username sudah digunakan.', 'error'); return; }
            if (!id && password.length < 5) { showToast('Password minimal 5 karakter.', 'error'); return; }
            if (id && password && password.length < 5) { showToast('Password baru minimal 5 karakter.', 'error'); return; }

            const userData = {
                id: id || 'U' + Date.now(),
                name: $('#cashierName').val().trim(),
                username: username,
                role: $('#cashierRole').val()
            };

            if (id) {
                const index = users.findIndex(u => u.id === id);
                userData.password = password ? CryptoJS.SHA256(password).toString() : users[index].password;
                users[index] = userData;
            } else {
                userData.password = CryptoJS.SHA256(password).toString();
                users.push(userData);
            }
            saveDataToStorage(STORAGE_KEYS.USERS, users);
            renderCashiers();
            $('#cashierFormModal').hide();
            showToast('Data staf berhasil disimpan.', 'success');
        });

        // Member Management
        function renderMembers() {
            const list = $('#membersList').empty();
            members.forEach(m => {
                list.append(`<tr><td>${m.id}</td><td>${m.name}</td><td>${m.phone}</td>
                <td><button class="btn btn-sm btn-danger" onclick="window.app.deleteMember('${m.id}')"><i class="fas fa-trash"></i></button></td></tr>`);
            });
        }
        $('#manageMembersBtn').click(function() {
            renderMembers();
            $('#manageMembersModal').css('display', 'flex');
        });
        $('#addNewMemberBtn').click(function() {
            $('#memberForm')[0].reset();
            $('#memberFormModal').css('display', 'flex');
        });
        $('#saveMemberBtn').click(function() {
            const memberData = {
                id: 'M' + Date.now(),
                name: $('#memberName').val().trim(),
                phone: $('#memberPhone').val().trim()
            };
            if (!memberData.name) { showToast('Nama member harus diisi.', 'error'); return; }
            members.unshift(memberData);
            saveDataToStorage(STORAGE_KEYS.MEMBERS, members);
            renderMembers();
            $('#memberFormModal').hide();
            showToast('Member baru berhasil ditambahkan.', 'success');
        });
        
        // Receipt Feature
        function showReceiptModal(trx) {
            let itemsHtml = '';
            trx.items.forEach(item => {
                const totalItemPrice = formatCurrency(item.product.price * item.quantity, '');
                itemsHtml += `
                    <tr>
                        <td colspan="3">${item.product.name}</td>
                    </tr>
                    <tr>
                        <td>${item.quantity}x</td>
                        <td style="text-align:right;">${formatCurrency(item.product.price, '')}</td>
                        <td style="text-align:right;">${totalItemPrice}</td>
                    </tr>`;
            });

            const receiptHtml = `
                <h4>${settings.storeName || 'Kafe Anda'}</h4>
                <p>${settings.storeAddress || ''}</p>
                <p>${settings.storePhone || ''}</p>
                <div class="divider"></div>
                <p>ID: ${trx.id}</p>
                <p>${moment(trx.date).format('DD/MM/YYYY HH:mm')}</p>
                <p>Kasir: ${trx.cashier.name}</p>
                <div class="divider"></div>
                <table>${itemsHtml}</table>
                <div class="divider"></div>
                <table>
                    <tr><td>Subtotal</td><td style="text-align:right;">${formatCurrency(trx.subtotal)}</td></tr>
                    <tr><td><b>Total</b></td><td style="text-align:right;"><b>${formatCurrency(trx.total)}</b></td></tr>
                    <tr><td>Tunai</td><td style="text-align:right;">${formatCurrency(trx.amountPaid)}</td></tr>
                    <tr><td>Kembali</td><td style="text-align:right;">${formatCurrency(trx.change)}</td></tr>
                </table>
                <div class="divider"></div>
                <p>Terima Kasih!</p>
            `;
            $('#receiptContent').html(receiptHtml);
            $('#receiptModal').css('display', 'flex');
        }

        function generatePdfReceipt(trx) {
            const doc = new jsPDF({ unit: 'pt', format: [226, 400] }); // 80mm thermal printer width
            doc.setFontSize(10);
            doc.text(settings.storeName || 'Kafe Anda', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            doc.setFontSize(8);
            doc.text(settings.storeAddress || '', doc.internal.pageSize.getWidth() / 2, 32, { align: 'center' });
            doc.text(settings.storePhone || '', doc.internal.pageSize.getWidth() / 2, 44, { align: 'center' });
            
            let tableItems = trx.items.map(item => [
                `${item.product.name}\n${item.quantity} x ${formatCurrency(item.product.price, '')}`, 
                formatCurrency(item.product.price * item.quantity, '')
            ]);
            
            doc.autoTable({
                head: [['ID: ' + trx.id, 'Kasir: ' + trx.cashier.name]],
                body: [[moment(trx.date).format('DD/MM/YY HH:mm'), '']],
                startY: 50,
                theme: 'plain',
                styles: { fontSize: 8, cellPadding: 2 }
            });

            doc.autoTable({
                head: [['Item', 'Total']],
                body: tableItems,
                startY: doc.autoTable.previous.finalY,
                theme: 'plain',
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fontStyle: 'bold' },
                columnStyles: { 1: { halign: 'right' } }
            });

            const summaryY = doc.autoTable.previous.finalY + 10;
            doc.autoTable({
                body: [
                    ['Subtotal', formatCurrency(trx.subtotal, 'Rp')],
                    ['Total', formatCurrency(trx.total, 'Rp')],
                    ['Tunai', formatCurrency(trx.amountPaid, 'Rp')],
                    ['Kembali', formatCurrency(trx.change, 'Rp')],
                ],
                startY: summaryY,
                theme: 'plain',
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: { 0: { fontStyle: 'bold' }, 1: { halign: 'right' } },
            });
            doc.text('Terima Kasih!', doc.internal.pageSize.getWidth() / 2, doc.autoTable.previous.finalY + 20, { align: 'center' });
            return doc;
        }

        $('#downloadReceiptBtn').on('click', function(){
            const doc = generatePdfReceipt(lastTransaction);
            const fileName = `Struk-${lastTransaction.id}-${moment(lastTransaction.date).format('YYYY-MM-DD')}.pdf`;
            doc.save(fileName);
        });

        $('#printReceiptBtn').on('click', function(){
            const doc = generatePdfReceipt(lastTransaction);
            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
        });

        // Data Management
        $('#backupDataBtn').click(() => {
            const allData = {};
            Object.values(STORAGE_KEYS).forEach(key => { allData[key] = localStorage.getItem(key); });
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(allData), BACKUP_ENCRYPTION_KEY).toString();
            const blob = new Blob([encrypted], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_${moment().format('YYYYMMDD')}.json`;
            a.click();
            showToast('Backup data berhasil dibuat.', 'success');
        });
        $('#restoreDataBtn').click(() => $('#restoreDataModal').css('display', 'flex'));
        $('#confirmRestoreBtn').click(function() {
            const file = $('#restoreFileInput')[0].files[0];
            if (!file) { showToast('Pilih file backup.', 'error'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const decrypted = CryptoJS.AES.decrypt(e.target.result, BACKUP_ENCRYPTION_KEY).toString(CryptoJS.enc.Utf8);
                    const restoredData = JSON.parse(decrypted);
                    Object.keys(restoredData).forEach(key => {
                        if (restoredData[key] !== null) { localStorage.setItem(key, restoredData[key]); }
                    });
                    showToast('Restore berhasil! Aplikasi akan dimuat ulang.', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } catch (err) {
                    showToast('Gagal restore data. File rusak atau kunci salah.', 'error');
                }
            };
            reader.readAsText(file);
        });

        // --- 7. APP START ---
        initializeData();
        loadDataFromStorage();
        applyInitialTheme();
        if (currentUser) {
            initializeAppView();
            $('#mainApp').show();
        } else {
            $('#loginPage').show();
        }
    });
    </script>
</body>
</html>
